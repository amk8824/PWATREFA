// متغيرات عامة
let currentTab = 'certificates';
let announcementTimer;

// إظهار إعلان التحديث عند فتح البرنامج
function showUpdateAnnouncement() {
  const announcement = document.getElementById('updateAnnouncement');
  if (announcement) {
    announcement.style.display = 'flex';
    startAnnouncementTimer();
  }
}

// إغلاق الإعلان
function closeAnnouncement() {
  const announcement = document.getElementById('updateAnnouncement');
  if (announcement) {
    announcement.style.display = 'none';
    if (announcementTimer) {
      clearInterval(announcementTimer);
    }
  }
}

// عداد تنازلي لإغلاق الإعلان
function startAnnouncementTimer() {
  let timeLeft = 60; // 60 ثانية = دقيقة واحدة
  const timerElement = document.getElementById('timerCount');
  
  announcementTimer = setInterval(() => {
    timeLeft--;
    if (timerElement) {
      timerElement.textContent = timeLeft;
    }
    
    if (timeLeft <= 0) {
      closeAnnouncement();
    }
  }, 1000);
}

// إدارة شاشة القفل
if (!localStorage.getItem('lockCode')) {
  localStorage.setItem('lockCode', '1234');
}

// دالة فحص كلمة المرور
async function checkPassword() {
    const password = document.getElementById('passwordInput').value;
    
    if (!password) {
        showAlert('يرجى إدخال كلمة المرور', 'error');
        return;
    }
    
    try {
        const response = await fetch('/check_password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ password: password })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // إخفاء شاشة القفل وإظهار المحتوى الرئيسي
            document.getElementById('lockScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.body.style.overflow = 'auto';
            updateCertificatesStats();
            // إظهار إعلان التحديث
            setTimeout(() => {
                showUpdateAnnouncement();
            }, 500);
        } else {
            showAlert(data.message || 'كلمة المرور غير صحيحة', 'error');
            // إضافة تأثير اهتزاز للحقل
            const input = document.getElementById('passwordInput');
            input.classList.add('shake');
            setTimeout(() => input.classList.remove('shake'), 600);
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('حدث خطأ في الاتصال', 'error');
    }
}

function toggleChangePassword() {
  const form = document.getElementById('changePasswordForm');
  form.style.display = form.style.display === 'none' ? 'flex' : 'none';
}

async function changePassword() {
    const oldPassword = document.getElementById('oldPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (!oldPassword || !newPassword || !confirmPassword) {
        showAlert('يرجى ملء جميع الحقول', 'error');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showAlert('كلمة المرور الجديدة غير متطابقة', 'error');
        return;
    }
    
    if (newPassword.length < 4) {
        showAlert('كلمة المرور يجب أن تكون 4 أحرف على الأقل', 'error');
        return;
    }
    
    try {
        const response = await fetch('/change_password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                old_password: oldPassword,
                new_password: newPassword,
                confirm_password: confirmPassword
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message || 'تم تغيير كلمة المرور بنجاح', 'success');
            toggleChangePassword();
        } else {
            showAlert(data.message || 'فشل في تغيير كلمة المرور', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('حدث خطأ في الاتصال', 'error');
    }
}

// دالة إظهار الرسائل
function showAlert(message, type = 'info') {
    // إنشاء عنصر الإشعار
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
        <span>${message}</span>
    `;
    
    // إضافة الأنماط
    alert.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-family: 'Cairo', sans-serif;
        font-weight: 600;
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideInRight 0.3s ease;
        background: ${type === 'success' ? 'linear-gradient(45deg, #28a745, #34ce57)' : 
                    type === 'error' ? 'linear-gradient(45deg, #dc3545, #e55d6c)' : 
                    'linear-gradient(45deg, #007bff, #4dabf7)'};
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    `;
    
    // إضافة الإشعار للصفحة
    document.body.appendChild(alert);
    
    // إزالة الإشعار بعد 3 ثوان
    setTimeout(() => {
        alert.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
            if (document.body.contains(alert)) {
                document.body.removeChild(alert);
            }
        }, 300);
    }, 3000);
}

// دالة تنبيه نفاد الكمية مع لون أحمر مميز
function showQuantityWarning(message) {
    // إنشاء عنصر التنبيه الخاص
    const warning = document.createElement('div');
    warning.className = 'quantity-warning';
    warning.innerHTML = `
        <i class="fas fa-exclamation-triangle"></i>
        <span>${message}</span>
        <i class="fas fa-exclamation-triangle"></i>
    `;
    
    // إضافة الأنماط الخاصة للتنبيه الأحمر
    warning.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px 30px;
        border-radius: 15px;
        color: white;
        font-family: 'Cairo', sans-serif;
        font-weight: 700;
        font-size: 18px;
        z-index: 20000;
        display: flex;
        align-items: center;
        gap: 15px;
        background: linear-gradient(45deg, #ff0000, #cc0000);
        border: 3px solid #ffcccc;
        box-shadow: 0 10px 30px rgba(255, 0, 0, 0.5);
        animation: warningPulse 2s ease-in-out infinite;
        text-align: center;
        min-width: 300px;
        max-width: 80vw;
    `;
    
    // إضافة التنبيه للصفحة
    document.body.appendChild(warning);
    
    // إزالة التنبيه بعد 5 ثوان
    setTimeout(() => {
        warning.style.animation = 'warningFadeOut 0.5s ease';
        setTimeout(() => {
            if (document.body.contains(warning)) {
                document.body.removeChild(warning);
            }
        }, 500);
    }, 5000);
}

// دالة تشغيل صوت التنبيه
function playWarningSound() {
    try {
        // إنشاء صوت تنبيه باستخدام Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // تعيين نوع الموجة والتردد
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime); // تردد عالي
        
        // تعيين مستوى الصوت
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        // تشغيل الصوت لمدة نصف ثانية
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
        
        // تكرار الصوت 3 مرات
        setTimeout(() => {
            if (audioContext.state !== 'closed') {
                const oscillator2 = audioContext.createOscillator();
                const gainNode2 = audioContext.createGain();
                oscillator2.connect(gainNode2);
                gainNode2.connect(audioContext.destination);
                oscillator2.type = 'sine';
                oscillator2.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode2.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator2.start();
                oscillator2.stop(audioContext.currentTime + 0.5);
            }
        }, 600);
        
        setTimeout(() => {
            if (audioContext.state !== 'closed') {
                const oscillator3 = audioContext.createOscillator();
                const gainNode3 = audioContext.createGain();
                oscillator3.connect(gainNode3);
                gainNode3.connect(audioContext.destination);
                oscillator3.type = 'sine';
                oscillator3.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode3.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode3.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator3.start();
                oscillator3.stop(audioContext.currentTime + 0.5);
            }
        }, 1200);
        
    } catch (error) {
        console.log('لا يمكن تشغيل الصوت:', error);
        // بديل بسيط في حالة عدم دعم Web Audio API
        console.log('🔊 تنبيه صوتي: الكمية نفذت!');
    }
}

// إدارة التبويبات
function showTab(tabName) {
  const tabs = document.querySelectorAll('.tab-content');
  const buttons = document.querySelectorAll('.tab-button');
  
  tabs.forEach(tab => tab.classList.remove('active'));
  buttons.forEach(button => button.classList.remove('active'));
  
  document.getElementById(tabName).classList.add('active');
  event.target.classList.add('active');
  
  currentTab = tabName;
}

// وظائف الشهادات
function updateRemaining() {
  const total = parseFloat(document.getElementById('totalQuantity').value) || 0;
  const deducted = parseFloat(document.getElementById('deductedQuantity').value) || 0;
  const remaining = total - deducted;
  document.getElementById('remainingQuantity').value = remaining;

  // تنبيه نفاد الكمية مع صوت
  if (remaining <= 0 && total > 0) {
    playWarningSound();
    showQuantityWarning("⚠️ تحذير: الكمية الخاصة بهذه الشهادة قد نفذت تماماً!");
  } else if (remaining <= (total * 0.1) && total > 0 && remaining > 0) {
    playWarningSound();
    showQuantityWarning("⚠️ تنبيه: الكمية المتبقية قليلة جداً - أقل من 10%");
  }
}

// دالة حساب الكمية المتبقية للنموذج المحمول
function updateRemainingMobile() {
  const total = parseFloat(document.getElementById('totalQuantity-mobile').value) || 0;
  const deducted = parseFloat(document.getElementById('deductedQuantity-mobile').value) || 0;
  const remaining = total - deducted;
  document.getElementById('remainingQuantity-mobile').value = remaining;

  // تنبيه نفاد الكمية مع صوت
  if (remaining <= 0 && total > 0) {
    playWarningSound();
    showQuantityWarning("⚠️ تحذير: الكمية الخاصة بهذه الشهادة قد نفذت تماماً!");
  } else if (remaining <= (total * 0.1) && total > 0 && remaining > 0) {
    playWarningSound();
    showQuantityWarning("⚠️ تنبيه: الكمية المتبقية قليلة جداً - أقل من 10%");
  }
}

// دالة التحقق من الشهادة النافذة
async function checkCertificateStatus(certificateNumber) {
  if (!certificateNumber) return;
  
  try {
    const response = await fetch('/api/certificates');
    const result = await response.json();
    
    if (result.success) {
      const existingCerts = result.certificates.filter(cert => 
        cert.certificateNumber === certificateNumber
      );
      
      if (existingCerts.length > 0) {
        const totalRemaining = existingCerts.reduce((sum, cert) => 
          sum + (parseFloat(cert.remainingQuantity) || 0), 0
        );
        
        if (totalRemaining <= 0) {
          playWarningSound();
          showAlert('🚨 تحذير: هذه الشهادة نافذة تماماً - لا يوجد كمية متبقية!', 'error');
          return false;
        } else if (totalRemaining <= 50) {
          playWarningSound();
          showAlert(`⚠️ تنبيه: الكمية المتبقية لهذه الشهادة قليلة: ${totalRemaining}`, 'warning');
        }
      }
    }
  } catch (error) {
    console.error('خطأ في التحقق من حالة الشهادة:', error);
  }
  return true;
}

async function saveCertificate() {
  // تحديد ما إذا كنا نستخدم النموذج المحمول أم الجدول
  let cert;
  
  // فحص إذا كانت حقول الموبايل مرئية ولها قيم
  const mobileForm = document.querySelector('.mobile-form');
  const isMobile = window.innerWidth <= 768 || (mobileForm && getComputedStyle(mobileForm).display !== 'none');
  
  if (isMobile) {
    // استخدام بيانات النموذج المحمول
    cert = {
      company: document.getElementById('company-mobile').value.trim(),
      borderSerial: document.getElementById('borderSerial-mobile').value.trim(),
      certificateNumber: document.getElementById('certificateNumber-mobile').value.trim(),
      certificateDate: document.getElementById('certificateDate-mobile').value,
      totalQuantity: parseFloat(document.getElementById('totalQuantity-mobile').value) || 0,
      deductedQuantity: parseFloat(document.getElementById('deductedQuantity-mobile').value) || 0,
      unit: document.getElementById('unit-mobile').value,
      itemType: document.getElementById('itemType-mobile').value.trim()
    };
  } else {
    // استخدام بيانات الجدول
    cert = {
      company: document.getElementById('company').value.trim(),
      borderSerial: document.getElementById('borderSerial').value.trim(),
      certificateNumber: document.getElementById('certificateNumber').value.trim(),
      certificateDate: document.getElementById('certificateDate').value,
      totalQuantity: parseFloat(document.getElementById('totalQuantity').value) || 0,
      deductedQuantity: parseFloat(document.getElementById('deductedQuantity').value) || 0,
      unit: document.getElementById('unit').value,
      itemType: document.getElementById('itemType').value.trim()
    };
  }

  if (!cert.company || !cert.certificateNumber || !cert.totalQuantity) {
    alert("⚠️ يرجى إدخال كافة الحقول المطلوبة.");
    return;
  }

  // حفظ في قاعدة البيانات بدلاً من localStorage
  try {
    const response = await fetch('/api/certificates', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        company: cert.company,
        border_serial: cert.borderSerial,
        certificate_number: cert.certificateNumber,
        certificate_date: cert.certificateDate,
        total_quantity: cert.totalQuantity,
        deducted_quantity: cert.deductedQuantity,
        remaining_quantity: cert.totalQuantity - cert.deductedQuantity,
        unit: cert.unit,
        item_type: cert.itemType
      })
    });

    const result = await response.json();
    
    if (result.success) {
      showAlert('✅ تم حفظ الشهادة بنجاح في قاعدة البيانات', 'success');
      
      // مسح النموذج
      if (isMobile) {
        document.getElementById('company-mobile').value = '';
        document.getElementById('borderSerial-mobile').value = '';
        document.getElementById('certificateNumber-mobile').value = '';
        document.getElementById('certificateDate-mobile').value = '';
        document.getElementById('totalQuantity-mobile').value = '';
        document.getElementById('deductedQuantity-mobile').value = '';
        document.getElementById('remainingQuantity-mobile').value = '';
        document.getElementById('unit-mobile').value = 'طن';
        document.getElementById('itemType-mobile').value = '';
      } else {
        document.getElementById('company').value = '';
        document.getElementById('borderSerial').value = '';
        document.getElementById('certificateNumber').value = '';
        document.getElementById('certificateDate').value = '';
        document.getElementById('totalQuantity').value = '';
        document.getElementById('deductedQuantity').value = '';
        document.getElementById('remainingQuantity').value = '';
        document.getElementById('unit').value = 'طن';
        document.getElementById('itemType').value = '';
      }
      
      // تحديث الإحصائيات
      updateCertificatesStats();
      
    } else {
      showAlert(`❌ خطأ في حفظ الشهادة: ${result.message}`, 'error');
    }
  } catch (error) {
    console.error('Error saving certificate:', error);
    showAlert('❌ خطأ في الاتصال بقاعدة البيانات', 'error');
  }

  // التحقق من حالة الشهادة
  const canProceed = await checkCertificateStatus(cert.certificateNumber);
  if (!canProceed) {
    const confirmProceed = confirm('هل تريد المتابعة مع العلم أن هذه الشهادة نافذة؟');
    if (!confirmProceed) return;
  }

  try {
    const response = await fetch('/api/certificates', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(cert)
    });

    const result = await response.json();

    if (result.success) {
      alert("✅ تم حفظ الشهادة بنجاح.");
      await renderCertificates();
      await updateStats();
      
      // مسح النموذج المناسب
      if (isMobile) {
        document.querySelectorAll('.mobile-field input, .mobile-field select').forEach(field => {
          if (!field.readOnly) field.value = '';
        });
      } else {
        document.getElementById('dataForm').reset();
      }
    } else {
      alert(`❌ خطأ: ${result.message}`);
    }
  } catch (error) {
    console.error('Error saving certificate:', error);
    alert('❌ خطأ في الاتصال بالخادم');
  }
}

async function renderCertificates() {
  const list = document.getElementById('certificatesList');
  list.innerHTML = '<tr><td colspan="11" style="text-align: center;">🔄 جاري تحميل البيانات...</td></tr>';
  
  try {
    const response = await fetch('/api/certificates');
    const result = await response.json();
    
    if (!result.success) {
      list.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #dc3545;">❌ خطأ في تحميل البيانات</td></tr>';
      return;
    }

    const certificates = result.certificates;
    list.innerHTML = '';
    
    if (certificates.length === 0) {
      list.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #666;">لا توجد شهادات محفوظة</td></tr>';
      return;
    }

    certificates.forEach((cert) => {
      const row = document.createElement('tr');
      const remaining = parseFloat(cert.remainingQuantity) || 0;
      const isExpired = remaining <= 0;
      
      // إضافة كلاس CSS للشهادات المنفذة
      if (isExpired) {
        row.classList.add('expired-row');
        row.style.backgroundColor = '#ffebee';
        row.style.color = '#c62828';
        row.style.fontWeight = 'bold';
      }
      
      row.innerHTML = `
        <td data-label="اسم الشركة">${cert.company}${isExpired ? ' <span style="background: #f44336; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">نافذة</span>' : ''}</td>
        <td data-label="رقم الشهادة">${cert.certificateNumber}</td>
        <td data-label="التسلسل الحدودي">${cert.borderSerial}</td>
        <td data-label="التاريخ">${cert.certificateDate}</td>
        <td data-label="نوع البضاعة">${cert.itemType}</td>
        <td data-label="الكمية الكلية">${cert.totalQuantity}</td>
        <td data-label="المستقطعة">${cert.deductedQuantity}</td>
        <td data-label="المتبقية" style="${isExpired ? 'color: #f44336; font-weight: bold;' : ''}">${cert.remainingQuantity}</td>
        <td data-label="الوحدة">${cert.unit}</td>
        <td data-label="تاريخ الحفظ">${cert.savedAt}</td>
        <td data-label="العمليات">
          <div class="action-buttons">
            <button onclick="editCertificate(${cert.id})" class="edit-btn" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-left: 5px;">✏️ تعديل</button>
            <button onclick="deleteCertificate(${cert.id})" class="delete-btn" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">🗑️ حذف</button>
          </div>
        </td>
      `;
      list.appendChild(row);
    });
  } catch (error) {
    console.error('Error loading certificates:', error);
    list.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #dc3545;">❌ خطأ في الاتصال بالخادم</td></tr>';
  }
}

function openModal() {
  document.getElementById('certificatesModal').style.display = 'block';
  renderCertificates();
}

function closeModal() {
  document.getElementById('certificatesModal').style.display = 'none';
}

// وظائف البحث
async function searchCertificates() {
  const searchType = document.getElementById('searchType').value; // exemption أو certificate
  const searchOption = document.getElementById('searchOption').value;
  const searchTerm = document.getElementById('searchInput').value.trim();
  
  if (!searchTerm) {
    alert("⚠️ يرجى إدخال نص للبحث");
    return;
  }

  let searchResults = [];
  
  if (searchType === 'exemption') {
    // البحث في الإعفاءات من قاعدة البيانات
    try {
      const response = await fetch(`/api/mobile/search/exemptions?q=${encodeURIComponent(searchTerm)}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        }
      });

      const result = await response.json();
      if (result.success) {
        searchResults = [...searchResults, ...result.results.map(item => ({...item, type: 'exemption'}))];
      }
    } catch (error) {
      console.error('Error searching exemptions:', error);
    }
    
    // البحث في الاعفاءات المحفوظة محلياً
    const localExemptions = JSON.parse(localStorage.getItem('certificates') || '[]');
    const localResults = localExemptions.filter(item => {
      const value = item[searchOption]?.toString().toLowerCase() || '';
      return value.includes(searchTerm.toLowerCase());
    });
    searchResults = [...searchResults, ...localResults.map(item => ({...item, type: 'exemption'}))];
    
  } else if (searchType === 'certificate') {
    // البحث في الشهادات من قاعدة البيانات
    try {
      const certResponse = await fetch(`/api/mobile/search/certificates?q=${encodeURIComponent(searchTerm)}`);
      const certResult = await certResponse.json();
      
      if (certResult.success && certResult.results) {
        searchResults = [...searchResults, ...certResult.results.map(item => ({...item, type: 'certificate'}))];
      }
    } catch (error) {
      console.error('Error searching certificates from database:', error);
    }
  }

  displaySearchResults(searchResults);
}

async function filterByDate() {
  const dateFrom = document.getElementById('dateFrom').value;
  const dateTo = document.getElementById('dateTo').value;
  
  if (!dateFrom || !dateTo) {
    alert("⚠️ يرجى إدخال التاريخين");
    return;
  }

  try {
    const response = await fetch('/api/certificates/search', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        dateFrom: dateFrom,
        dateTo: dateTo
      })
    });

    const result = await response.json();
    if (result.success) {
      displaySearchResults(result.certificates);
    } else {
      alert(`❌ خطأ في التصفية: ${result.message}`);
    }
  } catch (error) {
    console.error('Error filtering by date:', error);
    alert('❌ خطأ في الاتصال بالخادم');
  }
}

function clearDateFilter() {
  document.getElementById('dateFrom').value = '';
  document.getElementById('dateTo').value = '';
}

function displaySearchResults(results) {
  const resultsList = document.getElementById('searchResultsList');
  resultsList.innerHTML = '';
  
  if (results.length === 0) {
    resultsList.innerHTML = '<tr><td colspan="11">لا توجد نتائج</td></tr>';
  } else {
    results.forEach(cert => {
      const row = document.createElement('tr');
      const remaining = parseFloat(cert.remainingQuantity) || 0;
      const isExpired = remaining <= 0;
      const isExemption = cert.type === 'exemption';
      
      // إضافة تلوين للشهادات المنفذة في نتائج البحث
      if (isExpired) {
        row.style.backgroundColor = '#ffebee';
        row.style.color = '#c62828';
        row.style.fontWeight = 'bold';
      }
      
      // تلوين مختلف لكل نوع
      if (isExemption) {
        row.style.borderLeft = '4px solid #4caf50';
      } else {
        row.style.borderLeft = '4px solid #2196f3';
      }
      
      const typeLabel = isExemption ? 'إعفاء' : 'شهادة';
      const typeIcon = isExemption ? '🏛️' : '📋';
      
      row.innerHTML = `
        <td data-label="النوع">${typeIcon} ${typeLabel}</td>
        <td data-label="اسم الشركة">${cert.company}${isExpired ? ' <span style="background: #f44336; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">نافذة</span>' : ''}</td>
        <td data-label="رقم الوثيقة">${cert.certificateNumber}</td>
        <td data-label="التسلسل الحدودي">${cert.borderSerial}</td>
        <td data-label="التاريخ">${cert.certificateDate}</td>
        <td data-label="نوع البضاعة">${cert.itemType}</td>
        <td data-label="الكمية الكلية">${cert.totalQuantity}</td>
        <td data-label="المستقطعة">${cert.deductedQuantity}</td>
        <td data-label="المتبقية" style="${isExpired ? 'color: #f44336; font-weight: bold;' : ''}">${cert.remainingQuantity}</td>
        <td data-label="الوحدة">${cert.unit}</td>
        <td data-label="تاريخ الحفظ">${cert.savedAt}</td>
      `;
      resultsList.appendChild(row);
    });
    
    // إضافة تنبيه الكمية المتبقية بعد الجدول
    if (results.length > 0) {
      // العثور على آخر سجل تم حفظه (أحدث تاريخ في savedAt)
      const latestRecord = results.reduce((latest, current) => {
        const latestDate = new Date(latest.savedAt || latest.updatedAt || 0);
        const currentDate = new Date(current.savedAt || current.updatedAt || 0);
        return currentDate > latestDate ? current : latest;
      });
      
      const lastRemaining = latestRecord.remainingQuantity;
      const lastUnit = latestRecord.unit;
      const lastSavedDate = latestRecord.savedAt;
      
      const alertRow = document.createElement('tr');
      alertRow.innerHTML = `
        <td colspan="11" style="padding: 20px; border: none;">
          <div style="background: linear-gradient(135deg, #28a745, #20c997); color: #ffffff; padding: 18px; border-radius: 12px; text-align: center; font-size: 16px; font-weight: 800; border: 3px solid #1e7e34; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4); margin: 10px 0; animation: pulse 2s infinite;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
              <span style="font-size: 20px;">⚠️</span>
              <strong>الكميات المتبقية محدثة بعد آخر استقطاع</strong>
            </div>
            <div style="font-size: 14px; margin-top: 8px; opacity: 0.9;">
              جميع الأرقام المعروضة تعكس الكميات الفعلية المتبقية في النظام
            </div>
          </div>
          
          <div style="background: linear-gradient(135deg, #dc3545, #c82333, #007bff); color: #ffffff; padding: 20px; border-radius: 12px; text-align: center; border: 3px solid #bd2130; box-shadow: 0 6px 20px rgba(220, 53, 69, 0.5); margin: 15px 0; animation: pulse 2s infinite; position: relative; overflow: hidden;">
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.1) 50%, transparent 60%); animation: shine 3s infinite;"></div>
            <div style="position: relative; z-index: 2;">
              <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px; opacity: 0.9;">
                آخر كمية متبقية (حُفظت في ${lastSavedDate})
              </div>
              <div style="font-size: 42px; font-weight: 900; text-shadow: 0 3px 6px rgba(0,0,0,0.5); color: #ffff00; letter-spacing: 1px;">
                ${lastRemaining} ${lastUnit}
              </div>
            </div>
          </div>
        </td>`;
      resultsList.appendChild(alertRow);
    }
  }
  document.getElementById('searchResultsModal').style.display = 'block';
}

function closeSearchResultsModal() {
  document.getElementById('searchResultsModal').style.display = 'none';
}





// طباعة تقرير الإعفاءات فقط
async function printCertificatesReport() {
  try {
    const response = await fetch('/api/certificates');
    const result = await response.json();
    
    if (!result.success || !result.certificates || result.certificates.length === 0) {
      showAlert('لا توجد شهادات في قاعدة البيانات للطباعة!', 'warning');
      return;
    }
    
    const certificates = result.certificates;
    const printWindow = window.open('', '', 'height=800,width=1000');
    
    // إنتظار تحميل الشعارات
    const logoPromises = [
      new Promise((resolve) => {
        const img1 = new Image();
        img1.onload = resolve;
        img1.onerror = resolve;
        img1.src = `https://www2.0zz0.com/2025/05/19/22/510831948.png?${Date.now()}`;
      }),
      new Promise((resolve) => {
        const img2 = new Image();
        img2.onload = resolve;
        img2.onerror = resolve;
        img2.src = `https://www2.0zz0.com/2025/05/19/22/823371779.png?${Date.now()}`;
      })
    ];
    
    await Promise.all(logoPromises);
    
    printWindow.document.write(`
      <html>
      <head>
        <title>تقرير الشهادات الكمركية العراقية</title>
        <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
        <style>
          body { 
            font-family: 'Cairo', Arial, sans-serif; 
            direction: rtl; 
            margin: 20px;
            background: #fff;
            color: #000;
          }
          .header { 
            text-align: center; 
            margin-bottom: 30px; 
            border-bottom: 3px solid #002147;
            padding-bottom: 20px;
          }
          .logos {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 50px;
          }
          .logo { 
            width: 100px; 
            height: 100px;
            object-fit: contain;
          }
          .header h1 {
            color: #002147;
            font-size: 28px;
            margin: 15px 0;
            font-weight: 700;
          }
          .header h2 {
            color: #cc0000;
            font-size: 22px;
            margin: 12px 0;
            font-weight: 600;
          }
          .header h3 {
            color: #002147;
            font-size: 20px;
            margin: 10px 0;
            font-weight: 600;
          }
        table { 
          width: 100%; 
          border-collapse: collapse; 
          margin: 20px 0;
          font-size: 12px;
        }
        th, td { 
          border: 1px solid #002147; 
          padding: 8px; 
          text-align: center;
          vertical-align: middle;
        }
        th { 
          background: linear-gradient(135deg, #2196f3, #1976d2);
          color: #ffd700; 
          font-weight: bold;
        }
        .total-row {
          background: #e3f2fd !important;
          font-weight: bold;
          color: #1976d2;
        }
        .expired { 
          background: #ffebee !important; 
          color: #d32f2f !important;
        }
        .footer {
          margin-top: 30px;
          text-align: center;
          font-size: 14px;
          color: #002147;
          border-top: 2px solid #002147;
          padding-top: 15px;
        }
        @media print {
          body { margin: 0; }
          .header { page-break-after: avoid; }
          table { page-break-inside: avoid; }
        }
        </style>
      </head>
      <body>
        <div class="header">
          <div class="logos">
            <img src="https://www2.0zz0.com/2025/05/19/22/510831948.png" alt="شعار العراق" class="logo">
            <img src="https://www2.0zz0.com/2025/05/19/22/823371779.png" alt="شعار الكمارك" class="logo">
          </div>
          <h1>جمهورية العراق</h1>
          <h2>وزارة المالية - الهيئة العامة للكمارك</h2>
          <h3>مركز كمرك طريبيل الحدودي 642</h3>
          <h3>تقرير الشهادات الكمركية</h3>
          <p>تاريخ الطباعة: ${new Date().toLocaleDateString('ar-EG')} - ${new Date().toLocaleTimeString('ar-EG')}</p>
        </div>
        
        <table>
          <thead>
            <tr>
              <th>م</th>
              <th>اسم الشركة</th>
              <th>رقم الشهادة</th>
              <th>التسلسل الحدودي</th>
              <th>تاريخ الشهادة</th>
              <th>نوع البضاعة</th>
              <th>الكمية الكلية</th>
              <th>المستقطعة</th>
              <th>المتبقية</th>
              <th>الوحدة</th>
              <th>تاريخ الحفظ</th>
            </tr>
          </thead>
          <tbody>
    `);
    
    let totalQuantity = 0;
    let totalDeducted = 0;
    let totalRemaining = 0;
    
    certificates.forEach((cert, index) => {
      const remaining = parseFloat(cert.remainingQuantity) || 0;
      const isExpired = remaining <= 0;
      const rowClass = isExpired ? 'expired' : '';
      
      totalQuantity += parseFloat(cert.totalQuantity) || 0;
      totalDeducted += parseFloat(cert.deductedQuantity) || 0;
      totalRemaining += remaining;
      
      printWindow.document.write(`
        <tr class="${rowClass}">
          <td>${index + 1}</td>
          <td>${cert.company || ''}</td>
          <td>${cert.certificateNumber || ''}</td>
          <td>${cert.borderSerial || ''}</td>
          <td>${cert.certificateDate || ''}</td>
          <td>${cert.itemType || ''}</td>
          <td>${cert.totalQuantity || 0}</td>
          <td>${cert.deductedQuantity || 0}</td>
          <td>${cert.remainingQuantity || 0}</td>
          <td>${cert.unit || ''}</td>
          <td>${cert.savedAt || ''}</td>
        </tr>
      `);
    });
    
    printWindow.document.write(`
          <tr class="total-row">
            <td colspan="6"><strong>المجموع الكلي</strong></td>
            <td><strong>${totalQuantity.toFixed(2)}</strong></td>
            <td><strong>${totalDeducted.toFixed(2)}</strong></td>
            <td><strong>${totalRemaining.toFixed(2)}</strong></td>
            <td colspan="2"><strong>إجمالي ${certificates.length} شهادة</strong></td>
          </tr>
          </tbody>
        </table>
        
        <div class="footer">
          <p><strong>نظام الاعفاءات الكمركية - مركز كمرك طريبيل 642</strong></p>
          <p>مطور التطبيق: احمد عبد القادر مشحن العبيدي</p>
        </div>
      </body>
      </html>
    `);
    
    printWindow.document.close();
    
    setTimeout(() => {
      printWindow.focus();
      printWindow.print();
      setTimeout(() => {
        printWindow.close();
      }, 500);
    }, 1000);
    
    showAlert('✅ تم تحضير تقرير الشهادات للطباعة', 'success');
    
  } catch (error) {
    console.error('Error printing certificates report:', error);
    showAlert('❌ خطأ في طباعة تقرير الشهادات', 'error');
  }
}

async function printExemptionsReport() {
  try {
    const response = await fetch('/api/exemptions');
    const result = await response.json();
    
    if (!result.success || !result.exemptions || result.exemptions.length === 0) {
      showAlert('لا توجد إعفاءات في قاعدة البيانات للطباعة!', 'warning');
      return;
    }
    
    const exemptions = result.exemptions;
    const printWindow = window.open('', '', 'height=800,width=1000');
    
    // إنتظار تحميل الشعارات
    const logoPromises = [
      new Promise((resolve) => {
        const img1 = new Image();
        img1.onload = resolve;
        img1.onerror = resolve;
        img1.src = `/static/images/iraq_logo.png?${Date.now()}`;
      }),
      new Promise((resolve) => {
        const img2 = new Image();
        img2.onload = resolve;
        img2.onerror = resolve;
        img2.src = `/static/images/customs_logo.png?${Date.now()}`;
      })
    ];
    
    await Promise.all(logoPromises);
    
    printWindow.document.write(`
      <html>
      <head>
        <title>تقرير الإعفاءات الكمركية العراقية</title>
        <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
        <style>
          body { 
            font-family: 'Cairo', Arial, sans-serif; 
            direction: rtl; 
            margin: 20px;
            background: #fff;
            color: #000;
          }
          .header { 
            text-align: center; 
            margin-bottom: 30px; 
            border-bottom: 3px solid #002147;
            padding-bottom: 20px;
          }
          .logos {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 50px;
          }
          .logo { 
            width: 100px; 
            height: 100px;
            object-fit: contain;
          }
          .header h1 {
            color: #002147;
            font-size: 28px;
            margin: 15px 0;
            font-weight: 700;
          }
          .header h2 {
            color: #cc0000;
            font-size: 22px;
            margin: 12px 0;
            font-weight: 600;
          }
          .header h3 {
            color: #002147;
            font-size: 20px;
            margin: 10px 0;
            font-weight: 600;
          }
        table { 
          width: 100%; 
          border-collapse: collapse; 
          margin: 20px 0; 
          font-size: 14px;
        }
        th, td { 
          border: 2px solid #002147; 
          padding: 12px 8px; 
          text-align: center; 
          vertical-align: middle;
        }
        th { 
          background: linear-gradient(135deg, #002147, #003366); 
          color: #ffd700;
          font-weight: bold;
        }
        tr:nth-child(even) {
          background-color: #f8f9fa;
        }
        .expired {
          background-color: #ffebee !important;
          color: #d32f2f;
          font-weight: bold;
        }
        .expired td {
          border-color: #f44336 !important;
          position: relative;
        }
        .expired-label {
          background: #f44336;
          color: white;
          padding: 2px 8px;
          border-radius: 4px;
          font-size: 10px;
          font-weight: bold;
          position: absolute;
          top: 2px;
          right: 2px;
        }
        .footer { 
          margin-top: 40px; 
          text-align: center; 
          font-size: 12px;
          border-top: 2px solid #002147;
          padding-top: 20px;
          color: #002147;
        }
        .print-date {
          background: #f0f0f0;
          padding: 10px;
          border-radius: 8px;
          margin: 10px 0;
        }
        @media print {
          body { margin: 0; }
          .header { page-break-inside: avoid; }
          table { page-break-inside: auto; }
          tr { page-break-inside: avoid; }
        }
      </style>
    </head>
    <body>
      <div class="header">
        <div class="logos">
          <img src="/static/images/iraq_logo.png" alt="شعار الجمهورية العراقية" class="logo">
          <div style="text-align: center;">
            <h1>🇮🇶 جمهورية العراق 🇮🇶</h1>
            <h2>وزارة المالية - الهيئة العامة للكمارك</h2>
            <h3>مركز كمرك طريبيل الحدودي 642</h3>
            <h3>📋 تقرير الإعفاءات - شعبة المنفست الإلكتروني</h3>
          </div>
          <img src="/static/images/customs_logo.png" alt="شعار الكمارك العراقية" class="logo">
        </div>
        <div class="print-date">
          <strong>📅 تاريخ الطباعة:</strong> ${new Date().toLocaleString('en-GB')}
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>ت</th>
            <th>اسم الشركة</th>
            <th>رقم الشهادة</th>
            <th>التسلسل الحدودي</th>
            <th>التاريخ</th>
            <th>نوع البضاعة</th>
            <th>الكمية الكلية</th>
            <th>المستقطعة</th>
            <th>المتبقية</th>
            <th>الوحدة</th>
            <th>الحالة</th>
          </tr>
        </thead>
        <tbody>
  `);
  
    exemptions.forEach((exemption, index) => {
      const remaining = parseFloat(exemption.remainingQuantity) || 0;
      const isExpired = remaining <= 0;
      const rowClass = isExpired ? 'expired' : '';
      const status = isExpired ? 'نافذة ❌' : remaining <= (exemption.totalQuantity * 0.1) ? 'قليلة ⚠️' : 'متاحة ✅';
      
      printWindow.document.write(`
        <tr class="${rowClass}">
          <td>${index + 1}${isExpired ? '<span class="expired-label">نافذة</span>' : ''}</td>
          <td>${exemption.company}</td>
          <td>${exemption.certificateNumber}</td>
          <td>${exemption.borderSerial}</td>
          <td>${exemption.certificateDate}</td>
          <td>${exemption.itemType}</td>
          <td>${exemption.totalQuantity}</td>
          <td>${exemption.deductedQuantity}</td>
          <td style="${isExpired ? 'color: #f44336; font-weight: bold;' : ''}">${exemption.remainingQuantity}</td>
          <td>${exemption.unit}</td>
          <td style="${isExpired ? 'color: #f44336; font-weight: bold;' : remaining <= (exemption.totalQuantity * 0.1) ? 'color: #ff9800; font-weight: bold;' : 'color: #4caf50; font-weight: bold;'}">${status}</td>
      </tr>
    `);
  });
  
  printWindow.document.write(`
        </tbody>
      </table>
      <div class="footer">
        <h4>🖥️ نظام إدارة الإعفاءات الكمركية العراقية</h4>
        <p><strong>المطور:</strong> احمد عبد القادر مشحن العبيدي</p>
        <p><strong>📧 البريد الإلكتروني:</strong> alobaidymo@gmail.com</p>
        <p><strong>📱 الهاتف:</strong> +9647768525871</p>
        <hr>
        <p><strong>📊 إحصائيات التقرير:</strong></p>
        <p>إجمالي الإعفاءات: ${exemptions.length} | الإعفاءات النافذة: ${exemptions.filter(e => (parseFloat(e.remainingQuantity) || 0) <= 0).length} | الإعفاءات المتاحة: ${exemptions.filter(e => (parseFloat(e.remainingQuantity) || 0) > 0).length}</p>
        <p style="font-size: 10px; color: #666;">تم إنشاء هذا التقرير تلقائياً بواسطة نظام إدارة الإعفاءات المطور بتقنيات حديثة</p>
      </div>
    </body>
    </html>
  `);
  
    printWindow.document.close();
    
    // إنتظار تحميل الشعارات في النافذة الجديدة
    printWindow.onload = () => {
      setTimeout(() => {
        printWindow.print();
      }, 1000);
    };
    
  } catch (error) {
    console.error('Error printing report:', error);
    alert('❌ خطأ في طباعة التقرير');
  }
}





// وظائف النسخ الاحتياطي
function createBackup() {
  const certificates = JSON.parse(localStorage.getItem('certificates') || '[]');
  const backup = {
    version: "1.0",
    created: new Date().toISOString(),
    certificates: certificates
  };
  
  const dataStr = JSON.stringify(backup, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `نسخة_احتياطية_${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  URL.revokeObjectURL(url);
  
  alert("✅ تم إنشاء النسخة الاحتياطية بنجاح");
}

function restoreBackup() {
  const fileInput = document.getElementById('backupFile');
  const file = fileInput.files[0];
  
  if (!file) {
    alert("⚠️ يرجى اختيار ملف النسخة الاحتياطية");
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const backup = JSON.parse(e.target.result);
      if (backup.certificates && Array.isArray(backup.certificates)) {
        const confirmRestore = confirm("⚠️ سيتم استبدال جميع البيانات الحالية. هل تريد المتابعة؟");
        if (confirmRestore) {
          localStorage.setItem('certificates', JSON.stringify(backup.certificates));
          alert("✅ تم استعادة النسخة الاحتياطية بنجاح");
          updateStats();
          renderCertificates();
        }
      } else {
        alert("❌ ملف النسخة الاحتياطية غير صالح");
      }
    } catch (error) {
      alert("❌ خطأ في قراءة ملف النسخة الاحتياطية");
    }
  };
  reader.readAsText(file);
}

function clearAllData() {
  const confirmClear = confirm("⚠️ خطر: سيتم حذف جميع البيانات نهائياً. هل أنت متأكد؟");
  if (confirmClear) {
    const secondConfirm = confirm("❌ تأكيد أخير: سيتم فقدان جميع الشهادات والبيانات!");
    if (secondConfirm) {
      localStorage.removeItem('certificates');
      alert("✅ تم حذف جميع البيانات");
      updateStats();
      renderCertificates();
    }
  }
}

// إضافة أحداث لوحة المفاتيح
document.addEventListener('DOMContentLoaded', function() {
    // الضغط على Enter في حقل كلمة المرور
    document.getElementById('passwordInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            checkPassword();
        }
    });
    
    // إضافة تأثير الاهتزاز للحقول الخاطئة
    const style = document.createElement('style');
    style.textContent = `
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }
        
        .shake {
            animation: shake 0.6s ease-in-out;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
    
    // تأثيرات بصرية إضافية للعناصر التفاعلية
    const interactiveElements = document.querySelectorAll('.elegant-button, .elegant-input, .elegant-select');
    
    interactiveElements.forEach(element => {
        element.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
        });
        
        element.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
    
    // تحسين تجربة المستخدم للنصوص المتحركة
    const scrollingTitle = document.querySelector('.scrolling-title');
    if (scrollingTitle) {
        scrollingTitle.addEventListener('mouseenter', function() {
            this.style.animationPlayState = 'paused';
        });
        
        scrollingTitle.addEventListener('mouseleave', function() {
            this.style.animationPlayState = 'running';
        });
    }
    
    // إضافة تأثيرات للشعارات
    const logos = document.querySelectorAll('.logo-hover');
    logos.forEach(logo => {
        logo.addEventListener('click', function() {
            this.style.animation = 'none';
            setTimeout(() => {
                this.style.animation = 'logoSpin 1s ease-in-out';
            }, 10);
        });
    });
    
    // إضافة أنماط إضافية للتأثيرات
    const additionalStyles = document.createElement('style');
    additionalStyles.textContent = `
        @keyframes logoSpin {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }
        
        .elegant-button:active {
            transform: translateY(1px) !important;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important;
        }
        
        .tab-button:active {
            transform: translateY(1px) !important;
        }
    `;
    document.head.appendChild(additionalStyles);
});

// دالة تحديث الوقت - تقويم ميلادي فقط
function updateDateTime() {
    const now = new Date();
    // فرض التقويم الميلادي
    const day = String(now.getDate()).padStart(2, '0');
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const year = now.getFullYear();
    const gregorianDate = `${day}/${month}/${year}`;
    
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    const gregorianTime = `${hours}:${minutes}:${seconds}`;
    
    // يمكن إضافة عرض التاريخ والوقت في مكان مناسب
    console.log(`التاريخ: ${gregorianDate} - الوقت: ${gregorianTime}`);
}

// تشغيل تحديث الوقت كل دقيقة
setInterval(updateDateTime, 60000);

// دالة للتحقق من حالة الاتصال
function checkConnection() {
    if (navigator.onLine) {
        console.log('متصل بالإنترنت');
    } else {
        showAlert('لا يوجد اتصال بالإنترنت', 'error');
    }
}

// مراقبة حالة الاتصال
window.addEventListener('online', () => {
    showAlert('تم استعادة الاتصال بالإنترنت', 'success');
});

window.addEventListener('offline', () => {
    showAlert('انقطع الاتصال بالإنترنت', 'error');
});

// دالة حفظ البيانات محلياً (للطوارئ)
function saveDataLocally(key, data) {
    try {
        localStorage.setItem(key, JSON.stringify(data));
        console.log('تم حفظ البيانات محلياً');
    } catch (error) {
        console.error('خطأ في حفظ البيانات محلياً:', error);
    }
}

// دالة استرجاع البيانات المحفوظة محلياً
function getLocalData(key) {
    try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
    } catch (error) {
        console.error('خطأ في استرجاع البيانات المحلية:', error);
        return null;
    }
}

// تهيئة التطبيق عند التحميل
document.addEventListener('DOMContentLoaded', function() {
    console.log('تم تحميل نظام الكمارك العراقية بنجاح');
    checkConnection();
    updateDateTime();
});
// إضافة event listeners للتحقق من حالة الشهادة
document.addEventListener('DOMContentLoaded', function() {
  // للنموذج العادي - الإعفاءات
  const certNumberInput = document.getElementById('certificateNumber');
  if (certNumberInput) {
    certNumberInput.addEventListener('blur', function() {
      checkCertificateStatus(this.value.trim());
    });
  }
  
  // للنموذج المحمول - الإعفاءات
  const certNumberInputMobile = document.getElementById('certificateNumber-mobile');
  if (certNumberInputMobile) {
    certNumberInputMobile.addEventListener('blur', function() {
      checkCertificateStatus(this.value.trim());
    });
  }
  
  // للنموذج العادي - الشهادات
  const certCertNumberInput = document.getElementById('cert-certificateNumber');
  if (certCertNumberInput) {
    certCertNumberInput.addEventListener('blur', async function() {
      const certNumber = this.value.trim();
      if (certNumber) {
        const canProceed = await checkCertStatus(certNumber);
        if (!canProceed) {
          showAlert('⚠️ تحذير: هذه الشهادة نافذة أو مكتملة!', 'error');
        }
      }
    });
  }
  
  // للنموذج المحمول - الشهادات
  const certCertNumberInputMobile = document.getElementById('cert-certificateNumber-mobile');
  if (certCertNumberInputMobile) {
    certCertNumberInputMobile.addEventListener('blur', async function() {
      const certNumber = this.value.trim();
      if (certNumber) {
        const canProceed = await checkCertStatus(certNumber);
        if (!canProceed) {
          showAlert('⚠️ تحذير: هذه الشهادة نافذة أو مكتملة!', 'error');
        }
      }
    });
  }
});

// دوال إدارة الشهادات (القسم الجديد)

// دالة حساب الكمية المتبقية للشهادات - سطح المكتب
function updateCertRemaining() {
  const total = parseFloat(document.getElementById('certTotalQuantity').value) || 0;
  const deducted = parseFloat(document.getElementById('certDeductedQuantity').value) || 0;
  const remaining = total - deducted;
  document.getElementById('certRemainingQuantity').value = remaining;

  // تنبيه نفاد الكمية مع صوت
  if (remaining <= 0 && total > 0) {
    playWarningSound();
    showQuantityWarning("⚠️ تحذير: الكمية الخاصة بهذه الشهادة قد نفذت تماماً!");
  } else if (remaining <= (total * 0.1) && total > 0 && remaining > 0) {
    playWarningSound();
    showQuantityWarning("⚠️ تنبيه: الكمية المتبقية للشهادة قليلة جداً - أقل من 10%");
  }
}

// دالة حساب الكمية المتبقية للشهادات - الموبايل
function updateCertRemainingMobile() {
  const total = parseFloat(document.getElementById('certTotalQuantity-mobile').value) || 0;
  const deducted = parseFloat(document.getElementById('certDeductedQuantity-mobile').value) || 0;
  const remaining = total - deducted;
  document.getElementById('certRemainingQuantity-mobile').value = remaining;

  // تنبيه نفاد الكمية مع صوت
  if (remaining <= 0 && total > 0) {
    playWarningSound();
    showQuantityWarning("⚠️ تحذير: الكمية الخاصة بهذه الشهادة قد نفذت تماماً!");
  } else if (remaining <= (total * 0.1) && total > 0 && remaining > 0) {
    playWarningSound();
    showQuantityWarning("⚠️ تنبيه: الكمية المتبقية للشهادة قليلة جداً - أقل من 10%");
  }
}

// دالة حفظ الشهادة
async function saveCertCertificate() {
  // تحديد ما إذا كنا نستخدم النموذج المحمول أم الجدول
  let cert;
  
  // فحص إذا كانت حقول الموبايل مرئية ولها قيم
  const mobileForm = document.querySelector('.mobile-form');
  const isMobile = window.innerWidth <= 768 || (mobileForm && getComputedStyle(mobileForm).display !== 'none');
  
  if (isMobile) {
    // استخدام بيانات النموذج المحمول
    cert = {
      company: document.getElementById('certCompany-mobile').value.trim(),
      borderSerial: document.getElementById('certBorderSerial-mobile').value.trim(),
      certificateNumber: document.getElementById('certCertificateNumber-mobile').value.trim(),
      certificateDate: document.getElementById('certCertificateDate-mobile').value,
      totalQuantity: parseFloat(document.getElementById('certTotalQuantity-mobile').value) || 0,
      deductedQuantity: parseFloat(document.getElementById('certDeductedQuantity-mobile').value) || 0,
      unit: document.getElementById('certUnit-mobile').value,
      itemType: document.getElementById('certItemType-mobile').value.trim()
    };
  } else {
    // استخدام بيانات الجدول
    cert = {
      company: document.getElementById('certCompany').value.trim(),
      borderSerial: document.getElementById('certBorderSerial').value.trim(),
      certificateNumber: document.getElementById('certCertificateNumber').value.trim(),
      certificateDate: document.getElementById('certCertificateDate').value,
      totalQuantity: parseFloat(document.getElementById('certTotalQuantity').value) || 0,
      deductedQuantity: parseFloat(document.getElementById('certDeductedQuantity').value) || 0,
      unit: document.getElementById('certUnit').value,
      itemType: document.getElementById('certItemType').value.trim()
    };
  }

  if (!cert.company || !cert.borderSerial || !cert.certificateNumber || !cert.certificateDate || !cert.totalQuantity || !cert.itemType) {
    showAlert("⚠️ يرجى إدخال كافة الحقول المطلوبة للشهادة (الشركة، التسلسل الحدودي، رقم الشهادة، تاريخ الشهادة، نوع البضاعة، والكمية الكلية).", 'error');
    return;
  }

  // تحديد إذا كان هذا تعديل أم إنشاء جديد
  const isEditing = window.editingCertificateId;
  
  // حفظ في قاعدة البيانات
  try {
    const url = isEditing ? `/api/certificates/${window.editingCertificateId}` : '/api/certificates';
    const method = isEditing ? 'PUT' : 'POST';
    
    const response = await fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        company: cert.company,
        border_serial: cert.borderSerial,
        certificate_number: cert.certificateNumber,
        certificate_date: cert.certificateDate,
        total_quantity: cert.totalQuantity,
        deducted_quantity: cert.deductedQuantity,
        remaining_quantity: cert.totalQuantity - cert.deductedQuantity,
        unit: cert.unit,
        item_type: cert.itemType
      })
    });

    const result = await response.json();
    
    if (result.success) {
      const message = isEditing ? '✅ تم تحديث الشهادة بنجاح في قاعدة البيانات' : '✅ تم حفظ الشهادة بنجاح في قاعدة البيانات';
      showAlert(message, 'success');
      
      // إعادة تعيين معرف التعديل
      if (isEditing) {
        window.editingCertificateId = null;
      }
      
      // مسح النموذج
      if (isMobile) {
        document.getElementById('certCompany-mobile').value = '';
        document.getElementById('certBorderSerial-mobile').value = '';
        document.getElementById('certCertificateNumber-mobile').value = '';
        document.getElementById('certCertificateDate-mobile').value = '';
        document.getElementById('certTotalQuantity-mobile').value = '';
        document.getElementById('certDeductedQuantity-mobile').value = '';
        document.getElementById('certRemainingQuantity-mobile').value = '';
        document.getElementById('certUnit-mobile').value = 'طن';
        document.getElementById('certItemType-mobile').value = '';
      } else {
        document.getElementById('certCompany').value = '';
        document.getElementById('certBorderSerial').value = '';
        document.getElementById('certCertificateNumber').value = '';
        document.getElementById('certCertificateDate').value = '';
        document.getElementById('certTotalQuantity').value = '';
        document.getElementById('certDeductedQuantity').value = '';
        document.getElementById('certRemainingQuantity').value = '';
        document.getElementById('certUnit').value = 'طن';
        document.getElementById('certItemType').value = '';
      }
      
      // تحديث الإحصائيات
      updateCertificatesStats();
    } else {
      showAlert(`❌ خطأ في حفظ الشهادة: ${result.message}`, 'error');
    }
  } catch (error) {
    console.error('خطأ في حفظ الشهادة:', error);
    showAlert('❌ خطأ في الاتصال بالخادم', 'error');
  }
}

// دالة عرض الشهادات
async function openCertModal() {
  try {
    const response = await fetch('/api/certificates');
    const result = await response.json();
    
    if (result.success && result.certificates) {
      displayCertificatesModal(result.certificates);
    } else {
      showAlert('لا توجد شهادات في قاعدة البيانات', 'info');
    }
  } catch (error) {
    console.error('خطأ في جلب الشهادات:', error);
    showAlert('❌ خطأ في الاتصال بالخادم', 'error');
  }
}

// عرض modal الشهادات
function displayCertificatesModal(certificates) {
  let modalHtml = `
    <div id="certModal" class="modal">
      <div class="modal-content" style="width: 95%; max-width: 1400px;">
        <div class="modal-header">
          <span class="close" onclick="closeCertModal()">&times;</span>
          <h2>📜 إدارة الشهادات المحفوظة (${certificates.length})</h2>
        </div>
        <div class="modal-body">
          <div class="table-container">
            <table class="styled-table full-width">
              <thead>
                <tr>
                  <th>اسم الشركة</th>
                  <th>التسلسل الحدودي</th>
                  <th>رقم الشهادة</th>
                  <th>تاريخ الشهادة</th>
                  <th>الكمية الكلية</th>
                  <th>الوحدة</th>
                  <th>الكمية المستقطعة</th>
                  <th>نوع البضاعة</th>
                  <th>المتبقية</th>
                  <th>تاريخ الحفظ</th>
                  <th>العمليات</th>
                </tr>
              </thead>
              <tbody>
  `;
  
  certificates.forEach((cert, index) => {
    const remaining = parseFloat(cert.remainingQuantity) || 0;
    const isExpired = remaining <= 0;
    const rowClass = isExpired ? 'expired-row' : '';
    
    modalHtml += `
      <tr class="${rowClass}">
        <td data-label="اسم الشركة">${cert.company}</td>
        <td data-label="التسلسل الحدودي">${cert.borderSerial}</td>
        <td data-label="رقم الشهادة">${cert.certificateNumber}</td>
        <td data-label="تاريخ الشهادة">${cert.certificateDate}</td>
        <td data-label="الكمية الكلية">${cert.totalQuantity}</td>
        <td data-label="الوحدة">${cert.unit}</td>
        <td data-label="الكمية المستقطعة">${cert.deductedQuantity}</td>
        <td data-label="نوع البضاعة">${cert.itemType}</td>
        <td data-label="المتبقية" style="color: ${isExpired ? '#f44336' : 'inherit'}; font-weight: ${isExpired ? 'bold' : 'normal'};">
          ${cert.remainingQuantity}
          ${isExpired ? '<span style="color: #f44336; font-size: 10px; display: block;">⚠️ نافذة</span>' : ''}
        </td>
        <td data-label="تاريخ الحفظ">${cert.savedAt}</td>
        <td data-label="العمليات">
          <button onclick="editCertificate(${cert.id})" class="edit-btn" title="تعديل الشهادة">✏️ تعديل</button>
          <button onclick="deleteCertificate(${cert.id})" class="delete-btn" title="حذف الشهادة">🗑️ حذف</button>
        </td>
      </tr>
    `;
  });
  
  modalHtml += `
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // إزالة أي modal موجود
  const existingModal = document.getElementById('certModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  // إضافة الـ modal الجديد
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  document.getElementById('certModal').style.display = 'block';
}

// إغلاق modal الشهادات
function closeCertModal() {
  const modal = document.getElementById('certModal');
  if (modal) {
    modal.remove();
  }
}

// تعديل شهادة
async function editCertificateOld(certId) {
  try {
    const response = await fetch(`/api/certificates/${certId}`);
    const result = await response.json();
    
    if (result.success && result.certificate) {
      const cert = result.certificate;
      
      // ملء النموذج بالبيانات الحالية
      const isMobile = window.innerWidth <= 768;
      
      if (isMobile) {
        document.getElementById('certCompany-mobile').value = cert.company;
        document.getElementById('certBorderSerial-mobile').value = cert.borderSerial;
        document.getElementById('certCertificateNumber-mobile').value = cert.certificateNumber;
        document.getElementById('certCertificateDate-mobile').value = cert.certificateDate;
        document.getElementById('certTotalQuantity-mobile').value = cert.totalQuantity;
        document.getElementById('certDeductedQuantity-mobile').value = cert.deductedQuantity;
        document.getElementById('certUnit-mobile').value = cert.unit;
        document.getElementById('certItemType-mobile').value = cert.itemType;
        updateCertRemainingMobile();
      } else {
        document.getElementById('certCompany').value = cert.company;
        document.getElementById('certBorderSerial').value = cert.borderSerial;
        document.getElementById('certCertificateNumber').value = cert.certificateNumber;
        document.getElementById('certCertificateDate').value = cert.certificateDate;
        document.getElementById('certTotalQuantity').value = cert.totalQuantity;
        document.getElementById('certDeductedQuantity').value = cert.deductedQuantity;
        document.getElementById('certUnit').value = cert.unit;
        document.getElementById('certItemType').value = cert.itemType;
        updateCertRemaining();
      }
      
      // إغلاق الـ modal والانتقال لتبويب الشهادات
      closeCertModal();
      showTab('cert-certificates');
      
      // حفظ ID الشهادة للتحديث لاحقاً
      window.editingCertId = certId;
      showAlert('تم تحميل بيانات الشهادة للتعديل', 'info');
    }
  } catch (error) {
    console.error('خطأ في تحميل بيانات الشهادة:', error);
    showAlert('❌ خطأ في تحميل بيانات الشهادة', 'error');
  }
}

// حذف شهادة
async function deleteCertificate(certId) {
  if (!confirm('⚠️ هل أنت متأكد من حذف هذه الشهادة نهائياً؟')) {
    return;
  }
  
  try {
    const response = await fetch(`/api/certificates/${certId}`, {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (result.success) {
      showAlert('✅ تم حذف الشهادة بنجاح', 'success');
      closeCertModal();
      updateCertificatesStats();
    } else {
      showAlert(`❌ خطأ في حذف الشهادة: ${result.message}`, 'error');
    }
  } catch (error) {
    console.error('خطأ في حذف الشهادة:', error);
    showAlert('❌ خطأ في الاتصال بالخادم', 'error');
  }
}

// دالة فحص حالة الشهادة للتحذير
async function checkCertStatus(certNumber) {
  if (!certNumber) return true;
  
  // فحص في التخزين المحلي للشهادات
  const savedCertificates = JSON.parse(localStorage.getItem('savedCertificates') || '[]');
  const existingCert = savedCertificates.find(cert => cert.certificateNumber === certNumber);
  
  if (existingCert) {
    const remaining = parseFloat(existingCert.remainingQuantity) || 0;
    return remaining > 0;
  }
  
  return true; // إذا لم توجد الشهادة، السماح بالمتابعة
}

// تم حذف دالة عرض الشهادات - النظام يركز فقط على الإعفاءات

// ملء فلاتر الشهادات
function populateCertificatesFilters(certificates) {
  const companyFilter = document.getElementById('certificatesCompanyFilter');
  const itemFilter = document.getElementById('certificatesItemFilter');
  
  if (!companyFilter || !itemFilter) return;
  
  // إزالة الخيارات الموجودة
  companyFilter.innerHTML = '<option value="">جميع الشركات</option>';
  itemFilter.innerHTML = '<option value="">جميع الأنواع</option>';
  
  // جمع القيم الفريدة
  const companies = [...new Set(certificates.map(cert => cert.company))];
  const items = [...new Set(certificates.map(cert => cert.itemType))];
  
  // إضافة خيارات الشركات
  companies.forEach(company => {
    if (company) {
      const option = document.createElement('option');
      option.value = company;
      option.textContent = company;
      companyFilter.appendChild(option);
    }
  });
  
  // إضافة خيارات أنواع البضائع
  items.forEach(item => {
    if (item) {
      const option = document.createElement('option');
      option.value = item;
      option.textContent = item;
      itemFilter.appendChild(option);
    }
  });
}

// فلترة الشهادات
function filterCertificates() {
  let certificates = JSON.parse(localStorage.getItem('savedCertificates') || '[]');
  
  const companyFilter = document.getElementById('certificatesCompanyFilter');
  const itemFilter = document.getElementById('certificatesItemFilter');
  const statusFilter = document.getElementById('certificatesStatusFilter');
  const dateFromFilter = document.getElementById('certificatesDateFrom');
  const dateToFilter = document.getElementById('certificatesDateTo');
  
  if (!companyFilter || !itemFilter || !statusFilter) return;
  
  // تطبيق الفلاتر
  if (companyFilter.value) {
    certificates = certificates.filter(cert => cert.company === companyFilter.value);
  }
  
  if (itemFilter.value) {
    certificates = certificates.filter(cert => cert.itemType === itemFilter.value);
  }
  
  if (statusFilter.value) {
    certificates = certificates.filter(cert => {
      const remaining = parseFloat(cert.remainingQuantity) || 0;
      if (statusFilter.value === 'expired') return remaining <= 0;
      if (statusFilter.value === 'low') return remaining > 0 && remaining <= (cert.totalQuantity * 0.1);
      if (statusFilter.value === 'available') return remaining > (cert.totalQuantity * 0.1);
      return true;
    });
  }
  
  // فلترة التاريخ
  if (dateFromFilter && dateFromFilter.value) {
    certificates = certificates.filter(cert => cert.certificateDate >= dateFromFilter.value);
  }
  
  if (dateToFilter && dateToFilter.value) {
    certificates = certificates.filter(cert => cert.certificateDate <= dateToFilter.value);
  }
  
  displayFilteredCertificates(certificates);
}

// عرض الشهادات المفلترة
function displayFilteredCertificates(certificates) {
  const tbody = document.getElementById('savedCertificatesList');
  tbody.innerHTML = '';

  if (certificates.length === 0) {
    tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #666;">لا توجد نتائج تطابق الفلترة</td></tr>';
  } else {
    certificates.forEach((cert, index) => {
      const remaining = parseFloat(cert.remainingQuantity) || 0;
      const isExpired = remaining <= 0;
      const isLow = remaining <= (cert.totalQuantity * 0.1);
      
      const row = document.createElement('tr');
      if (isExpired) {
        row.style.backgroundColor = '#ffebee';
        row.style.color = '#c62828';
      } else if (isLow) {
        row.style.backgroundColor = '#fff3e0';
        row.style.color = '#ef6c00';
      }
      
      row.innerHTML = `
        <td data-label="اسم الشركة">${cert.company}</td>
        <td data-label="رقم الشهادة">${cert.certificateNumber}</td>
        <td data-label="التسلسل الحدودي">${cert.borderSerial}</td>
        <td data-label="التاريخ">${cert.certificateDate}</td>
        <td data-label="نوع البضاعة">${cert.itemType}</td>
        <td data-label="الكمية الكلية">${cert.totalQuantity}</td>
        <td data-label="المستقطعة">${cert.deductedQuantity}</td>
        <td data-label="المتبقية" style="${isExpired ? 'color: #f44336; font-weight: bold;' : ''}">${cert.remainingQuantity}</td>
        <td data-label="الوحدة">${cert.unit}</td>
        <td data-label="تاريخ الحفظ">${cert.savedAt}</td>
        <td data-label="العمليات">
          <button onclick="editSavedCertificate(${index})" class="edit-btn">✏️ تعديل</button>
          <button onclick="deleteSavedCertificate(${index})" class="delete-btn">🗑️ حذف</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  }
}

// إزالة فلاتر الشهادات
function clearCertificatesFilters() {
  const companyFilter = document.getElementById('certificatesCompanyFilter');
  const itemFilter = document.getElementById('certificatesItemFilter');
  const statusFilter = document.getElementById('certificatesStatusFilter');
  const dateFromFilter = document.getElementById('certificatesDateFrom');
  const dateToFilter = document.getElementById('certificatesDateTo');
  
  if (companyFilter) companyFilter.value = '';
  if (itemFilter) itemFilter.value = '';
  if (statusFilter) statusFilter.value = '';
  if (dateFromFilter) dateFromFilter.value = '';
  if (dateToFilter) dateToFilter.value = '';
  
  filterCertificates();
}

// إضافة دالة عرض أعمق للشهادات لمطابقة الإعفاءات
function displayFilteredCertificates(certificates) {
  const tbody = document.getElementById('savedCertificatesList');
  tbody.innerHTML = '';

  if (certificates.length === 0) {
    tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #666;">لا توجد نتائج تطابق الفلترة</td></tr>';
  } else {
    certificates.forEach((cert, index) => {
      const remaining = parseFloat(cert.remainingQuantity) || 0;
      const isExpired = remaining <= 0;
      const isLow = remaining <= (cert.totalQuantity * 0.1);
      
      const row = document.createElement('tr');
      if (isExpired) {
        row.style.backgroundColor = '#ffebee';
        row.style.color = '#c62828';
      } else if (isLow) {
        row.style.backgroundColor = '#fff3e0';
        row.style.color = '#ef6c00';
      }
      
      row.innerHTML = `
        <td data-label="اسم الشركة">${cert.company}</td>
        <td data-label="رقم الشهادة">${cert.certificateNumber}</td>
        <td data-label="التسلسل الحدودي">${cert.borderSerial}</td>
        <td data-label="التاريخ">${cert.certificateDate}</td>
        <td data-label="نوع البضاعة">${cert.itemType}</td>
        <td data-label="الكمية الكلية">${cert.totalQuantity}</td>
        <td data-label="المستقطعة">${cert.deductedQuantity}</td>
        <td data-label="المتبقية" style="${isExpired ? 'color: #f44336; font-weight: bold;' : ''}">${cert.remainingQuantity}</td>
        <td data-label="الوحدة">${cert.unit}</td>
        <td data-label="تاريخ الحفظ">${cert.savedAt}</td>
        <td data-label="العمليات">
          <button onclick="editCertificate(this, ${index})" class="edit-btn">✏️ تعديل</button>
          <button onclick="deleteCertificate(this, ${index})" class="delete-btn">🗑️ حذف</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  }
}

// دوال فلترة الإعفاءات (إضافة الدوال المفقودة)
function populateExemptionsFilters(certificates) {
  const companyFilter = document.getElementById('exemptionsCompanyFilter');
  const itemFilter = document.getElementById('exemptionsItemFilter');
  
  if (!companyFilter || !itemFilter) return;
  
  // إزالة الخيارات الموجودة
  companyFilter.innerHTML = '<option value="">جميع الشركات</option>';
  itemFilter.innerHTML = '<option value="">جميع الأنواع</option>';
  
  // جمع القيم الفريدة
  const companies = [...new Set(certificates.map(cert => cert.company))];
  const items = [...new Set(certificates.map(cert => cert.itemType))];
  
  // إضافة خيارات الشركات
  companies.forEach(company => {
    if (company) {
      const option = document.createElement('option');
      option.value = company;
      option.textContent = company;
      companyFilter.appendChild(option);
    }
  });
  
  // إضافة خيارات أنواع البضائع
  items.forEach(item => {
    if (item) {
      const option = document.createElement('option');
      option.value = item;
      option.textContent = item;
      itemFilter.appendChild(option);
    }
  });
}

function displayExemptions(certificates) {
  const tbody = document.getElementById('certificatesList');
  tbody.innerHTML = '';

  if (certificates.length === 0) {
    tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #666;">لا توجد اعفاءات محفوظة</td></tr>';
  } else {
    certificates.forEach((cert, index) => {
      const remaining = parseFloat(cert.remainingQuantity) || 0;
      const isExpired = remaining <= 0;
      const isLow = remaining <= (cert.totalQuantity * 0.1);
      
      const row = document.createElement('tr');
      if (isExpired) {
        row.style.backgroundColor = '#ffebee';
        row.style.color = '#c62828';
      } else if (isLow) {
        row.style.backgroundColor = '#fff3e0';
        row.style.color = '#ef6c00';
      }
      
      row.innerHTML = `
        <td data-label="اسم الشركة">${cert.company}</td>
        <td data-label="رقم الاعفاء">${cert.certificateNumber}</td>
        <td data-label="التسلسل الحدودي">${cert.borderSerial}</td>
        <td data-label="التاريخ">${cert.certificateDate}</td>
        <td data-label="نوع البضاعة">${cert.itemType}</td>
        <td data-label="الكمية الكلية">${cert.totalQuantity}</td>
        <td data-label="المستقطعة">${cert.deductedQuantity}</td>
        <td data-label="المتبقية" style="${isExpired ? 'color: #f44336; font-weight: bold;' : ''}">${cert.remainingQuantity}</td>
        <td data-label="الوحدة">${cert.unit}</td>
        <td data-label="تاريخ الحفظ">${cert.savedAt}</td>
        <td data-label="العمليات">
          <button onclick="editCertificateFromDB(${cert.id})" class="edit-btn">✏️ تعديل</button>
          <button onclick="deleteCertificateFromDB(${cert.id})" class="delete-btn">🗑️ حذف</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  }
}

async function filterExemptions() {
  try {
    const response = await fetch('/api/certificates');
    const result = await response.json();
    
    if (!result.success) return;

    let certificates = result.certificates;
    
    const companyFilter = document.getElementById('exemptionsCompanyFilter');
    const itemFilter = document.getElementById('exemptionsItemFilter');
    const statusFilter = document.getElementById('exemptionsStatusFilter');
    const dateFromFilter = document.getElementById('exemptionsDateFrom');
    const dateToFilter = document.getElementById('exemptionsDateTo');
    
    if (!companyFilter || !itemFilter || !statusFilter) return;
    
    // تطبيق الفلاتر
    if (companyFilter.value) {
      certificates = certificates.filter(cert => cert.company === companyFilter.value);
    }
    
    if (itemFilter.value) {
      certificates = certificates.filter(cert => cert.itemType === itemFilter.value);
    }
    
    if (statusFilter.value) {
      certificates = certificates.filter(cert => {
        const remaining = parseFloat(cert.remainingQuantity) || 0;
        if (statusFilter.value === 'expired') return remaining <= 0;
        if (statusFilter.value === 'low') return remaining > 0 && remaining <= (cert.totalQuantity * 0.1);
        if (statusFilter.value === 'available') return remaining > (cert.totalQuantity * 0.1);
        return true;
      });
    }
    
    // فلترة التاريخ
    if (dateFromFilter && dateFromFilter.value) {
      certificates = certificates.filter(cert => cert.certificateDate >= dateFromFilter.value);
    }
    
    if (dateToFilter && dateToFilter.value) {
      certificates = certificates.filter(cert => cert.certificateDate <= dateToFilter.value);
    }
    
    displayExemptions(certificates);
  } catch (error) {
    console.error('Error filtering exemptions:', error);
  }
}

function clearExemptionsFilters() {
  const companyFilter = document.getElementById('exemptionsCompanyFilter');
  const itemFilter = document.getElementById('exemptionsItemFilter');
  const statusFilter = document.getElementById('exemptionsStatusFilter');
  const dateFromFilter = document.getElementById('exemptionsDateFrom');
  const dateToFilter = document.getElementById('exemptionsDateTo');
  
  if (companyFilter) companyFilter.value = '';
  if (itemFilter) itemFilter.value = '';
  if (statusFilter) statusFilter.value = '';
  if (dateFromFilter) dateFromFilter.value = '';
  if (dateToFilter) dateToFilter.value = '';
  
  filterExemptions();
}

// تم حذف دالة طباعة تقرير الشهادات - النظام يركز فقط على الإعفاءات

// طباعة تقرير شامل (إعفاءات + شهادات)
async function printCombinedReport() {
  try {
    // جلب الإعفاءات من الخادم
    const exemptionsResponse = await fetch('/api/certificates');
    const exemptionsResult = await exemptionsResponse.json();
    
    // جلب الشهادات من التخزين المحلي
    const certificates = JSON.parse(localStorage.getItem('savedCertificates') || '[]');
    
    if ((!exemptionsResult.success || exemptionsResult.certificates.length === 0) && certificates.length === 0) {
      showAlert('لا توجد بيانات للطباعة', 'error');
      return;
    }

    const exemptions = exemptionsResult.success ? exemptionsResult.certificates : [];
    
    const printWindow = window.open('', '_blank');
    
    printWindow.document.write(`
      <!DOCTYPE html>
      <html lang="ar" dir="rtl">
      <head>
        <meta charset="UTF-8">
        <title>التقرير الشامل - كمارك العراق</title>
        <style>
          * { margin: 0; padding: 0; box-sizing: border-box; }
          body { 
            font-family: 'Cairo', Arial, sans-serif; 
            direction: rtl; 
            text-align: right; 
            padding: 20px;
            background: #fff;
          }
          .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #002147;
            padding-bottom: 20px;
          }
          .logos {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          }
          .logo { width: 80px; height: auto; }
          h1, h2, h3, h4 { color: #002147; margin: 5px 0; }
          h1 { font-size: 24px; }
          h2 { font-size: 20px; }
          h3 { font-size: 18px; }
          h4 { font-size: 16px; margin-top: 30px; }
          table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 11px;
          }
          th, td {
            border: 1px solid #002147;
            padding: 6px;
            text-align: center;
            vertical-align: middle;
          }
          th {
            background: linear-gradient(135deg, #002147, #003366);
            color: #ffd700;
            font-weight: bold;
            font-size: 12px;
          }
          .exemptions th {
            background: linear-gradient(135deg, #4caf50, #45a049);
          }
          .certificates th {
            background: linear-gradient(135deg, #2196f3, #1976d2);
          }
          tr:nth-child(even) { background-color: #f8f9fa; }
          tr:nth-child(odd) { background-color: #ffffff; }
          .expired { background-color: #ffebee !important; color: #c62828; }
          .expired-label {
            background: #f44336;
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 8px;
            margin-right: 5px;
          }
          .section-header {
            background: #e3f2fd;
            padding: 15px;
            margin: 20px 0 10px 0;
            border-right: 5px solid #2196f3;
            border-radius: 5px;
          }
          .exemptions-header {
            background: #e8f5e8;
            border-right-color: #4caf50;
          }
          .footer { 
            margin-top: 40px; 
            text-align: center; 
            font-size: 12px;
            border-top: 2px solid #002147;
            padding-top: 20px;
            color: #002147;
          }
          .print-date {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
          }
          @media print {
            body { margin: 0; }
            .header { page-break-inside: avoid; }
            table { page-break-inside: auto; }
            tr { page-break-inside: avoid; }
            .section-header { page-break-after: avoid; }
          }
        </style>
      </head>
      <body>
        <div class="header">
          <div class="logos">
            <img src="https://www2.0zz0.com/2025/05/19/22/510831948.png" alt="شعار العراق" class="logo">
            <div style="text-align: center;">
              <h1>🇮🇶 جمهورية العراق 🇮🇶</h1>
              <h2>وزارة المالية - الهيئة العامة للكمارك</h2>
              <h3>مركز كمرك طريبيل الحدودي 642</h3>
              <h3>📊 التقرير الشامل - شعبة المنفست الإلكتروني</h3>
            </div>
            <img src="https://www2.0zz0.com/2025/05/19/22/823371779.png" alt="شعار الكمارك" class="logo">
          </div>
          <div class="print-date">
            <strong>📅 تاريخ الطباعة:</strong> ${new Date().toLocaleString('en-GB')}
          </div>
        </div>
    `);
    
    // قسم الإعفاءات
    if (exemptions.length > 0) {
      printWindow.document.write(`
        <div class="section-header exemptions-header">
          <h4>🏛️ قسم الإعفاءات الكمركية (${exemptions.length} إعفاء)</h4>
        </div>
        <table class="exemptions">
          <thead>
            <tr>
              <th>ت</th>
              <th>اسم الشركة</th>
              <th>رقم الإعفاء</th>
              <th>التسلسل الحدودي</th>
              <th>التاريخ</th>
              <th>نوع البضاعة</th>
              <th>الكمية الكلية</th>
              <th>المستقطعة</th>
              <th>المتبقية</th>
              <th>الوحدة</th>
              <th>الحالة</th>
            </tr>
          </thead>
          <tbody>
      `);
      
      exemptions.forEach((cert, index) => {
        const remaining = parseFloat(cert.remainingQuantity) || 0;
        const isExpired = remaining <= 0;
        const rowClass = isExpired ? 'expired' : '';
        const status = isExpired ? 'نافذة ❌' : remaining <= (cert.totalQuantity * 0.1) ? 'قليلة ⚠️' : 'متاحة ✅';
        
        printWindow.document.write(`
          <tr class="${rowClass}">
            <td>${index + 1}${isExpired ? '<span class="expired-label">نافذة</span>' : ''}</td>
            <td>${cert.company}</td>
            <td>${cert.certificateNumber}</td>
            <td>${cert.borderSerial}</td>
            <td>${cert.certificateDate}</td>
            <td>${cert.itemType}</td>
            <td>${cert.totalQuantity}</td>
            <td>${cert.deductedQuantity}</td>
            <td style="${isExpired ? 'color: #f44336; font-weight: bold;' : ''}">${cert.remainingQuantity}</td>
            <td>${cert.unit}</td>
            <td style="${isExpired ? 'color: #f44336; font-weight: bold;' : remaining <= (cert.totalQuantity * 0.1) ? 'color: #ff9800; font-weight: bold;' : 'color: #4caf50; font-weight: bold;'}">${status}</td>
          </tr>
        `);
      });
      
      printWindow.document.write(`
          </tbody>
        </table>
      `);
    }
    
    // قسم الشهادات
    if (certificates.length > 0) {
      printWindow.document.write(`
        <div class="section-header">
          <h4>📋 قسم الشهادات (${certificates.length} شهادة)</h4>
        </div>
        <table class="certificates">
          <thead>
            <tr>
              <th>ت</th>
              <th>اسم الشركة</th>
              <th>رقم الشهادة</th>
              <th>التسلسل الحدودي</th>
              <th>التاريخ</th>
              <th>نوع البضاعة</th>
              <th>الكمية الكلية</th>
              <th>المستقطعة</th>
              <th>المتبقية</th>
              <th>الوحدة</th>
              <th>الحالة</th>
            </tr>
          </thead>
          <tbody>
      `);
      
      certificates.forEach((cert, index) => {
        const remaining = parseFloat(cert.remainingQuantity) || 0;
        const isExpired = remaining <= 0;
        const rowClass = isExpired ? 'expired' : '';
        const status = isExpired ? 'نافذة ❌' : remaining <= (cert.totalQuantity * 0.1) ? 'قليلة ⚠️' : 'متاحة ✅';
        
        printWindow.document.write(`
          <tr class="${rowClass}">
            <td>${index + 1}${isExpired ? '<span class="expired-label">نافذة</span>' : ''}</td>
            <td>${cert.company}</td>
            <td>${cert.certificateNumber}</td>
            <td>${cert.borderSerial}</td>
            <td>${cert.certificateDate}</td>
            <td>${cert.itemType}</td>
            <td>${cert.totalQuantity}</td>
            <td>${cert.deductedQuantity}</td>
            <td style="${isExpired ? 'color: #f44336; font-weight: bold;' : ''}">${cert.remainingQuantity}</td>
            <td>${cert.unit}</td>
            <td style="${isExpired ? 'color: #f44336; font-weight: bold;' : remaining <= (cert.totalQuantity * 0.1) ? 'color: #ff9800; font-weight: bold;' : 'color: #4caf50; font-weight: bold;'}">${status}</td>
          </tr>
        `);
      });
      
      printWindow.document.write(`
          </tbody>
        </table>
      `);
    }
    
    // الإحصائيات والخاتمة
    const totalExemptions = exemptions.length;
    const totalCertificates = certificates.length;
    const expiredExemptions = exemptions.filter(c => (parseFloat(c.remainingQuantity) || 0) <= 0).length;
    const expiredCertificates = certificates.filter(c => (parseFloat(c.remainingQuantity) || 0) <= 0).length;
    
    printWindow.document.write(`
        <div class="footer">
          <h4>🖥️ نظام إدارة الإعفاءات والشهادات - الكمارك العراقية</h4>
          <p><strong>المطور:</strong> احمد عبد القادر مشحن العبيدي</p>
          <p><strong>📧 البريد الإلكتروني:</strong> alobaidymo@gmail.com</p>
          <p><strong>📱 الهاتف:</strong> +9647768525871</p>
          <hr>
          <p><strong>📊 إحصائيات التقرير الشامل:</strong></p>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
            <div>
              <h5>🏛️ الإعفاءات:</h5>
              <p>الإجمالي: ${totalExemptions} | النافذة: ${expiredExemptions} | المتاحة: ${totalExemptions - expiredExemptions}</p>
            </div>
            <div>
              <h5>📋 الشهادات:</h5>
              <p>الإجمالي: ${totalCertificates} | النافذة: ${expiredCertificates} | المتاحة: ${totalCertificates - expiredCertificates}</p>
            </div>
          </div>
          <p><strong>📈 المجموع الكلي:</strong> ${totalExemptions + totalCertificates} وثيقة</p>
          <p style="font-size: 10px; color: #666;">تم إنشاء هذا التقرير تلقائياً بواسطة نظام إدارة الإعفاءات والشهادات المطور بتقنيات حديثة</p>
        </div>
      </body>
      </html>
    `);
    
    printWindow.document.close();
    
    printWindow.onload = () => {
      setTimeout(() => {
        printWindow.print();
      }, 1000);
    };
    
  } catch (error) {
    console.error('Error printing combined report:', error);
    showAlert('❌ خطأ في طباعة التقرير الشامل', 'error');
  }
}

async function updateCertificatesStats() {
  try {
    // حساب إجمالي الإعفاءات من قاعدة البيانات
    const exemptionResponse = await fetch('/api/exemptions');
    const exemptionResult = await exemptionResponse.json();
    const totalExemptions = exemptionResult.success ? exemptionResult.exemptions.length : 0;
    
    // حساب إجمالي الشهادات من قاعدة البيانات
    const certificateResponse = await fetch('/api/certificates');
    const certificateResult = await certificateResponse.json();
    const totalCertificates = certificateResult.success ? certificateResult.certificates.length : 0;
    
    // تحديث العداد في النافذة الرئيسية
    const exemptionsCountElement = document.getElementById('exemptionsCount');
    const certificatesCountElement = document.getElementById('certificatesCount');
    
    if (exemptionsCountElement) exemptionsCountElement.textContent = totalExemptions;
    if (certificatesCountElement) certificatesCountElement.textContent = totalCertificates;
    
    // تحديث إحصائيات النسخ الاحتياطي
    const backupCount = document.getElementById('backupCount');
    if (backupCount) {
      backupCount.textContent = totalExemptions + totalCertificates;
    }
    
    console.log(`إجمالي الإعفاءات: ${totalExemptions}`);
    console.log(`إجمالي الشهادات: ${totalCertificates}`);
    
  } catch (error) {
    console.error('Error updating stats:', error);
    const exemptionsCountElement = document.getElementById('exemptionsCount');
    const certificatesCountElement = document.getElementById('certificatesCount');
    
    if (exemptionsCountElement) exemptionsCountElement.textContent = '❌';
    if (certificatesCountElement) certificatesCountElement.textContent = '❌';
  }
}

// وظائف التعديل والحذف للاعفاءات المحفوظة  
function editExemption(button, id) {
  // البحث في البيانات المحفوظة محلياً أولاً
  let exemptions = JSON.parse(localStorage.getItem('certificates') || '[]');
  let exemption = exemptions.find(item => item.id == id);
  let isLocal = true;
  
  // إذا لم توجد محلياً، جلبها من الخادم
  if (!exemption) {
    isLocal = false;
    fetch('/api/certificates')
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          exemption = result.certificates.find(item => item.id == id);
          if (exemption) {
            showEditExemptionModal(exemption, id, false);
          }
        }
      });
    return;
  }
  
  showEditExemptionModal(exemption, id, true);
}

function showEditExemptionModal(exemption, id, isLocal) {
  
  // ملء نموذج التعديل
  const editModal = document.createElement('div');
  editModal.className = 'modal';
  editModal.style.display = 'block';
  editModal.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <h3 style="color: #002147; text-align: center; margin-bottom: 25px;">✏️ تعديل الإعفاء</h3>
      <form id="editExemptionForm">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label>اسم الشركة:</label>
            <input type="text" id="edit-company" value="${exemption.company || ''}" required>
          </div>
          <div>
            <label>التسلسل الحدودي(c):</label>
            <input type="text" id="edit-borderSerial" value="${exemption.borderSerial || ''}" required>
          </div>
          <div>
            <label>رقم كتاب الاعفاء:</label>
            <input type="text" id="edit-certificateNumber" value="${exemption.certificateNumber || ''}" required>
          </div>
          <div>
            <label>التاريخ:</label>
            <input type="date" id="edit-certificateDate" value="${exemption.certificateDate || ''}" required>
          </div>
          <div>
            <label>الكمية الكلية:</label>
            <input type="number" id="edit-totalQuantity" value="${exemption.totalQuantity || 0}" oninput="updateEditRemaining()" required>
          </div>
          <div>
            <label>الوحدة:</label>
            <select id="edit-unit">
              <option value="طن" ${exemption.unit === 'طن' ? 'selected' : ''}>طن</option>
              <option value="عدد" ${exemption.unit === 'عدد' ? 'selected' : ''}>عدد</option>
            </select>
          </div>
          <div>
            <label>الكمية المستقطعة:</label>
            <input type="number" id="edit-deductedQuantity" value="${exemption.deductedQuantity || 0}" oninput="updateEditRemaining()" required>
          </div>
          <div>
            <label>نوع البضاعة:</label>
            <input type="text" id="edit-itemType" value="${exemption.itemType || ''}" required>
          </div>
        </div>
        <div style="margin-top: 15px;">
          <label>الكمية المتبقية:</label>
          <input type="number" id="edit-remainingQuantity" value="${exemption.remainingQuantity || 0}" readonly>
        </div>
        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
          <button type="submit" class="edit-btn">💾 حفظ التعديلات</button>
          <button type="button" class="delete-btn" onclick="closeEditModal(this)">❌ إلغاء</button>
        </div>
      </form>
    </div>
  `;
  
  document.body.appendChild(editModal);
  
  // معالج إرسال النموذج
  document.getElementById('editExemptionForm').onsubmit = async function(e) {
    e.preventDefault();
    
    const updatedData = {
      company: document.getElementById('edit-company').value,
      borderSerial: document.getElementById('edit-borderSerial').value,
      certificateNumber: document.getElementById('edit-certificateNumber').value,
      certificateDate: document.getElementById('edit-certificateDate').value,
      totalQuantity: parseInt(document.getElementById('edit-totalQuantity').value),
      deductedQuantity: parseInt(document.getElementById('edit-deductedQuantity').value),
      remainingQuantity: parseInt(document.getElementById('edit-remainingQuantity').value),
      itemType: document.getElementById('edit-itemType').value,
      unit: document.getElementById('edit-unit').value
    };
    
    if (isLocal) {
      // التحديث المحلي
      let exemptions = JSON.parse(localStorage.getItem('certificates') || '[]');
      const index = exemptions.findIndex(item => item.id == id);
      if (index !== -1) {
        exemptions[index] = { ...exemptions[index], ...updatedData };
        localStorage.setItem('certificates', JSON.stringify(exemptions));
      }
    } else {
      // التحديث على الخادم
      try {
        const response = await fetch(`/api/certificates/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedData)
        });
        
        const result = await response.json();
        if (!result.success) {
          showAlert('خطأ في تحديث الإعفاء: ' + result.message, 'error');
          return;
        }
      } catch (error) {
        showAlert('خطأ في الاتصال بالخادم', 'error');
        return;
      }
    }
    
    // إغلاق النافذة
    document.body.removeChild(editModal);
    
    // إعادة تحميل العرض
    openModal();
    
    showAlert('تم تعديل الإعفاء بنجاح', 'success');
  };
}

function deleteExemption(button, id) {
  if (confirm('هل أنت متأكد من حذف هذا الإعفاء نهائياً؟\nهذا الإجراء لا يمكن التراجع عنه')) {
    // البحث في البيانات المحلية أولاً
    let exemptions = JSON.parse(localStorage.getItem('certificates') || '[]');
    const localIndex = exemptions.findIndex(item => item.id == id);
    
    if (localIndex !== -1) {
      // حذف محلي
      exemptions.splice(localIndex, 1);
      localStorage.setItem('certificates', JSON.stringify(exemptions));
      openModal();
      showAlert('تم حذف الإعفاء نهائياً', 'success');
    } else {
      // حذف من الخادم
      fetch(`/api/certificates/${id}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            openModal();
            showAlert('تم حذف الإعفاء نهائياً', 'success');
          } else {
            showAlert('خطأ في حذف الإعفاء: ' + result.message, 'error');
          }
        })
        .catch(error => {
          showAlert('خطأ في الاتصال بالخادم', 'error');
        });
    }
  }
}

// وظائف التعديل والحذف للشهادات المحفوظة
// دالة تعديل شهادة من قاعدة البيانات
function editCertificateFromDB(certId) {
  console.log('Editing certificate from database with ID:', certId);
  
  fetch(`/api/certificates/${certId}`)
    .then(response => {
      console.log('Response status:', response.status);
      console.log('Response headers:', response.headers);
      console.log('Response content-type:', response.headers.get('content-type'));
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const contentType = response.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        throw new Error(`Expected JSON response but got: ${contentType}`);
      }
      
      return response.json();
    })
    .then(data => {
      if (data.success) {
        createEditCertificateModalDB(data.certificate, certId);
      } else {
        showAlert('خطأ في تحميل بيانات الشهادة: ' + (data.message || 'خطأ غير معروف'), 'error');
      }
    })
    .catch(error => {
      console.error('Error fetching certificate:', error);
      showAlert('خطأ في الاتصال: ' + error.message, 'error');
    });
}

function editCertificateLocal(certificates, index) {
  
  if (index !== undefined && certificates[index]) {
    // تحضير البيانات للتعديل
    const certificate = certificates[index];
    
    // ملء نموذج التعديل
    const editModal = document.createElement('div');
    editModal.className = 'modal';
    editModal.style.display = 'block';
    editModal.innerHTML = `
      <div class="modal-content" style="max-width: 600px;">
        <h3 style="color: #002147; text-align: center; margin-bottom: 25px;">✏️ تعديل الشهادة</h3>
        <form id="editCertificateForm">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <label>اسم الشركة:</label>
              <input type="text" id="edit-cert-company" value="${certificate.company}" required>
            </div>
            <div>
              <label>التسلسل الحدودي(c):</label>
              <input type="text" id="edit-cert-borderSerial" value="${certificate.borderSerial}" required>
            </div>
            <div>
              <label>رقم الشهادة:</label>
              <input type="text" id="edit-cert-certificateNumber" value="${certificate.certificateNumber}" required>
            </div>
            <div>
              <label>التاريخ:</label>
              <input type="date" id="edit-cert-certificateDate" value="${certificate.certificateDate}" required>
            </div>
            <div>
              <label>الكمية الكلية:</label>
              <input type="number" id="edit-cert-totalQuantity" value="${certificate.totalQuantity}" oninput="updateEditCertRemaining()" required>
            </div>
            <div>
              <label>الوحدة:</label>
              <select id="edit-cert-unit">
                <option value="طن" ${certificate.unit === 'طن' ? 'selected' : ''}>طن</option>
                <option value="عدد" ${certificate.unit === 'عدد' ? 'selected' : ''}>عدد</option>
              </select>
            </div>
            <div>
              <label>الكمية المستقطعه:</label>
              <input type="number" id="edit-cert-deductedQuantity" value="${certificate.deductedQuantity}" oninput="updateEditCertRemaining()" required>
            </div>
            <div>
              <label>نوع البضاعة:</label>
              <input type="text" id="edit-cert-itemType" value="${certificate.itemType}" required>
            </div>
          </div>
          <div style="margin-top: 15px;">
            <label>المتبقي:</label>
            <input type="number" id="edit-cert-remainingQuantity" value="${certificate.remainingQuantity}" readonly>
          </div>
          <div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
            <button type="submit" class="edit-btn">💾 حفظ التعديلات</button>
            <button type="button" class="delete-btn" onclick="closeEditModal(this)">❌ إلغاء</button>
          </div>
        </form>
      </div>
    `;
    
    document.body.appendChild(editModal);
    
    // معالج إرسال النموذج
    document.getElementById('editCertificateForm').onsubmit = function(e) {
      e.preventDefault();
      
      // تحديث البيانات
      certificates[index] = {
        company: document.getElementById('edit-cert-company').value,
        borderSerial: document.getElementById('edit-cert-borderSerial').value,
        certificateNumber: document.getElementById('edit-cert-certificateNumber').value,
        certificateDate: document.getElementById('edit-cert-certificateDate').value,
        totalQuantity: parseInt(document.getElementById('edit-cert-totalQuantity').value),
        deductedQuantity: parseInt(document.getElementById('edit-cert-deductedQuantity').value),
        remainingQuantity: parseInt(document.getElementById('edit-cert-remainingQuantity').value),
        itemType: document.getElementById('edit-cert-itemType').value,
        unit: document.getElementById('edit-cert-unit').value,
        savedAt: certificate.savedAt // الاحتفاظ بتاريخ الحفظ الأصلي
      };
      
      // حفظ التحديثات
      localStorage.setItem('savedCertificates', JSON.stringify(certificates));
      
      // إغلاق النافذة
      document.body.removeChild(editModal);
      
      // إعادة تحميل العرض
      viewCertificates();
      
      showAlert('تم تعديل الشهادة بنجاح', 'success');
    };
  }
}

function deleteCertificate(button, index) {
  if (confirm('هل أنت متأكد من حذف هذه الشهادة نهائياً؟\nهذا الإجراء لا يمكن التراجع عنه')) {
    const certificates = JSON.parse(localStorage.getItem('savedCertificates') || '[]');
    
    if (index !== undefined && certificates[index]) {
      // حذف الشهادة
      certificates.splice(index, 1);
      
      // حفظ التحديثات
      localStorage.setItem('savedCertificates', JSON.stringify(certificates));
      
      // إعادة تحميل العرض
      viewCertificates();
      
      showAlert('تم حذف الشهادة نهائياً', 'success');
    }
  }
}

// دالة تعديل شهادة من قاعدة البيانات
function createEditCertificateModalDB(certificate, certId) {
  const editModal = document.createElement('div');
  editModal.className = 'modal';
  editModal.style.display = 'block';
  editModal.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <h3 style="color: #002147; text-align: center; margin-bottom: 25px;">✏️ تعديل الشهادة</h3>
      <form id="editCertificateFormDB">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label>اسم الشركة:</label>
            <input type="text" id="edit-cert-company-db" value="${certificate.company || ''}" required>
          </div>
          <div>
            <label>التسلسل الحدودي(c):</label>
            <input type="text" id="edit-cert-borderSerial-db" value="${certificate.border_serial || ''}" required>
          </div>
          <div>
            <label>رقم الشهادة:</label>
            <input type="text" id="edit-cert-certificateNumber-db" value="${certificate.certificate_number || ''}" required>
          </div>
          <div>
            <label>التاريخ:</label>
            <input type="date" id="edit-cert-certificateDate-db" value="${certificate.certificate_date || ''}" required>
          </div>
          <div>
            <label>الكمية الكلية:</label>
            <input type="number" id="edit-cert-totalQuantity-db" value="${certificate.total_quantity || 0}" required>
          </div>
          <div>
            <label>الوحدة:</label>
            <select id="edit-cert-unit-db">
              <option value="طن" ${certificate.unit === 'طن' ? 'selected' : ''}>طن</option>
              <option value="عدد" ${certificate.unit === 'عدد' ? 'selected' : ''}>عدد</option>
            </select>
          </div>
          <div>
            <label>الكمية المستقطعة:</label>
            <input type="number" id="edit-cert-deductedQuantity-db" value="${certificate.deducted_quantity || 0}" required>
          </div>
          <div>
            <label>نوع البضاعة:</label>
            <input type="text" id="edit-cert-itemType-db" value="${certificate.item_type || ''}" required>
          </div>
        </div>
        <div style="text-align: center; margin-top: 25px;">
          <button type="button" onclick="updateCertificateDB(${certId})" class="elegant-button">💾 حفظ التعديلات</button>
          <button type="button" onclick="closeEditModalDB()" class="elegant-button secondary">❌ إلغاء</button>
        </div>
      </form>
    </div>
  `;
  
  document.body.appendChild(editModal);
}

// دالة تحديث الشهادة في قاعدة البيانات
function updateCertificateDB(certId) {
  const formData = {
    company: document.getElementById('edit-cert-company-db').value,
    borderSerial: document.getElementById('edit-cert-borderSerial-db').value,
    certificateNumber: document.getElementById('edit-cert-certificateNumber-db').value,
    certificateDate: document.getElementById('edit-cert-certificateDate-db').value,
    totalQuantity: parseFloat(document.getElementById('edit-cert-totalQuantity-db').value),
    unit: document.getElementById('edit-cert-unit-db').value,
    deductedQuantity: parseFloat(document.getElementById('edit-cert-deductedQuantity-db').value),
    itemType: document.getElementById('edit-cert-itemType-db').value
  };
  
  fetch(`/api/certificates/${certId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(formData)
  })
  .then(response => {
    console.log('Update response status:', response.status);
    console.log('Update response content-type:', response.headers.get('content-type'));
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      throw new Error(`Expected JSON response but got: ${contentType}`);
    }
    
    return response.json();
  })
  .then(result => {
    if (result.success) {
      closeEditModalDB();
      loadCertificatesFromDatabase();
      showAlert('تم تعديل الشهادة في قاعدة البيانات بنجاح', 'success');
    } else {
      showAlert('خطأ في تعديل الشهادة: ' + (result.message || 'خطأ غير معروف'), 'error');
    }
  })
  .catch(error => {
    console.error('Error updating certificate:', error);
    showAlert('خطأ في الاتصال: ' + error.message, 'error');
  });
}

function closeEditModalDB() {
  const modal = document.querySelector('.modal');
  if (modal) {
    document.body.removeChild(modal);
  }
}

// دالة تحديث عرض الشهادات من قاعدة البيانات
async function loadCertificatesFromDatabase() {
  try {
    const response = await fetch('/api/certificates');
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const result = await response.json();
    if (result.success) {
      // تحديث عرض الشهادات في الجدول الحالي
      displayExemptions(result.certificates);
      populateExemptionsFilters(result.certificates);
    } else {
      showAlert('خطأ في تحميل الشهادات: ' + (result.message || 'خطأ غير معروف'), 'error');
    }
  } catch (error) {
    console.error('Error loading certificates:', error);
    showAlert('خطأ في الاتصال بقاعدة البيانات: ' + error.message, 'error');
  }
}

// وظائف مساعدة
function updateEditRemaining() {
  const total = parseInt(document.getElementById('edit-totalQuantity').value) || 0;
  const deducted = parseInt(document.getElementById('edit-deductedQuantity').value) || 0;
  document.getElementById('edit-remainingQuantity').value = total - deducted;
}

function updateEditCertRemaining() {
  const total = parseInt(document.getElementById('edit-cert-totalQuantity').value) || 0;
  const deducted = parseInt(document.getElementById('edit-cert-deductedQuantity').value) || 0;
  document.getElementById('edit-cert-remainingQuantity').value = total - deducted;
}

function closeEditModal(button) {
  const modal = button.closest('.modal');
  if (modal) {
    document.body.removeChild(modal);
  }
}

function closeSavedCertificatesModal() {
  document.getElementById('savedCertificatesModal').style.display = 'none';
}

// تعديل وحذف الشهادات المحفوظة محلياً
function editCertificate(button, index) {
  const savedCertificates = JSON.parse(localStorage.getItem('savedCertificates') || '[]');
  
  if (index !== undefined && savedCertificates[index]) {
    const certificate = savedCertificates[index];
    
    // ملء نموذج التعديل
    const editModal = document.createElement('div');
    editModal.className = 'modal';
    editModal.style.display = 'block';
    editModal.innerHTML = `
      <div class="modal-content" style="max-width: 600px;">
        <h3 style="color: #002147; text-align: center; margin-bottom: 25px;">✏️ تعديل الشهادة</h3>
        <form id="editCertificateForm">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <label>اسم الشركة:</label>
              <input type="text" id="edit-cert-company" value="${certificate.company || ''}" required>
            </div>
            <div>
              <label>التسلسل الحدودي(c):</label>
              <input type="text" id="edit-cert-borderSerial" value="${certificate.borderSerial || ''}" required>
            </div>
            <div>
              <label>رقم الشهادة:</label>
              <input type="text" id="edit-cert-certificateNumber" value="${certificate.certificateNumber || ''}" required>
            </div>
            <div>
              <label>التاريخ:</label>
              <input type="date" id="edit-cert-certificateDate" value="${certificate.certificateDate || ''}" required>
            </div>
            <div>
              <label>الكمية الكلية:</label>
              <input type="number" id="edit-cert-totalQuantity" value="${certificate.totalQuantity || 0}" oninput="updateEditCertRemaining()" required>
            </div>
            <div>
              <label>الوحدة:</label>
              <select id="edit-cert-unit">
                <option value="طن" ${certificate.unit === 'طن' ? 'selected' : ''}>طن</option>
                <option value="عدد" ${certificate.unit === 'عدد' ? 'selected' : ''}>عدد</option>
              </select>
            </div>
            <div>
              <label>الكمية المستقطعه:</label>
              <input type="number" id="edit-cert-deductedQuantity" value="${certificate.deductedQuantity || 0}" oninput="updateEditCertRemaining()" required>
            </div>
            <div>
              <label>نوع البضاعة:</label>
              <input type="text" id="edit-cert-itemType" value="${certificate.itemType || ''}" required>
            </div>
          </div>
          <div style="margin-top: 15px;">
            <label>المتبقي:</label>
            <input type="number" id="edit-cert-remainingQuantity" value="${certificate.remainingQuantity || 0}" readonly>
          </div>
          <div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
            <button type="submit" class="edit-btn">💾 حفظ التعديلات</button>
            <button type="button" class="delete-btn" onclick="closeEditModal(this)">❌ إلغاء</button>
          </div>
        </form>
      </div>
    `;
    
    document.body.appendChild(editModal);
    
    // معالج إرسال النموذج
    document.getElementById('editCertificateForm').onsubmit = function(e) {
      e.preventDefault();
      
      // تحديث البيانات
      savedCertificates[index] = {
        company: document.getElementById('edit-cert-company').value,
        borderSerial: document.getElementById('edit-cert-borderSerial').value,
        certificateNumber: document.getElementById('edit-cert-certificateNumber').value,
        certificateDate: document.getElementById('edit-cert-certificateDate').value,
        totalQuantity: parseInt(document.getElementById('edit-cert-totalQuantity').value),
        deductedQuantity: parseInt(document.getElementById('edit-cert-deductedQuantity').value),
        remainingQuantity: parseInt(document.getElementById('edit-cert-remainingQuantity').value),
        itemType: document.getElementById('edit-cert-itemType').value,
        unit: document.getElementById('edit-cert-unit').value,
        savedAt: certificate.savedAt // الاحتفاظ بتاريخ الحفظ الأصلي
      };
      
      // حفظ التحديثات
      localStorage.setItem('savedCertificates', JSON.stringify(savedCertificates));
      
      // إغلاق النافذة
      document.body.removeChild(editModal);
      
      // إعادة تحميل العرض
      viewCertificates();
      
      showAlert('تم تعديل الشهادة بنجاح', 'success');
    };
  }
}

async function deleteCertificate(certificateId) {
  if (confirm('هل أنت متأكد من حذف هذه الشهادة نهائياً؟\nهذا الإجراء لا يمكن التراجع عنه')) {
    try {
      const response = await fetch(`/api/certificates/${certificateId}`, {
        method: 'DELETE'
      });
      
      const result = await response.json();
      
      if (result.success) {
        showAlert('✅ تم حذف الشهادة نهائياً من قاعدة البيانات', 'success');
        
        // إعادة تحميل العرض
        if (typeof renderCertificates === 'function') {
          renderCertificates();
        }
        if (typeof viewCertificates === 'function') {
          viewCertificates();
        }
        
        // تحديث الإحصائيات
        updateCertificatesStats();
      } else {
        showAlert(`❌ خطأ في حذف الشهادة: ${result.message}`, 'error');
      }
    } catch (error) {
      console.error('Error deleting certificate:', error);
      showAlert('❌ خطأ في الاتصال بقاعدة البيانات', 'error');
    }
  }
}

function updateEditCertRemaining() {
  const total = parseInt(document.getElementById('edit-cert-totalQuantity').value) || 0;
  const deducted = parseInt(document.getElementById('edit-cert-deductedQuantity').value) || 0;
  document.getElementById('edit-cert-remainingQuantity').value = total - deducted;
}



// دالة الحصول على بيانات النموذج للإعفاءات
function getCertificateData() {
  // جمع البيانات من النموذج
  const company = document.getElementById('company')?.value?.trim();
  const borderSerial = document.getElementById('borderSerial')?.value?.trim();
  const certificateNumber = document.getElementById('certificateNumber')?.value?.trim();
  const certificateDate = document.getElementById('certificateDate')?.value;
  const totalQuantity = document.getElementById('totalQuantity')?.value;
  const deductedQuantity = document.getElementById('deductedQuantity')?.value || '0';
  const unit = document.getElementById('unit')?.value?.trim();
  const itemType = document.getElementById('itemType')?.value?.trim();

  // التحقق من البيانات المطلوبة
  if (!company || !borderSerial || !certificateNumber || !totalQuantity || !itemType) {
    alert('يرجى ملء جميع الحقول المطلوبة');
    return null;
  }

  if (parseFloat(totalQuantity) <= 0) {
    alert('الكمية الكلية يجب أن تكون أكبر من صفر');
    return null;
  }

  return {
    company,
    borderSerial,
    certificateNumber,
    certificateDate: certificateDate || new Date().toISOString().split('T')[0],
    totalQuantity: parseFloat(totalQuantity),
    deductedQuantity: parseFloat(deductedQuantity),
    unit: unit || 'طن',
    itemType
  };
}

// دالة الحصول على بيانات النموذج للشهادات
function getCertificateDataDocuments() {
  // جمع البيانات من نموذج الشهادات
  const company = document.getElementById('cert-company')?.value?.trim();
  const borderSerial = document.getElementById('cert-borderSerial')?.value?.trim();
  const certificateNumber = document.getElementById('cert-certificateNumber')?.value?.trim();
  const certificateDate = document.getElementById('cert-certificateDate')?.value;
  const totalQuantity = document.getElementById('cert-totalQuantity')?.value;
  const deductedQuantity = document.getElementById('cert-deductedQuantity')?.value || '0';
  const unit = document.getElementById('cert-unit')?.value?.trim();
  const itemType = document.getElementById('cert-itemType')?.value?.trim();

  // التحقق من البيانات المطلوبة
  if (!company || !borderSerial || !certificateNumber || !totalQuantity || !itemType) {
    alert('يرجى ملء جميع الحقول المطلوبة');
    return null;
  }

  if (parseFloat(totalQuantity) <= 0) {
    alert('الكمية الكلية يجب أن تكون أكبر من صفر');
    return null;
  }

  return {
    company,
    borderSerial,
    certificateNumber,
    certificateDate: certificateDate || new Date().toISOString().split('T')[0],
    totalQuantity: parseFloat(totalQuantity),
    deductedQuantity: parseFloat(deductedQuantity),
    unit: unit || 'طن',
    itemType
  };
}

// دالة مسح النموذج للإعفاءات
function clearForm() {
  const fields = ['company', 'borderSerial', 'certificateNumber', 'certificateDate', 
                  'totalQuantity', 'deductedQuantity', 'itemType'];
  
  fields.forEach(field => {
    const element = document.getElementById(field);
    if (element) {
      element.value = '';
    }
  });
  
  const unitElement = document.getElementById('unit');
  if (unitElement) {
    unitElement.value = 'طن';
  }
  
  // إزالة حالة التعديل
  window.editingExemptionId = null;
  
  // تحديث الكمية المتبقية
  updateRemaining();
}

// دالة مسح النموذج للشهادات
function clearCertForm() {
  const fields = ['cert-company', 'cert-borderSerial', 'cert-certificateNumber', 
                  'cert-certificateDate', 'cert-totalQuantity', 'cert-deductedQuantity', 
                  'cert-itemType'];
  
  fields.forEach(field => {
    const element = document.getElementById(field);
    if (element) {
      element.value = '';
    }
  });
  
  const unitElement = document.getElementById('cert-unit');
  if (unitElement) {
    unitElement.value = 'طن';
  }
  
  // إزالة حالة التعديل
  window.editingCertificateId = null;
  
  // تحديث الكمية المتبقية
  updateRemainingCert();
}

// دالة إظهار رسالة نجاح
function showSuccessMessage(message) {
  // إنشاء عنصر التنبيه
  const alertDiv = document.createElement('div');
  alertDiv.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    color: #155724;
    padding: 15px 20px;
    border-radius: 8px;
    border: 2px solid #28a745;
    font-size: 16px;
    font-weight: bold;
    z-index: 10000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  `;
  alertDiv.textContent = message;
  
  document.body.appendChild(alertDiv);
  
  // إزالة التنبيه بعد 3 ثوان
  setTimeout(() => {
    if (alertDiv.parentNode) {
      alertDiv.parentNode.removeChild(alertDiv);
    }
  }, 3000);
}

// دالة إظهار رسالة خطأ
function showErrorMessage(message) {
  // إنشاء عنصر التنبيه
  const alertDiv = document.createElement('div');
  alertDiv.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #f8d7da, #f1b0b7);
    color: #721c24;
    padding: 15px 20px;
    border-radius: 8px;
    border: 2px solid #dc3545;
    font-size: 16px;
    font-weight: bold;
    z-index: 10000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  `;
  alertDiv.textContent = message;
  
  document.body.appendChild(alertDiv);
  
  // إزالة التنبيه بعد 5 ثوان
  setTimeout(() => {
    if (alertDiv.parentNode) {
      alertDiv.parentNode.removeChild(alertDiv);
    }
  }, 5000);
}

// دالة حفظ الإعفاء (مع قاعدة البيانات والتعديل)
async function saveCertificate() {
  const certificateData = getCertificateData();
  
  if (!certificateData) {
    return; // خطأ في التحقق من البيانات
  }

  try {
    let response, method, url;
    
    // التحقق من وجود ID للتعديل
    if (window.editingExemptionId) {
      // تعديل إعفاء موجود
      method = 'PUT';
      url = `/api/exemptions/${window.editingExemptionId}`;
    } else {
      // إضافة إعفاء جديد
      method = 'POST';
      url = '/api/exemptions';
    }
    
    // إرسال البيانات إلى API
    response = await fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(certificateData)
    });

    const result = await response.json();

    if (result.success) {
      // إظهار رسالة نجاح
      const message = window.editingExemptionId ? 
        '✅ تم تعديل الإعفاء بنجاح' : 
        '✅ تم حفظ الإعفاء بنجاح في قاعدة البيانات';
      showSuccessMessage(message);
      
      // مسح النموذج وإعادة تعيين حالة التعديل
      clearForm();
      window.editingExemptionId = null;
      
      // تحديث العرض والإحصائيات
      await loadAndDisplayData();
      updateStats();
    } else {
      throw new Error(result.message || 'خطأ في حفظ البيانات');
    }
  } catch (error) {
    console.error('Error saving exemption:', error);
    showErrorMessage('❌ خطأ في حفظ الإعفاء: ' + error.message);
  }
}

// دالة حفظ الشهادة (مع قاعدة البيانات والتعديل)
async function saveCertDocument() {
  const certificateData = getCertificateDataDocuments();
  
  if (!certificateData) {
    return; // خطأ في التحقق من البيانات
  }

  try {
    let response, method, url;
    
    // التحقق من وجود ID للتعديل
    if (window.editingCertificateId) {
      // تعديل شهادة موجودة
      method = 'PUT';
      url = `/api/certificates/${window.editingCertificateId}`;
    } else {
      // إضافة شهادة جديدة
      method = 'POST';
      url = '/api/certificates';
    }
    
    // إرسال البيانات إلى API
    response = await fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(certificateData)
    });

    const result = await response.json();

    if (result.success) {
      // إظهار رسالة نجاح
      const message = window.editingCertificateId ? 
        '✅ تم تعديل الشهادة بنجاح' : 
        '✅ تم حفظ الشهادة بنجاح في قاعدة البيانات';
      showSuccessMessage(message);
      
      // مسح النموذج وإعادة تعيين حالة التعديل
      clearCertForm();
      window.editingCertificateId = null;
      
      // تحديث العرض والإحصائيات
      await loadAndDisplayCertificates();
      updateStats();
    } else {
      throw new Error(result.message || 'خطأ في حفظ البيانات');
    }
  } catch (error) {
    console.error('Error saving certificate:', error);
    showErrorMessage('❌ خطأ في حفظ الشهادة: ' + error.message);
  }
}

// دالة الحصول على بيانات الإعفاءات من قاعدة البيانات
async function getExemptions() {
  try {
    const response = await fetch('/api/exemptions');
    const result = await response.json();
    if (result.success) {
      return result.exemptions;
    }
    console.error('Error fetching exemptions:', result.message);
    return [];
  } catch (error) {
    console.error('Error fetching exemptions:', error);
    // استخدام localStorage كنسخة احتياطية
    const stored = localStorage.getItem('exemptions');
    return stored ? JSON.parse(stored) : [];
  }
}

// دالة الحصول على بيانات الشهادات من قاعدة البيانات
async function getCertificates() {
  try {
    const response = await fetch('/api/certificates');
    const result = await response.json();
    if (result.success) {
      return result.certificates;
    }
    console.error('Error fetching certificates:', result.message);
    return [];
  } catch (error) {
    console.error('Error fetching certificates:', error);
    // استخدام localStorage كنسخة احتياطية للشهادات فقط
    const stored = localStorage.getItem('certificates');
    return stored ? JSON.parse(stored) : [];
  }
}

// دالة الاستعلام السريع للهاتف
// تم حذف دالة البحث السريع للشهادات - النظام يركز فقط على الإعفاءات

// دالة عرض نتيجة البحث للهاتف
function displayMobileResult(item, type) {
  const resultDiv = document.getElementById("mobileSearchResult");
  const isExpired = parseFloat(item.remainingQuantity) <= 0;
  const lastUpdate = item.updatedAt || item.savedAt || new Date().toLocaleDateString("en-GB", {year: "numeric", month: "2-digit", day: "2-digit"});
  
  const statusClass = isExpired ? "mobile-status-expired" : "mobile-status-available";
  const statusText = isExpired ? "🔴 منتهية/مستنفذة" : "🟢 متاحة";
  const typeText = type === "exemption" ? "إعفاء كمركي" : "شهادة";
  
  resultDiv.innerHTML = `
    <div class="mobile-result-card">
      <div class="mobile-inquiry-header" style="font-size: 24px; margin-bottom: 20px;">
        📋 ${typeText} رقم: ${item.certificateNumber}
      </div>
      
      <div class="${statusClass}">
        ${statusText}
      </div>
      
      <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 15px 0;">
        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e9ecef;">
          <span style="font-weight: 800; color: #002147;">الشركة:</span>
          <span style="color: #2c3e50;">${item.company}</span>
        </div>
        
        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e9ecef;">
          <span style="font-weight: 800; color: #002147;">التسلسل الحدودي:</span>
          <span style="color: #2c3e50;">${item.borderSerial}</span>
        </div>
        
        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e9ecef;">
          <span style="font-weight: 800; color: #002147;">نوع البضاعة:</span>
          <span style="color: #2c3e50;">${item.itemType}</span>
        </div>
        
        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e9ecef;">
          <span style="font-weight: 800; color: #002147;">الكمية الكلية:</span>
          <span style="color: #2c3e50;">${item.totalQuantity} ${item.unit}</span>
        </div>
        
        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e9ecef;">
          <span style="font-weight: 800; color: #002147;">المستقطع:</span>
          <span style="color: #dc3545;">${item.deductedQuantity} ${item.unit}</span>
        </div>
        
        <div style="display: flex; justify-content: space-between; padding: 10px 0;">
          <span style="font-weight: 800; color: #002147;">المتبقي:</span>
          <span style="color: ${isExpired ? "#dc3545" : "#28a745"}; font-weight: 900;">
            ${item.remainingQuantity} ${item.unit}
          </span>
        </div>
      </div>
      
      <div style="background: linear-gradient(135deg, #ff6b35, #f7931e); color: #ffffff; padding: 20px; border-radius: 15px; text-align: center; font-size: 20px; font-weight: 800; border: 3px solid #e65100; box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);">
        🗓️ آخر استقطاع تم في: ${item.lastDeductionDate || lastUpdate}
      </div>
      ${item.wasModified ? `<div style="background: linear-gradient(135deg, #dc3545, #c82333); color: #ffffff; padding: 15px; border-radius: 10px; text-align: center; font-size: 16px; font-weight: 700; border: 2px solid #bd2130; box-shadow: 0 3px 10px rgba(220, 53, 69, 0.3); margin: 10px 0;"><strong>✏️ تم التعديل على هذه الوثيقة بتاريخ:</strong> ${item.lastModificationDate}</div>` : ''}
      
      <div style="background: linear-gradient(135deg, #28a745, #20c997); color: #ffffff; padding: 18px; border-radius: 12px; text-align: center; font-size: 18px; font-weight: 800; border: 3px solid #1e7e34; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4); margin: 15px 0; animation: pulse 2s infinite;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
          <span style="font-size: 22px;">⚠️</span>
          <strong>المتبقي بعد آخر استقطاع بتاريخ ${item.lastDeductionDate || lastUpdate}:</strong>
        </div>
        <div style="font-size: 24px; font-weight: 900; margin-top: 8px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
          ${item.remainingQuantity || (item.totalQuantity - item.deductedQuantity)} ${item.unit}
        </div>
      </div>
      
      <div style="background: linear-gradient(135deg, #dc3545, #c82333, #007bff); color: #ffffff; padding: 25px; border-radius: 15px; text-align: center; border: 4px solid #bd2130; box-shadow: 0 8px 25px rgba(220, 53, 69, 0.6); margin: 20px 0; animation: pulse 2s infinite; position: relative; overflow: hidden;">
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.1) 50%, transparent 60%); animation: shine 3s infinite;"></div>
        <div style="position: relative; z-index: 2;">
          <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px; opacity: 0.9;">
            الرقم النهائي للكمية المتبقية
          </div>
          <div style="font-size: 48px; font-weight: 900; text-shadow: 0 4px 8px rgba(0,0,0,0.5); letter-spacing: 2px; color: #ffff00;">
            ${item.remainingQuantity || (item.totalQuantity - item.deductedQuantity)}
          </div>
          <div style="font-size: 28px; font-weight: 800; margin-top: 5px; color: #ffffff;">
            ${item.unit}
          </div>
        </div>
      </div>
      
      <button onclick="hideMobileResult()" style="width: 100%; margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #6c757d, #5a6268); color: white; border: none; border-radius: 10px; font-size: 20px; font-weight: 700;">
        إغلاق النتيجة
      </button>
    </div>
  `;
}

// دالة إخفاء نتيجة البحث
function hideMobileResult() {
  document.getElementById("mobileSearchResult").style.display = "none";
  document.getElementById("mobileSearchInput").value = "";
}

// دالة تحديث الإحصائيات
async function updateStats() {
  try {
    const exemptions = await getExemptions();
    const certificates = await getCertificates();
    
    console.log(`إجمالي الإعفاءات: ${exemptions.length}`);
    console.log(`إجمالي الشهادات: ${certificates.length}`);
    
    // يمكن إضافة المزيد من الإحصائيات هنا لاحقاً
    const totalExemptions = exemptions.length;
    const totalCertificates = certificates.length;
    
    // تحديث العناصر في الواجهة إذا كانت موجودة
    const statsElement = document.getElementById('stats-display');
    if (statsElement) {
      statsElement.innerHTML = `
        الإعفاءات: ${totalExemptions} | الشهادات: ${totalCertificates}
      `;
    }
  } catch (error) {
    console.error('خطأ في تحديث الإحصائيات:', error);
  }
}

// دالة حذف جميع البيانات
async function clearAllData() {
  if (confirm('هل أنت متأكد من حذف جميع البيانات؟ هذا الإجراء لا يمكن التراجع عنه!')) {
    try {
      // حذف البيانات من localStorage أولاً
      localStorage.removeItem('exemptions');
      localStorage.removeItem('certificates');
      
      // حذف الإعفاءات من قاعدة البيانات
      const exemptions = await getExemptions();
      for (const exemption of exemptions) {
        await fetch(`/api/exemptions/${exemption.id}`, {
          method: 'DELETE'
        });
      }
      
      // حذف الشهادات من قاعدة البيانات
      const certificates = await getCertificates();
      for (const certificate of certificates) {
        await fetch(`/api/certificates/${certificate.id}`, {
          method: 'DELETE'
        });
      }
      
      alert('تم حذف جميع البيانات بنجاح!');
      updateStats();
      
      // إعادة تحميل الصفحة لتنظيف العرض
      location.reload();
      
    } catch (error) {
      console.error('خطأ في حذف البيانات:', error);
      alert('حدث خطأ أثناء حذف البيانات: ' + error.message);
    }
  }
}

// دالة تحديث عرض البيانات للإعفاءات - نفس تنسيق الشهادات الأصلي
async function loadAndDisplayData() {
  try {
    const exemptions = await getExemptions();
    
    // تحديث الجدول الموجود في المودال
    const certificatesList = document.getElementById('certificatesList');
    
    if (certificatesList) {
      if (exemptions.length === 0) {
        certificatesList.innerHTML = `
          <tr>
            <td colspan="11" class="no-data-cell">لا توجد إعفاءات محفوظة</td>
          </tr>
        `;
      } else {
        certificatesList.innerHTML = exemptions.map((exemption, index) => {
          const isExpired = parseFloat(exemption.remainingQuantity) <= 0;
          const statusClass = isExpired ? 'expired-row' : 'active-row';
          
          return `
            <tr class="${statusClass}">
              <td>${exemption.company}</td>
              <td>${exemption.certificateNumber}</td>
              <td>${exemption.borderSerial}</td>
              <td>${exemption.certificateDate}</td>
              <td>${exemption.itemType}</td>
              <td>${exemption.totalQuantity}</td>
              <td>${exemption.deductedQuantity}</td>
              <td class="${isExpired ? 'expired-quantity' : 'available-quantity'}">${exemption.remainingQuantity}</td>
              <td>${exemption.unit}</td>
              <td>${exemption.savedAt ? new Date(exemption.savedAt).toLocaleDateString("en-GB", {year: "numeric", month: "2-digit", day: "2-digit"}) : 'غير محدد'}</td>
              <td class="actions-cell">
                <button onclick="editExemption(${exemption.id})" class="table-edit-btn" title="تعديل">✏️</button>
                <button onclick="deleteExemption(${exemption.id})" class="table-delete-btn" title="حذف">🗑️</button>
              </td>
            </tr>
          `;
        }).join('');
      }
    }
    
    // تحديث أي عناصر أخرى إذا كانت موجودة
    const modalBody = document.getElementById('modalBody');
    const displayArea = document.getElementById('dataDisplay');
    
    if (modalBody && !certificatesList) {
      // إذا لم يوجد الجدول، أنشئ واحد
      let html = '';
      if (exemptions.length === 0) {
        html = '<p class="no-data">لا توجد إعفاءات محفوظة</p>';
      } else {
        html = `
          <table class="styled-table">
            <thead>
              <tr>
                <th>اسم الشركة</th>
                <th>رقم كتاب الاعفاء</th>
                <th>التسلسل الحدودي</th>
                <th>التاريخ</th>
                <th>نوع البضاعة</th>
                <th>الكمية الكلية</th>
                <th>المستقطعة</th>
                <th>المتبقية</th>
                <th>الوحدة</th>
                <th>تاريخ ووقت الحفظ</th>
                <th>العمليات</th>
              </tr>
            </thead>
            <tbody>
              ${exemptions.map(exemption => {
                const isExpired = parseFloat(exemption.remainingQuantity) <= 0;
                return `
                  <tr class="${isExpired ? 'expired-row' : 'active-row'}">
                    <td>${exemption.company}</td>
                    <td>${exemption.certificateNumber}</td>
                    <td>${exemption.borderSerial}</td>
                    <td>${exemption.certificateDate}</td>
                    <td>${exemption.itemType}</td>
                    <td>${exemption.totalQuantity}</td>
                    <td>${exemption.deductedQuantity}</td>
                    <td class="${isExpired ? 'expired-quantity' : 'available-quantity'}">${exemption.remainingQuantity}</td>
                    <td>${exemption.unit}</td>
                    <td>${exemption.savedAt ? new Date(exemption.savedAt).toLocaleDateString("en-GB", {year: "numeric", month: "2-digit", day: "2-digit"}) : 'غير محدد'}</td>
                    <td>
                      <button onclick="editExemption(${exemption.id})" class="table-edit-btn">✏️</button>
                      <button onclick="deleteExemption(${exemption.id})" class="table-delete-btn">🗑️</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
      }
      modalBody.innerHTML = html;
    }
    
  } catch (error) {
    console.error('خطأ في تحديث العرض:', error);
  }
}

// دالة تحديث عرض البيانات للشهادات - نفس التنسيق الأصلي
async function loadAndDisplayCertificates() {
  try {
    const certificates = await getCertificates();
    
    // تحديث الجدول الموجود في المودال
    const savedCertificatesList = document.getElementById('savedCertificatesList');
    
    if (savedCertificatesList) {
      if (certificates.length === 0) {
        savedCertificatesList.innerHTML = `
          <tr>
            <td colspan="11" class="no-data-cell">لا توجد شهادات محفوظة</td>
          </tr>
        `;
      } else {
        savedCertificatesList.innerHTML = certificates.map((certificate, index) => {
          const isExpired = parseFloat(certificate.remainingQuantity) <= 0;
          const statusClass = isExpired ? 'expired-row' : 'active-row';
          
          return `
            <tr class="${statusClass}">
              <td>${certificate.company}</td>
              <td>${certificate.certificateNumber}</td>
              <td>${certificate.borderSerial}</td>
              <td>${certificate.certificateDate}</td>
              <td>${certificate.itemType}</td>
              <td>${certificate.totalQuantity}</td>
              <td>${certificate.deductedQuantity}</td>
              <td class="${isExpired ? 'expired-quantity' : 'available-quantity'}">${certificate.remainingQuantity}</td>
              <td>${certificate.unit}</td>
              <td>${certificate.savedAt ? new Date(certificate.savedAt).toLocaleDateString("en-GB", {year: "numeric", month: "2-digit", day: "2-digit"}) : 'غير محدد'}</td>
              <td class="actions-cell">
                <button onclick="editCertificate(${certificate.id})" class="table-edit-btn" title="تعديل">✏️</button>
                <button onclick="deleteCertificate(${certificate.id})" class="table-delete-btn" title="حذف">🗑️</button>
              </td>
            </tr>
          `;
        }).join('');
      }
    }
    
    // تحديث أي عناصر أخرى إذا كانت موجودة
    const modalBody = document.getElementById('certModalBody');
    const displayArea = document.getElementById('certDataDisplay');
    
    if (modalBody && !savedCertificatesList) {
      // إذا لم يوجد الجدول، أنشئ واحد
      let html = '';
      if (certificates.length === 0) {
        html = '<p class="no-data">لا توجد شهادات محفوظة</p>';
      } else {
        html = `
          <table class="styled-table">
            <thead>
              <tr>
                <th>اسم الشركة</th>
                <th>رقم الشهادة</th>
                <th>التسلسل الحدودي</th>
                <th>التاريخ</th>
                <th>نوع البضاعة</th>
                <th>الكمية الكلية</th>
                <th>المستقطعه</th>
                <th>المتبقي</th>
                <th>الوحدة</th>
                <th>تاريخ ووقت الحفظ</th>
                <th>العمليات</th>
              </tr>
            </thead>
            <tbody>
              ${certificates.map(certificate => {
                const isExpired = parseFloat(certificate.remainingQuantity) <= 0;
                return `
                  <tr class="${isExpired ? 'expired-row' : 'active-row'}">
                    <td>${certificate.company}</td>
                    <td>${certificate.certificateNumber}</td>
                    <td>${certificate.borderSerial}</td>
                    <td>${certificate.certificateDate}</td>
                    <td>${certificate.itemType}</td>
                    <td>${certificate.totalQuantity}</td>
                    <td>${certificate.deductedQuantity}</td>
                    <td class="${isExpired ? 'expired-quantity' : 'available-quantity'}">${certificate.remainingQuantity}</td>
                    <td>${certificate.unit}</td>
                    <td>${certificate.savedAt ? new Date(certificate.savedAt).toLocaleDateString("en-GB", {year: "numeric", month: "2-digit", day: "2-digit"}) : 'غير محدد'}</td>
                    <td>
                      <button onclick="editCertificate(${certificate.id})" class="table-edit-btn">✏️</button>
                      <button onclick="deleteCertificate(${certificate.id})" class="table-delete-btn">🗑️</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
      }
      modalBody.innerHTML = html;
    }
    
  } catch (error) {
    console.error('خطأ في تحديث عرض الشهادات:', error);
  }
}

// دوال التعديل والحذف للإعفاءات
async function editExemption(id) {
  try {
    // جلب بيانات الإعفاء
    const response = await fetch(`/api/exemptions/${id}`);
    const result = await response.json();
    
    if (result.success) {
      const exemption = result.exemption;
      
      // ملء النموذج بالبيانات الحالية
      document.getElementById('company').value = exemption.company;
      document.getElementById('borderSerial').value = exemption.borderSerial;
      document.getElementById('certificateNumber').value = exemption.certificateNumber;
      document.getElementById('certificateDate').value = exemption.certificateDate;
      document.getElementById('totalQuantity').value = exemption.totalQuantity;
      document.getElementById('deductedQuantity').value = exemption.deductedQuantity;
      document.getElementById('unit').value = exemption.unit;
      document.getElementById('itemType').value = exemption.itemType;
      
      // حساب الكمية المتبقية
      updateRemaining();
      
      // إغلاق المودال
      closeModal();
      
      // إظهار رسالة للمستخدم
      showSuccessMessage('تم تحميل بيانات الإعفاء للتعديل. قم بتعديل البيانات ثم اضغط حفظ.');
      
      // حفظ ID للتعديل
      window.editingExemptionId = id;
      
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    showErrorMessage('خطأ في تحميل بيانات الإعفاء: ' + error.message);
  }
}

async function deleteExemption(id) {
  if (confirm('هل أنت متأكد من حذف هذا الإعفاء؟\nهذا الإجراء لا يمكن التراجع عنه!')) {
    try {
      const response = await fetch(`/api/exemptions/${id}`, {
        method: 'DELETE'
      });
      
      const result = await response.json();
      
      if (result.success) {
        showSuccessMessage('✅ تم حذف الإعفاء بنجاح');
        await loadAndDisplayData();
        updateStats();
      } else {
        throw new Error(result.message);
      }
    } catch (error) {
      showErrorMessage('❌ خطأ في حذف الإعفاء: ' + error.message);
    }
  }
}

// دوال التعديل والحذف للشهادات
async function editCertificate(id) {
  try {
    // جلب بيانات الشهادة
    const response = await fetch(`/api/certificates/${id}`);
    const result = await response.json();
    
    if (result.success) {
      const certificate = result.certificate;
      
      // تحديد ما إذا كنا نستخدم النموذج المحمول أم الجدول
      const isMobile = window.innerWidth <= 768;
      
      if (isMobile) {
        // ملء النموذج المحمول
        document.getElementById('certCompany-mobile').value = certificate.company;
        document.getElementById('certBorderSerial-mobile').value = certificate.borderSerial;
        document.getElementById('certCertificateNumber-mobile').value = certificate.certificateNumber;
        document.getElementById('certCertificateDate-mobile').value = certificate.certificateDate;
        document.getElementById('certTotalQuantity-mobile').value = certificate.totalQuantity;
        document.getElementById('certDeductedQuantity-mobile').value = certificate.deductedQuantity;
        document.getElementById('certUnit-mobile').value = certificate.unit;
        document.getElementById('certItemType-mobile').value = certificate.itemType;
        updateCertRemainingMobile();
      } else {
        // ملء الجدول
        document.getElementById('certCompany').value = certificate.company;
        document.getElementById('certBorderSerial').value = certificate.borderSerial;
        document.getElementById('certCertificateNumber').value = certificate.certificateNumber;
        document.getElementById('certCertificateDate').value = certificate.certificateDate;
        document.getElementById('certTotalQuantity').value = certificate.totalQuantity;
        document.getElementById('certDeductedQuantity').value = certificate.deductedQuantity;
        document.getElementById('certUnit').value = certificate.unit;
        document.getElementById('certItemType').value = certificate.itemType;
        updateCertRemaining();
      }
      
      // إغلاق المودال
      closeSavedCertificatesModal();
      
      // إظهار رسالة للمستخدم
      showSuccessMessage('تم تحميل بيانات الشهادة للتعديل. قم بتعديل البيانات ثم اضغط حفظ.');
      
      // حفظ ID للتعديل
      window.editingCertificateId = id;
      
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    showErrorMessage('خطأ في تحميل بيانات الشهادة: ' + error.message);
  }
}

async function deleteCertificate(id) {
  if (confirm('هل أنت متأكد من حذف هذه الشهادة؟\nهذا الإجراء لا يمكن التراجع عنه!')) {
    try {
      const response = await fetch(`/api/certificates/${id}`, {
        method: 'DELETE'
      });
      
      const result = await response.json();
      
      if (result.success) {
        showSuccessMessage('✅ تم حذف الشهادة بنجاح');
        await loadAndDisplayCertificates();
        updateStats();
      } else {
        throw new Error(result.message);
      }
    } catch (error) {
      showErrorMessage('❌ خطأ في حذف الشهادة: ' + error.message);
    }
  }
}

// دالة فتح المودال مع تحديث البيانات
async function openModal() {
  console.log('فتح مودال الإعفاءات...');
  
  try {
    await loadAndDisplayData();
    
    // البحث عن المودال بأسماء مختلفة
    let modal = document.getElementById('dataModal');
    if (!modal) {
      modal = document.getElementById('certificatesModal');
    }
    if (!modal) {
      modal = document.getElementById('exemptionsModal');
    }
    
    if (modal) {
      modal.style.display = 'block';
      console.log('تم فتح المودال بنجاح');
    } else {
      console.error('لم يتم العثور على المودال');
      alert('خطأ: لم يتم العثور على نافذة العرض');
    }
  } catch (error) {
    console.error('خطأ في فتح المودال:', error);
    alert('حدث خطأ في فتح النافذة: ' + error.message);
  }
}

// دالة إغلاق المودال
function closeModal() {
  console.log('إغلاق المودال...');
  
  const modals = ['dataModal', 'certificatesModal', 'exemptionsModal', 'savedCertificatesModal'];
  
  modals.forEach(modalId => {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.style.display = 'none';
    }
  });
}

// دالة إغلاق مودال الشهادات المحفوظة
function closeSavedCertificatesModal() {
  const modal = document.getElementById('savedCertificatesModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

// دالة فتح مودال الشهادات مع تحديث البيانات
async function openCertModal() {
  await loadAndDisplayCertificates();
  // كود فتح المودال الموجود
  let modal = document.getElementById('savedCertificatesModal');
  if (!modal) {
    modal = document.getElementById('certModal');
  }
  if (modal) {
    modal.style.display = 'block';
  }
}

// دوال الفلترة للإعفاءات
function filterExemptions() {
  // سيتم تنفيذها لاحقاً
  console.log('فلترة الإعفاءات...');
}

function clearExemptionsFilters() {
  // مسح جميع الفلاتر
  document.getElementById('exemptionsCompanyFilter').value = '';
  document.getElementById('exemptionsItemFilter').value = '';
  document.getElementById('exemptionsStatusFilter').value = '';
  document.getElementById('exemptionsDateFrom').value = '';
  document.getElementById('exemptionsDateTo').value = '';
  
  // إعادة عرض جميع البيانات
  loadAndDisplayData();
}

// دوال الفلترة للشهادات
function filterCertificates() {
  // سيتم تنفيذها لاحقاً
  console.log('فلترة الشهادات...');
}

function clearCertificatesFilters() {
  // مسح جميع الفلاتر
  document.getElementById('certificatesCompanyFilter').value = '';
  document.getElementById('certificatesItemFilter').value = '';
  document.getElementById('certificatesStatusFilter').value = '';
  document.getElementById('certificatesDateFrom').value = '';
  document.getElementById('certificatesDateTo').value = '';
  
  // إعادة عرض جميع البيانات
  loadAndDisplayCertificates();
}

// إضافة دعم Enter key للبحث السريع
document.addEventListener("DOMContentLoaded", function() {
  const mobileInput = document.getElementById("mobileSearchInput");
  if (mobileInput) {
    mobileInput.addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        mobileQuickSearch();
      }
    });
  }
  
  // تحديث الإحصائيات عند تحميل الصفحة
  updateStats();
  
  // تحديث العرض عند تحميل الصفحة
  loadAndDisplayData();
  loadAndDisplayCertificates();
});

// دالة حذف شهادة من قاعدة البيانات
function deleteCertificateFromDB(certId) {
  if (!confirm('هل أنت متأكد من حذف هذه الشهادة نهائياً؟\nهذا الإجراء لا يمكن التراجع عنه')) return;
  
  console.log('Deleting certificate from database with ID:', certId);
  
  fetch(`/api/certificates/${certId}`, { method: 'DELETE' })
    .then(response => {
      console.log('Delete response status:', response.status);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const contentType = response.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        throw new Error(`Expected JSON response but got: ${contentType}`);
      }
      
      return response.json();
    })
    .then(data => {
      if (data.success) {
        displaySavedCertificates();
        updateStats();
        showAlert('تم حذف الشهادة بنجاح', 'success');
      } else {
        showAlert('خطأ في حذف الشهادة: ' + (data.message || 'خطأ غير معروف'), 'error');
      }
    })
    .catch(error => {
      console.error('Error deleting certificate:', error);
      showAlert('خطأ في الاتصال: ' + error.message, 'error');
    });
}
