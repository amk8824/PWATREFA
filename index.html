// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
let currentTab = 'certificates';
let announcementTimer;

// Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
function showUpdateAnnouncement() {
  const announcement = document.getElementById('updateAnnouncement');
  if (announcement) {
    announcement.style.display = 'flex';
    startAnnouncementTimer();
  }
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
function closeAnnouncement() {
  const announcement = document.getElementById('updateAnnouncement');
  if (announcement) {
    announcement.style.display = 'none';
    if (announcementTimer) {
      clearInterval(announcementTimer);
    }
  }
}

// Ø¹Ø¯Ø§Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
function startAnnouncementTimer() {
  let timeLeft = 60; // 60 Ø«Ø§Ù†ÙŠØ© = Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©
  const timerElement = document.getElementById('timerCount');
  
  announcementTimer = setInterval(() => {
    timeLeft--;
    if (timerElement) {
      timerElement.textContent = timeLeft;
    }
    
    if (timeLeft <= 0) {
      closeAnnouncement();
    }
  }, 1000);
}

// Ø¥Ø¯Ø§Ø±Ø© Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„
if (!localStorage.getItem('lockCode')) {
  localStorage.setItem('lockCode', '1234');
}

// Ø¯Ø§Ù„Ø© ÙØ­Øµ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
async function checkPassword() {
    const password = document.getElementById('passwordInput').value;
    
    if (!password) {
        showAlert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'error');
        return;
    }
    
    try {
        const response = await fetch('/check_password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ password: password })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            document.getElementById('lockScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.body.style.overflow = 'auto';
            updateCertificatesStats();
            // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«
            setTimeout(() => {
                showUpdateAnnouncement();
            }, 500);
        } else {
            showAlert(data.message || 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
            // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø§Ù‡ØªØ²Ø§Ø² Ù„Ù„Ø­Ù‚Ù„
            const input = document.getElementById('passwordInput');
            input.classList.add('shake');
            setTimeout(() => input.classList.remove('shake'), 600);
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
    }
}

function toggleChangePassword() {
  const form = document.getElementById('changePasswordForm');
  form.style.display = form.style.display === 'none' ? 'flex' : 'none';
}

async function changePassword() {
    const oldPassword = document.getElementById('oldPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (!oldPassword || !newPassword || !confirmPassword) {
        showAlert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„', 'error');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©', 'error');
        return;
    }
    
    if (newPassword.length < 4) {
        showAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
        return;
    }
    
    try {
        const response = await fetch('/change_password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                old_password: oldPassword,
                new_password: newPassword,
                confirm_password: confirmPassword
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message || 'ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
            toggleChangePassword();
        } else {
            showAlert(data.message || 'ÙØ´Ù„ ÙÙŠ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
    }
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
function showAlert(message, type = 'info') {
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
        <span>${message}</span>
    `;
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ù†Ù…Ø§Ø·
    alert.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        font-family: 'Cairo', sans-serif;
        font-weight: 600;
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideInRight 0.3s ease;
        background: ${type === 'success' ? 'linear-gradient(45deg, #28a745, #34ce57)' : 
                    type === 'error' ? 'linear-gradient(45deg, #dc3545, #e55d6c)' : 
                    'linear-gradient(45deg, #007bff, #4dabf7)'};
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    `;
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„ØµÙØ­Ø©
    document.body.appendChild(alert);
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
    setTimeout(() => {
        alert.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => {
            if (document.body.contains(alert)) {
                document.body.removeChild(alert);
            }
        }, 300);
    }, 3000);
}

// Ø¯Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡ Ù†ÙØ§Ø¯ Ø§Ù„ÙƒÙ…ÙŠØ© Ù…Ø¹ Ù„ÙˆÙ† Ø£Ø­Ù…Ø± Ù…Ù…ÙŠØ²
function showQuantityWarning(message) {
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø®Ø§Øµ
    const warning = document.createElement('div');
    warning.className = 'quantity-warning';
    warning.innerHTML = `
        <i class="fas fa-exclamation-triangle"></i>
        <span>${message}</span>
        <i class="fas fa-exclamation-triangle"></i>
    `;
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø®Ø§ØµØ© Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø£Ø­Ù…Ø±
    warning.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px 30px;
        border-radius: 15px;
        color: white;
        font-family: 'Cairo', sans-serif;
        font-weight: 700;
        font-size: 18px;
        z-index: 20000;
        display: flex;
        align-items: center;
        gap: 15px;
        background: linear-gradient(45deg, #ff0000, #cc0000);
        border: 3px solid #ffcccc;
        box-shadow: 0 10px 30px rgba(255, 0, 0, 0.5);
        animation: warningPulse 2s ease-in-out infinite;
        text-align: center;
        min-width: 300px;
        max-width: 80vw;
    `;
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„ØµÙØ­Ø©
    document.body.appendChild(warning);
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†
    setTimeout(() => {
        warning.style.animation = 'warningFadeOut 0.5s ease';
        setTimeout(() => {
            if (document.body.contains(warning)) {
                document.body.removeChild(warning);
            }
        }, 500);
    }, 5000);
}

// Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
function playWarningSound() {
    try {
        // Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØª ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // ØªØ¹ÙŠÙŠÙ† Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ¬Ø© ÙˆØ§Ù„ØªØ±Ø¯Ø¯
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime); // ØªØ±Ø¯Ø¯ Ø¹Ø§Ù„ÙŠ
        
        // ØªØ¹ÙŠÙŠÙ† Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ù„Ù…Ø¯Ø© Ù†ØµÙ Ø«Ø§Ù†ÙŠØ©
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
        
        // ØªÙƒØ±Ø§Ø± Ø§Ù„ØµÙˆØª 3 Ù…Ø±Ø§Øª
        setTimeout(() => {
            if (audioContext.state !== 'closed') {
                const oscillator2 = audioContext.createOscillator();
                const gainNode2 = audioContext.createGain();
                oscillator2.connect(gainNode2);
                gainNode2.connect(audioContext.destination);
                oscillator2.type = 'sine';
                oscillator2.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode2.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator2.start();
                oscillator2.stop(audioContext.currentTime + 0.5);
            }
        }, 600);
        
        setTimeout(() => {
            if (audioContext.state !== 'closed') {
                const oscillator3 = audioContext.createOscillator();
                const gainNode3 = audioContext.createGain();
                oscillator3.connect(gainNode3);
                gainNode3.connect(audioContext.destination);
                oscillator3.type = 'sine';
                oscillator3.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode3.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode3.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator3.start();
                oscillator3.stop(audioContext.currentTime + 0.5);
            }
        }, 1200);
        
    } catch (error) {
        console.log('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:', error);
        // Ø¨Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… Ø¯Ø¹Ù… Web Audio API
        console.log('ğŸ”Š ØªÙ†Ø¨ÙŠÙ‡ ØµÙˆØªÙŠ: Ø§Ù„ÙƒÙ…ÙŠØ© Ù†ÙØ°Øª!');
    }
}

// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
function showTab(tabName) {
  const tabs = document.querySelectorAll('.tab-content');
  const buttons = document.querySelectorAll('.tab-button');
  
  tabs.forEach(tab => tab.classList.remove('active'));
  buttons.forEach(button => button.classList.remove('active'));
  
  document.getElementById(tabName).classList.add('active');
  event.target.classList.add('active');
  
  currentTab = tabName;
}

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
function updateRemaining() {
  const total = parseFloat(document.getElementById('totalQuantity').value) || 0;
  const deducted = parseFloat(document.getElementById('deductedQuantity').value) || 0;
  const remaining = total - deducted;
  document.getElementById('remainingQuantity').value = remaining;

  // ØªÙ†Ø¨ÙŠÙ‡ Ù†ÙØ§Ø¯ Ø§Ù„ÙƒÙ…ÙŠØ© Ù…Ø¹ ØµÙˆØª
  if (remaining <= 0 && total > 0) {
    playWarningSound();
    showQuantityWarning("âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù‚Ø¯ Ù†ÙØ°Øª ØªÙ…Ø§Ù…Ø§Ù‹!");
  } else if (remaining <= (total * 0.1) && total > 0 && remaining > 0) {
    playWarningSound();
    showQuantityWarning("âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù‚Ù„ÙŠÙ„Ø© Ø¬Ø¯Ø§Ù‹ - Ø£Ù‚Ù„ Ù…Ù† 10%");
  }
}

// Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„
function updateRemainingMobile() {
  const total = parseFloat(document.getElementById('totalQuantity-mobile').value) || 0;
  const deducted = parseFloat(document.getElementById('deductedQuantity-mobile').value) || 0;
  const remaining = total - deducted;
  document.getElementById('remainingQuantity-mobile').value = remaining;

  // ØªÙ†Ø¨ÙŠÙ‡ Ù†ÙØ§Ø¯ Ø§Ù„ÙƒÙ…ÙŠØ© Ù…Ø¹ ØµÙˆØª
  if (remaining <= 0 && total > 0) {
    playWarningSound();
    showQuantityWarning("âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù‚Ø¯ Ù†ÙØ°Øª ØªÙ…Ø§Ù…Ø§Ù‹!");
  } else if (remaining <= (total * 0.1) && total > 0 && remaining > 0) {
    playWarningSound();
    showQuantityWarning("âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù‚Ù„ÙŠÙ„Ø© Ø¬Ø¯Ø§Ù‹ - Ø£Ù‚Ù„ Ù…Ù† 10%");
  }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ù†Ø§ÙØ°Ø©
async function checkCertificateStatus(certificateNumber) {
  if (!certificateNumber) return;
  
  try {
    const response = await fetch('/api/certificates');
    const result = await response.json();
    
    if (result.success) {
      const existingCerts = result.certificates.filter(cert => 
        cert.certificateNumber === certificateNumber
      );
      
      if (existingCerts.length > 0) {
        const totalRemaining = existingCerts.reduce((sum, cert) => 
          sum + (parseFloat(cert.remainingQuantity) || 0), 0
        );
        
        if (totalRemaining <= 0) {
          playWarningSound();
          showAlert('ğŸš¨ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù†Ø§ÙØ°Ø© ØªÙ…Ø§Ù…Ø§Ù‹ - Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙ…ÙŠØ© Ù…ØªØ¨Ù‚ÙŠØ©!', 'error');
          return false;
        } else if (totalRemaining <= 50) {
          playWarningSound();
          showAlert(`âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù‚Ù„ÙŠÙ„Ø©: ${totalRemaining}`, 'warning');
        }
      }
    }
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©:', error);
  }
  return true;
}

async function saveCertificate() {
  // ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„ Ø£Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
  let cert;
  
  // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù…Ø±Ø¦ÙŠØ© ÙˆÙ„Ù‡Ø§ Ù‚ÙŠÙ…
  const mobileForm = document.querySelector('.mobile-form');
  const isMobile = window.innerWidth <= 768 || (mobileForm && getComputedStyle(mobileForm).display !== 'none');
  
  if (isMobile) {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„
    cert = {
      company: document.getElementById('company-mobile').value.trim(),
      borderSerial: document.getElementById('borderSerial-mobile').value.trim(),
      certificateNumber: document.getElementById('certificateNumber-mobile').value.trim(),
      certificateDate: document.getElementById('certificateDate-mobile').value,
      totalQuantity: parseFloat(document.getElementById('totalQuantity-mobile').value) || 0,
      deductedQuantity: parseFloat(document.getElementById('deductedQuantity-mobile').value) || 0,
      unit: document.getElementById('unit-mobile').value,
      itemType: document.getElementById('itemType-mobile').value.trim()
    };
  } else {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„
    cert = {
      company: document.getElementById('company').value.trim(),
      borderSerial: document.getElementById('borderSerial').value.trim(),
      certificateNumber: document.getElementById('certificateNumber').value.trim(),
      certificateDate: document.getElementById('certificateDate').value,
      totalQuantity: parseFloat(document.getElementById('totalQuantity').value) || 0,
      deductedQuantity: parseFloat(document.getElementById('deductedQuantity').value) || 0,
      unit: document.getElementById('unit').value,
      itemType: document.getElementById('itemType').value.trim()
    };
  }

  if (!cert.company || !cert.certificateNumber || !cert.totalQuantity) {
    alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒØ§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.");
    return;
  }

  // Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† localStorage
  try {
    const response = await fetch('/api/certificates', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        company: cert.company,
        border_serial: cert.borderSerial,
        certificate_number: cert.certificateNumber,
        certificate_date: cert.certificateDate,
        total_quantity: cert.totalQuantity,
        deducted_quantity: cert.deductedQuantity,
        remaining_quantity: cert.totalQuantity - cert.deductedQuantity,
        unit: cert.unit,
        item_type: cert.itemType
      })
    });

    const result = await response.json();
    
    if (result.success) {
      showAlert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
      
      // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
      if (isMobile) {
        document.getElementById('company-mobile').value = '';
        document.getElementById('borderSerial-mobile').value = '';
        document.getElementById('certificateNumber-mobile').value = '';
        document.getElementById('certificateDate-mobile').value = '';
        document.getElementById('totalQuantity-mobile').value = '';
        document.getElementById('deductedQuantity-mobile').value = '';
        document.getElementById('remainingQuantity-mobile').value = '';
        document.getElementById('unit-mobile').value = 'Ø·Ù†';
        document.getElementById('itemType-mobile').value = '';
      } else {
        document.getElementById('company').value = '';
        document.getElementById('borderSerial').value = '';
        document.getElementById('certificateNumber').value = '';
        document.getElementById('certificateDate').value = '';
        document.getElementById('totalQuantity').value = '';
        document.getElementById('deductedQuantity').value = '';
        document.getElementById('remainingQuantity').value = '';
        document.getElementById('unit').value = 'Ø·Ù†';
        document.getElementById('itemType').value = '';
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      updateCertificatesStats();
      
    } else {
      showAlert(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©: ${result.message}`, 'error');
    }
  } catch (error) {
    console.error('Error saving certificate:', error);
    showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
  }

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
  const canProceed = await checkCertificateStatus(cert.certificateNumber);
  if (!canProceed) {
    const confirmProceed = confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø¹ Ø§Ù„Ø¹Ù„Ù… Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù†Ø§ÙØ°Ø©ØŸ');
    if (!confirmProceed) return;
  }

  try {
    const response = await fetch('/api/certificates', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(cert)
    });

    const result = await response.json();

    if (result.success) {
      alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­.");
      await renderCertificates();
      await updateStats();
      
      // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
      if (isMobile) {
        document.querySelectorAll('.mobile-field input, .mobile-field select').forEach(field => {
          if (!field.readOnly) field.value = '';
        });
      } else {
        document.getElementById('dataForm').reset();
      }
    } else {
      alert(`âŒ Ø®Ø·Ø£: ${result.message}`);
    }
  } catch (error) {
    console.error('Error saving certificate:', error);
    alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
  }
}

async function renderCertificates() {
  const list = document.getElementById('certificatesList');
  list.innerHTML = '<tr><td colspan="11" style="text-align: center;">ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>';
  
  try {
    const response = await fetch('/api/certificates');
    const result = await response.json();
    
    if (!result.success) {
      list.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #dc3545;">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
      return;
    }

    const certificates = result.certificates;
    list.innerHTML = '';
    
    if (certificates.length === 0) {
      list.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ù‡Ø§Ø¯Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</td></tr>';
      return;
    }

    certificates.forEach((cert) => {
      const row = document.createElement('tr');
      const remaining = parseFloat(cert.remainingQuantity) || 0;
      const isExpired = remaining <= 0;
      
      // Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ø§Ø³ CSS Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ÙØ°Ø©
      if (isExpired) {
        row.classList.add('expired-row');
        row.style.backgroundColor = '#ffebee';
        row.style.color = '#c62828';
        row.style.fontWeight = 'bold';
      }
      
      row.innerHTML = `
        <td data-label="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©">${cert.company}${isExpired ? ' <span style="background: #f44336; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">Ù†Ø§ÙØ°Ø©</span>' : ''}</td>
        <td data-label="Ø±Ù‚Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©">${cert.certificateNumber}</td>
        <td data-label="Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø­Ø¯ÙˆØ¯ÙŠ">${cert.borderSerial}</td>
        <td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®">${cert.certificateDate}</td>
        <td data-label="Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©">${cert.itemType}</td>
        <td data-label="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©">${cert.totalQuantity}</td>
        <td data-label="Ø§Ù„Ù…Ø³ØªÙ‚Ø·Ø¹Ø©">${cert.deductedQuantity}</td>
        <td data-label="Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©" style="${isExpired ? 'color: #f44336; font-weight: bold;' : ''}">${cert.remainingQuantity}</td>
        <td data-label="Ø§Ù„ÙˆØ­Ø¯Ø©">${cert.unit}</td>
        <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­ÙØ¸">${cert.savedAt}</td>
        <td data-label="Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª">
          <div class="action-buttons">
            <button onclick="editCertificate(${cert.id})" class="edit-btn" style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-left: 5px;">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            <button onclick="deleteCertificate(${cert.id})" class="delete-btn" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        </td>
      `;
      list.appendChild(row);
    });
  } catch (error) {
    console.error('Error loading certificates:', error);
    list.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #dc3545;">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…</td></tr>';
  }
}

function openModal() {
  document.getElementById('certificatesModal').style.display = 'block';
  renderCertificates();
}

function closeModal() {
  document.getElementById('certificatesModal').style.display = 'none';
}

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¨Ø­Ø«
async function searchCertificates() {
  const searchType = document.getElementById('searchType').value; // exemption Ø£Ùˆ certificate
  const searchOption = document.getElementById('searchOption').value;
  const searchTerm = document.getElementById('searchInput').value.trim();
  
  if (!searchTerm) {
    alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ù„Ù„Ø¨Ø­Ø«");
    return;
  }

  let searchResults = [];
  
  if (searchType === 'exemption') {
    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    try {
      const response = await fetch(`/api/mobile/search/exemptions?q=${encodeURIComponent(searchTerm)}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        }
      });

      const result = await response.json();
      if (result.success) {
        searchResults = [...searchResults, ...result.results.map(item => ({...item, type: 'exemption'}))];
      }
    } catch (error) {
      console.error('Error searching exemptions:', error);
    }
    
    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø§Ø¹ÙØ§Ø¡Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
    const localExemptions = JSON.parse(localStorage.getItem('certificates') || '[]');
    const localResults = localExemptions.filter(item => {
      const value = item[searchOption]?.toString().toLowerCase() || '';
      return value.includes(searchTerm.toLowerCase());
    });
    searchResults = [...searchResults, ...localResults.map(item => ({...item, type: 'exemption'}))];
    
  } else if (searchType === 'certificate') {
    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    try {
      const certResponse = await fetch(`/api/mobile/search/certificates?q=${encodeURIComponent(searchTerm)}`);
      const certResult = await certResponse.json();
      
      if (certResult.success && certResult.results) {
        searchResults = [...searchResults, ...certResult.results.map(item => ({...item, type: 'certificate'}))];
      }
    } catch (error) {
      console.error('Error searching certificates from database:', error);
    }
  }

  displaySearchResults(searchResults);
}

async function filterByDate() {
  const dateFrom = document.getElementById('dateFrom').value;
  const dateTo = document.getElementById('dateTo').value;
  
  if (!dateFrom || !dateTo) {
    alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠÙ†");
    return;
  }

  try {
    const response = await fetch('/api/certificates/search', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        dateFrom: dateFrom,
        dateTo: dateTo
      })
    });

    const result = await response.json();
    if (result.success) {
      displaySearchResults(result.certificates);
    } else {
      alert(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØµÙÙŠØ©: ${result.message}`);
    }
  } catch (error) {
    console.error('Error filtering by date:', error);
    alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
  }
}

function clearDateFilter() {
  document.getElementById('dateFrom').value = '';
  document.getElementById('dateTo').value = '';
}

function displaySearchResults(results) {
  const resultsList = document.getElementById('searchResultsList');
  resultsList.innerHTML = '';
  
  if (results.length === 0) {
    resultsList.innerHTML = '<tr><td colspan="11">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
  } else {
    results.forEach(cert => {
      const row = document.createElement('tr');
      const remaining = parseFloat(cert.remainingQuantity) || 0;
      const isExpired = remaining <= 0;
      const isExemption = cert.type === 'exemption';
      
      // Ø¥Ø¶Ø§ÙØ© ØªÙ„ÙˆÙŠÙ† Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ÙØ°Ø© ÙÙŠ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
      if (isExpired) {
        row.style.backgroundColor = '#ffebee';
        row.style.color = '#c62828';
        row.style.fontWeight = 'bold';
      }
      
      // ØªÙ„ÙˆÙŠÙ† Ù…Ø®ØªÙ„Ù Ù„ÙƒÙ„ Ù†ÙˆØ¹
      if (isExemption) {
        row.style.borderLeft = '4px solid #4caf50';
      } else {
        row.style.borderLeft = '4px solid #2196f3';
      }
      
      const typeLabel = isExemption ? 'Ø¥Ø¹ÙØ§Ø¡' : 'Ø´Ù‡Ø§Ø¯Ø©';
      const typeIcon = isExemption ? 'ğŸ›ï¸' : 'ğŸ“‹';
      
      row.innerHTML = `
        <td data-label="Ø§Ù„Ù†ÙˆØ¹">${typeIcon} ${typeLabel}</td>
        <td data-label="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©">${cert.company}${isExpired ? ' <span style="background: #f44336; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">Ù†Ø§ÙØ°Ø©</span>' : ''}</td>
        <td data-label="Ø±Ù‚Ù… Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©">${cert.certificateNumber}</td>
        <td data-label="Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø­Ø¯ÙˆØ¯ÙŠ">${cert.borderSerial}</td>
        <td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®">${cert.certificateDate}</td>
        <td data-label="Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©">${cert.itemType}</td>
        <td data-label="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©">${cert.totalQuantity}</td>
        <td data-label="Ø§Ù„Ù…Ø³ØªÙ‚Ø·Ø¹Ø©">${cert.deductedQuantity}</td>
        <td data-label="Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©" style="${isExpired ? 'color: #f44336; font-weight: bold;' : ''}">${cert.remainingQuantity}</td>
        <td data-label="Ø§Ù„ÙˆØ­Ø¯Ø©">${cert.unit}</td>
        <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­ÙØ¸">${cert.savedAt}</td>
      `;
      resultsList.appendChild(row);
    });
    
    // Ø¥Ø¶Ø§ÙØ© ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    if (results.length > 0) {
      // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø³Ø¬Ù„ ØªÙ… Ø­ÙØ¸Ù‡ (Ø£Ø­Ø¯Ø« ØªØ§Ø±ÙŠØ® ÙÙŠ savedAt)
      const latestRecord = results.reduce((latest, current) => {
        const latestDate = new Date(latest.savedAt || latest.updatedAt || 0);
        const currentDate = new Date(current.savedAt || current.updatedAt || 0);
        return currentDate > latestDate ? current : latest;
      });
      
      const lastRemaining = latestRecord.remainingQuantity;
      const lastUnit = latestRecord.unit;
      const lastSavedDate = latestRecord.savedAt;
      
      const alertRow = document.createElement('tr');
      alertRow.innerHTML = `
        <td colspan="11" style="padding: 20px; border: none;">
          <div style="background: linear-gradient(135deg, #28a745, #20c997); color: #ffffff; padding: 18px; border-radius: 12px; text-align: center; font-size: 16px; font-weight: 800; border: 3px solid #1e7e34; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4); margin: 10px 0; animation: pulse 2s infinite;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
              <span style="font-size: 20px;">âš ï¸</span>
              <strong>Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù…Ø­Ø¯Ø«Ø© Ø¨Ø¹Ø¯ Ø¢Ø®Ø± Ø§Ø³ØªÙ‚Ø·Ø§Ø¹</strong>
            </div>
            <div style="font-size: 14px; margin-top: 8px; opacity: 0.9;">
              Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© ØªØ¹ÙƒØ³ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
            </div>
          </div>
          
          <div style="background: linear-gradient(135deg, #dc3545, #c82333, #007bff); color: #ffffff; padding: 20px; border-radius: 12px; text-align: center; border: 3px solid #bd2130; box-shadow: 0 6px 20px rgba(220, 53, 69, 0.5); margin: 15px 0; animation: pulse 2s infinite; position: relative; overflow: hidden;">
            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.1) 50%, transparent 60%); animation: shine 3s infinite;"></div>
            <div style="position: relative; z-index: 2;">
              <div style="font-size: 14px; font-weight: 600; margin-bottom: 8px; opacity: 0.9;">
                Ø¢Ø®Ø± ÙƒÙ…ÙŠØ© Ù…ØªØ¨Ù‚ÙŠØ© (Ø­ÙÙØ¸Øª ÙÙŠ ${lastSavedDate})
              </div>
              <div style="font-size: 42px; font-weight: 900; text-shadow: 0 3px 6px rgba(0,0,0,0.5); color: #ffff00; letter-spacing: 1px;">
                ${lastRemaining} ${lastUnit}
              </div>
            </div>
          </div>
        </td>`;
      resultsList.appendChild(alertRow);
    }
  }
  document.getElementById('searchResultsModal').style.display = 'block';
}

function closeSearchResultsModal() {
  document.getElementById('searchResultsModal').style.display = 'none';
}





// Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª ÙÙ‚Ø·
async function printCertificatesReport() {
  try {
    const response = await fetch('/api/certificates');
    const result = await response.json();
    
    if (!result.success || !result.certificates || result.certificates.length === 0) {
      showAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ù‡Ø§Ø¯Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©!', 'warning');
      return;
    }
    
    const certificates = result.certificates;
    const printWindow = window.open('', '', 'height=800,width=1000');
    
    // Ø¥Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø±Ø§Øª
    const logoPromises = [
      new Promise((resolve) => {
        const img1 = new Image();
        img1.onload = resolve;
        img1.onerror = resolve;
        img1.src = `https://www2.0zz0.com/2025/05/19/22/510831948.png?${Date.now()}`;
      }),
      new Promise((resolve) => {
        const img2 = new Image();
        img2.onload = resolve;
        img2.onerror = resolve;
        img2.src = `https://www2.0zz0.com/2025/05/19/22/823371779.png?${Date.now()}`;
      })
    ];
    
    await Promise.all(logoPromises);
    
    printWindow.document.write(`
      <html>
      <head>
        <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„ÙƒÙ…Ø±ÙƒÙŠØ© Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠØ©</title>
        <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
        <style>
          body { 
            font-family: 'Cairo', Arial, sans-serif; 
            direction: rtl; 
            margin: 20px;
            background: #fff;
            color: #000;
          }
          .header { 
            text-align: center; 
            margin-bottom: 30px; 
            border-bottom: 3px solid #002147;
            padding-bottom: 20px;
          }
          .logos {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 50px;
          }
          .logo { 
            width: 100px; 
            height: 100px;
            object-fit: contain;
          }
          .header h1 {
            color: #002147;
            font-size: 28px;
            margin: 15px 0;
            font-weight: 700;
          }
          .header h2 {
            color: #cc0000;
            font-size: 22px;
            margin: 12px 0;
            font-weight: 600;
          }
          .header h3 {
            color: #002147;
            font-size: 20px;
            margin: 10px 0;
            font-weight: 600;
          }
        table { 
          width: 100%; 
          border-collapse: collapse; 
          margin: 20px 0;
          font-size: 12px;
        }
        th, td { 
          border: 1px solid #002147; 
          padding: 8px; 
          text-align: center;
          vertical-align: middle;
        }
        th { 
          background: linear-gradient(135deg, #2196f3, #1976d2);
          color: #ffd700; 
          font-weight: bold;
        }
        .total-row {
          background: #e3f2fd !important;
          font-weight: bold;
          color: #1976d2;
        }
        .expired { 
          background: #ffebee !important; 
          color: #d32f2f !important;
        }
        .footer {
          margin-top: 30px;
          text-align: center;
          font-size: 14px;
          color: #002147;
          border-top: 2px solid #002147;
          padding-top: 15px;
        }
        @media print {
          body { margin: 0; }
          .header { page-break-after: avoid; }
          table { page-break-inside: avoid; }
        }
        </style>
      </head>
      <body>
        <div class="header">
          <div class="logos">
            <img src="https://www2.0zz0.com/2025/05/19/22/510831948.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ø±Ø§Ù‚" class="logo">
            <img src="https://www2.0zz0.com/2025/05/19/22/823371779.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ÙƒÙ…Ø§Ø±Ùƒ" class="logo">
          </div>
          <h1>Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø§Ù„Ø¹Ø±Ø§Ù‚</h1>
          <h2>ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© - Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ÙƒÙ…Ø§Ø±Ùƒ</h2>
          <h3>Ù…Ø±ÙƒØ² ÙƒÙ…Ø±Ùƒ Ø·Ø±ÙŠØ¨ÙŠÙ„ Ø§Ù„Ø­Ø¯ÙˆØ¯ÙŠ 642</h3>
          <h3>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„ÙƒÙ…Ø±ÙƒÙŠØ©</h3>
          <p>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleDateString('ar-EG')} - ${new Date().toLocaleTimeString('ar-EG')}</p>
        </div>
        
        <table>
          <thead>
            <tr>
              <th>Ù…</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</th>
              <th>Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø­Ø¯ÙˆØ¯ÙŠ</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©</th>
              <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©</th>
              <th>Ø§Ù„Ù…Ø³ØªÙ‚Ø·Ø¹Ø©</th>
              <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
              <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
              <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­ÙØ¸</th>
            </tr>
          </thead>
          <tbody>
    `);
    
    let totalQuantity = 0;
    let totalDeducted = 0;
    let totalRemaining = 0;
    
    certificates.forEach((cert, index) => {
      const remaining = parseFloat(cert.remainingQuantity) || 0;
      const isExpired = remaining <= 0;
      const rowClass = isExpired ? 'expired' : '';
      
      totalQuantity += parseFloat(cert.totalQuantity) || 0;
      totalDeducted += parseFloat(cert.deductedQuantity) || 0;
      totalRemaining += remaining;
      
      printWindow.document.write(`
        <tr class="${rowClass}">
          <td>${index + 1}</td>
          <td>${cert.company || ''}</td>
          <td>${cert.certificateNumber || ''}</td>
          <td>${cert.borderSerial || ''}</td>
          <td>${cert.certificateDate || ''}</td>
          <td>${cert.itemType || ''}</td>
          <td>${cert.totalQuantity || 0}</td>
          <td>${cert.deductedQuantity || 0}</td>
          <td>${cert.remainingQuantity || 0}</td>
          <td>${cert.unit || ''}</td>
          <td>${cert.savedAt || ''}</td>
        </tr>
      `);
    });
    
    printWindow.document.write(`
          <tr class="total-row">
            <td colspan="6"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</strong></td>
            <td><strong>${totalQuantity.toFixed(2)}</strong></td>
            <td><strong>${totalDeducted.toFixed(2)}</strong></td>
            <td><strong>${totalRemaining.toFixed(2)}</strong></td>
            <td colspan="2"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${certificates.length} Ø´Ù‡Ø§Ø¯Ø©</strong></td>
          </tr>
          </tbody>
        </table>
        
        <div class="footer">
          <p><strong>Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø¹ÙØ§Ø¡Ø§Øª Ø§Ù„ÙƒÙ…Ø±ÙƒÙŠØ© - Ù…Ø±ÙƒØ² ÙƒÙ…Ø±Ùƒ Ø·Ø±ÙŠØ¨ÙŠÙ„ 642</strong></p>
          <p>Ù…Ø·ÙˆØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø§Ù„Ù‚Ø§Ø¯Ø± Ù…Ø´Ø­Ù† Ø§Ù„Ø¹Ø¨ÙŠØ¯ÙŠ</p>
        </div>
      </body>
      </html>
    `);
    
    printWindow.document.close();
    
    setTimeout(() => {
      printWindow.focus();
      printWindow.print();
      setTimeout(() => {
        printWindow.close();
      }, 500);
    }, 1000);
    
    showAlert('âœ… ØªÙ… ØªØ­Ø¶ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'success');
    
  } catch (error) {
    console.error('Error printing certificates report:', error);
    showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª', 'error');
  }
}

async function printExemptionsReport() {
  try {
    const response = await fetch('/api/exemptions');
    const result = await response.json();
    
    if (!result.success || !result.exemptions || result.exemptions.length === 0) {
      showAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹ÙØ§Ø¡Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©!', 'warning');
      return;
    }
    
    const exemptions = result.exemptions;
    const printWindow = window.open('', '', 'height=800,width=1000');
    
    // Ø¥Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø±Ø§Øª
    const logoPromises = [
      new Promise((resolve) => {
        const img1 = new Image();
        img1.onload = resolve;
        img1.onerror = resolve;
        img1.src = `/static/images/iraq_logo.png?${Date.now()}`;
      }),
      new Promise((resolve) => {
        const img2 = new Image();
        img2.onload = resolve;
        img2.onerror = resolve;
        img2.src = `/static/images/customs_logo.png?${Date.now()}`;
      })
    ];
    
    await Promise.all(logoPromises);
    
    printWindow.document.write(`
      <html>
      <head>
        <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª Ø§Ù„ÙƒÙ…Ø±ÙƒÙŠØ© Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠØ©</title>
        <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
        <style>
          body { 
            font-family: 'Cairo', Arial, sans-serif; 
            direction: rtl; 
            margin: 20px;
            background: #fff;
            color: #000;
          }
          .header { 
            text-align: center; 
            margin-bottom: 30px; 
            border-bottom: 3px solid #002147;
            padding-bottom: 20px;
          }
          .logos {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 50px;
          }
          .logo { 
            width: 100px; 
            height: 100px;
            object-fit: contain;
          }
          .header h1 {
            color: #002147;
            font-size: 28px;
            margin: 15px 0;
            font-weight: 700;
          }
          .header h2 {
            color: #cc0000;
            font-size: 22px;
            margin: 12px 0;
            font-weight: 600;
          }
          .header h3 {
            color: #002147;
            font-size: 20px;
            margin: 10px 0;
            font-weight: 600;
          }
        table { 
          width: 100%; 
          border-collapse: collapse; 
          margin: 20px 0; 
          font-size: 14px;
        }
        th, td { 
          border: 2px solid #002147; 
          padding: 12px 8px; 
          text-align: center; 
          vertical-align: middle;
        }
        th { 
          background: linear-gradient(135deg, #002147, #003366); 
          color: #ffd700;
          font-weight: bold;
        }
        tr:nth-child(even) {
          background-color: #f8f9fa;
        }
        .expired {
          background-color: #ffebee !important;
          color: #d32f2f;
          font-weight: bold;
        }
        .expired td {
          border-color: #f44336 !important;
          position: relative;
        }
        .expired-label {
          background: #f44336;
          color: white;
          padding: 2px 8px;
          border-radius: 4px;
          font-size: 10px;
          font-weight: bold;
          position: absolute;
          top: 2px;
          right: 2px;
        }
        .footer { 
          margin-top: 40px; 
          text-align: center; 
          font-size: 12px;
          border-top: 2px solid #002147;
          padding-top: 20px;
          color: #002147;
        }
        .print-date {
          background: #f0f0f0;
          padding: 10px;
          border-radius: 8px;
          margin: 10px 0;
        }
        @media print {
          body { margin: 0; }
          .header { page-break-inside: avoid; }
          table { page-break-inside: auto; }
          tr { page-break-inside: avoid; }
        }
      </style>
    </head>
    <body>
      <div class="header">
        <div class="logos">
          <img src="/static/images/iraq_logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠØ©" class="logo">
          <div style="text-align: center;">
            <h1>ğŸ‡®ğŸ‡¶ Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø§Ù„Ø¹Ø±Ø§Ù‚ ğŸ‡®ğŸ‡¶</h1>
            <h2>ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© - Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ÙƒÙ…Ø§Ø±Ùƒ</h2>
            <h3>Ù…Ø±ÙƒØ² ÙƒÙ…Ø±Ùƒ Ø·Ø±ÙŠØ¨ÙŠÙ„ Ø§Ù„Ø­Ø¯ÙˆØ¯ÙŠ 642</h3>
            <h3>ğŸ“‹ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª - Ø´Ø¹Ø¨Ø© Ø§Ù„Ù…Ù†ÙØ³Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h3>
          </div>
          <img src="/static/images/customs_logo.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ÙƒÙ…Ø§Ø±Ùƒ Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠØ©" class="logo">
        </div>
        <div class="print-date">
          <strong>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</strong> ${new Date().toLocaleString('en-GB')}
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Øª</th>
            <th>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</th>
            <th>Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø­Ø¯ÙˆØ¯ÙŠ</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©</th>
            <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©</th>
            <th>Ø§Ù„Ù…Ø³ØªÙ‚Ø·Ø¹Ø©</th>
            <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
            <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          </tr>
        </thead>
        <tbody>
  `);
  
    exemptions.forEach((exemption, index) => {
      const remaining = parseFloat(exemption.remainingQuantity) || 0;
      const isExpired = remaining <= 0;
      const rowClass = isExpired ? 'expired' : '';
      const status = isExpired ? 'Ù†Ø§ÙØ°Ø© âŒ' : remaining <= (exemption.totalQuantity * 0.1) ? 'Ù‚Ù„ÙŠÙ„Ø© âš ï¸' : 'Ù…ØªØ§Ø­Ø© âœ…';
      
      printWindow.document.write(`
        <tr class="${rowClass}">
          <td>${index + 1}${isExpired ? '<span class="expired-label">Ù†Ø§ÙØ°Ø©</span>' : ''}</td>
          <td>${exemption.company}</td>
          <td>${exemption.certificateNumber}</td>
          <td>${exemption.borderSerial}</td>
          <td>${exemption.certificateDate}</td>
          <td>${exemption.itemType}</td>
          <td>${exemption.totalQuantity}</td>
          <td>${exemption.deductedQuantity}</td>
          <td style="${isExpired ? 'color: #f44336; font-weight: bold;' : ''}">${exemption.remainingQuantity}</td>
          <td>${exemption.unit}</td>
          <td style="${isExpired ? 'color: #f44336; font-weight: bold;' : remaining <= (exemption.totalQuantity * 0.1) ? 'color: #ff9800; font-weight: bold;' : 'color: #4caf50; font-weight: bold;'}">${status}</td>
      </tr>
    `);
  });
  
  printWindow.document.write(`
        </tbody>
      </table>
      <div class="footer">
        <h4>ğŸ–¥ï¸ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª Ø§Ù„ÙƒÙ…Ø±ÙƒÙŠØ© Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠØ©</h4>
        <p><strong>Ø§Ù„Ù…Ø·ÙˆØ±:</strong> Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø§Ù„Ù‚Ø§Ø¯Ø± Ù…Ø´Ø­Ù† Ø§Ù„Ø¹Ø¨ÙŠØ¯ÙŠ</p>
        <p><strong>ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> alobaidymo@gmail.com</p>
        <p><strong>ğŸ“± Ø§Ù„Ù‡Ø§ØªÙ:</strong> +9647768525871</p>
        <hr>
        <p><strong>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</strong></p>
        <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª: ${exemptions.length} | Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª Ø§Ù„Ù†Ø§ÙØ°Ø©: ${exemptions.filter(e => (parseFloat(e.remainingQuantity) || 0) <= 0).length} | Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©: ${exemptions.filter(e => (parseFloat(e.remainingQuantity) || 0) > 0).length}</p>
        <p style="font-size: 10px; color: #666;">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ± Ø¨ØªÙ‚Ù†ÙŠØ§Øª Ø­Ø¯ÙŠØ«Ø©</p>
      </div>
    </body>
    </html>
  `);
  
    printWindow.document.close();
    
    // Ø¥Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    printWindow.onload = () => {
      setTimeout(() => {
        printWindow.print();
      }, 1000);
    };
    
  } catch (error) {
    console.error('Error printing report:', error);
    alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
  }
}





// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
function createBackup() {
  const certificates = JSON.parse(localStorage.getItem('certificates') || '[]');
  const backup = {
    version: "1.0",
    created: new Date().toISOString(),
    certificates: certificates
  };
  
  const dataStr = JSON.stringify(backup, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `Ù†Ø³Ø®Ø©_Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©_${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  URL.revokeObjectURL(url);
  
  alert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");
}

function restoreBackup() {
  const fileInput = document.getElementById('backupFile');
  const file = fileInput.files[0];
  
  if (!file) {
    alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©");
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const backup = JSON.parse(e.target.result);
      if (backup.certificates && Array.isArray(backup.certificates)) {
        const confirmRestore = confirm("âš ï¸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ");
        if (confirmRestore) {
          localStorage.setItem('certificates', JSON.stringify(backup.certificates));
          alert("âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");
          updateStats();
          renderCertificates();
        }
      } else {
        alert("âŒ Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­");
      }
    } catch (error) {
      alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©");
    }
  };
  reader.readAsText(file);
}

function clearAllData() {
  const confirmClear = confirm("âš ï¸ Ø®Ø·Ø±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ");
  if (confirmClear) {
    const secondConfirm = confirm("âŒ ØªØ£ÙƒÙŠØ¯ Ø£Ø®ÙŠØ±: Ø³ÙŠØªÙ… ÙÙ‚Ø¯Ø§Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");
    if (secondConfirm) {
      localStorage.removeItem('certificates');
      alert("âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
      updateStats();
      renderCertificates();
    }
  }
}

// Ø¥Ø¶Ø§ÙØ© Ø£Ø­Ø¯Ø§Ø« Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
document.addEventListener('DOMContentLoaded', function() {
    // Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter ÙÙŠ Ø­Ù‚Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    document.getElementById('passwordInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            checkPassword();
        }
    });
    
    // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®Ø§Ø·Ø¦Ø©
    const style = document.createElement('style');
    style.textContent = `
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }
        
        .shake {
            animation: shake 0.6s ease-in-out;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
    
    // ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨ØµØ±ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©
    const interactiveElements = document.querySelectorAll('.elegant-button, .elegant-input, .elegant-select');
    
    interactiveElements.forEach(element => {
        element.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
        });
        
        element.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
    
    // ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©
    const scrollingTitle = document.querySelector('.scrolling-title');
    if (scrollingTitle) {
        scrollingTitle.addEventListener('mouseenter', function() {
            this.style.animationPlayState = 'paused';
        });
        
        scrollingTitle.addEventListener('mouseleave', function() {
            this.style.animationPlayState = 'running';
        });
    }
    
    // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ±Ø§Øª Ù„Ù„Ø´Ø¹Ø§Ø±Ø§Øª
    const logos = document.querySelectorAll('.logo-hover');
    logos.forEach(logo => {
        logo.addEventListener('click', function() {
            this.style.animation = 'none';
            setTimeout(() => {
                this.style.animation = 'logoSpin 1s ease-in-out';
            }, 10);
        });
    });
    
    // Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ØªØ£Ø«ÙŠØ±Ø§Øª
    const additionalStyles = document.createElement('style');
    additionalStyles.textContent = `
        @keyframes logoSpin {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }
        
        .elegant-button:active {
            transform: translateY(1px) !important;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important;
        }
        
        .tab-button:active {
            transform: translateY(1px) !important;
        }
    `;
    document.head.appendChild(additionalStyles);
});

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª - ØªÙ‚ÙˆÙŠÙ… Ù…ÙŠÙ„Ø§Ø¯ÙŠ ÙÙ‚Ø·
function updateDateTime() {
    const now = new Date();
    // ÙØ±Ø¶ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ
    const day = String(now.getDate()).padStart(2, '0');
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const year = now.getFullYear();
    const gregorianDate = `${day}/${month}/${year}`;
    
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    const gregorianTime = `${hours}:${minutes}:${seconds}`;
    
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª ÙÙŠ Ù…ÙƒØ§Ù† Ù…Ù†Ø§Ø³Ø¨
    console.log(`Ø§Ù„ØªØ§Ø±ÙŠØ®: ${gregorianDate} - Ø§Ù„ÙˆÙ‚Øª: ${gregorianTime}`);
}

// ØªØ´ØºÙŠÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
setInterval(updateDateTime, 60000);

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
function checkConnection() {
    if (navigator.onLine) {
        console.log('Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
    } else {
        showAlert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'error');
    }
}

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
window.addEventListener('online', () => {
    showAlert('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'success');
});

window.addEventListener('offline', () => {
    showAlert('Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'error');
});

// Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ (Ù„Ù„Ø·ÙˆØ§Ø±Ø¦)
function saveDataLocally(key, data) {
    try {
        localStorage.setItem(key, JSON.stringify(data));
        console.log('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹');
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹:', error);
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
function getLocalData(key) {
    try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©:', error);
        return null;
    }
}

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
document.addEventListener('DOMContentLoaded', function() {
    console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒÙ…Ø§Ø±Ùƒ Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
    checkConnection();
    updateDateTime();
});
// Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
document.addEventListener('DOMContentLoaded', function() {
  // Ù„Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¹Ø§Ø¯ÙŠ - Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª
  const certNumberInput = document.getElementById('certificateNumber');
  if (certNumberInput) {
    certNumberInput.addEventListener('blur', function() {
      checkCertificateStatus(this.value.trim());
    });
  }
  
  // Ù„Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„ - Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª
  const certNumberInputMobile = document.getElementById('certificateNumber-mobile');
  if (certNumberInputMobile) {
    certNumberInputMobile.addEventListener('blur', function() {
      checkCertificateStatus(this.value.trim());
    });
  }
  
  // Ù„Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¹Ø§Ø¯ÙŠ - Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
  const certCertNumberInput = document.getElementById('cert-certificateNumber');
  if (certCertNumberInput) {
    certCertNumberInput.addEventListener('blur', async function() {
      const certNumber = this.value.trim();
      if (certNumber) {
        const canProceed = await checkCertStatus(certNumber);
        if (!canProceed) {
          showAlert('âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù†Ø§ÙØ°Ø© Ø£Ùˆ Ù…ÙƒØªÙ…Ù„Ø©!', 'error');
        }
      }
    });
  }
  
  // Ù„Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„ - Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
  const certCertNumberInputMobile = document.getElementById('cert-certificateNumber-mobile');
  if (certCertNumberInputMobile) {
    certCertNumberInputMobile.addEventListener('blur', async function() {
      const certNumber = this.value.trim();
      if (certNumber) {
        const canProceed = await checkCertStatus(certNumber);
        if (!canProceed) {
          showAlert('âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù†Ø§ÙØ°Ø© Ø£Ùˆ Ù…ÙƒØªÙ…Ù„Ø©!', 'error');
        }
      }
    });
  }
});

// Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª (Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯)

// Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª - Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨
function updateCertRemaining() {
  const total = parseFloat(document.getElementById('certTotalQuantity').value) || 0;
  const deducted = parseFloat(document.getElementById('certDeductedQuantity').value) || 0;
  const remaining = total - deducted;
  document.getElementById('certRemainingQuantity').value = remaining;

  // ØªÙ†Ø¨ÙŠÙ‡ Ù†ÙØ§Ø¯ Ø§Ù„ÙƒÙ…ÙŠØ© Ù…Ø¹ ØµÙˆØª
  if (remaining <= 0 && total > 0) {
    playWarningSound();
    showQuantityWarning("âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù‚Ø¯ Ù†ÙØ°Øª ØªÙ…Ø§Ù…Ø§Ù‹!");
  } else if (remaining <= (total * 0.1) && total > 0 && remaining > 0) {
    playWarningSound();
    showQuantityWarning("âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ù„Ø´Ù‡Ø§Ø¯Ø© Ù‚Ù„ÙŠÙ„Ø© Ø¬Ø¯Ø§Ù‹ - Ø£Ù‚Ù„ Ù…Ù† 10%");
  }
}

// Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª - Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„
function updateCertRemainingMobile() {
  const total = parseFloat(document.getElementById('certTotalQuantity-mobile').value) || 0;
  const deducted = parseFloat(document.getElementById('certDeductedQuantity-mobile').value) || 0;
  const remaining = total - deducted;
  document.getElementById('certRemainingQuantity-mobile').value = remaining;

  // ØªÙ†Ø¨ÙŠÙ‡ Ù†ÙØ§Ø¯ Ø§Ù„ÙƒÙ…ÙŠØ© Ù…Ø¹ ØµÙˆØª
  if (remaining <= 0 && total > 0) {
    playWarningSound();
    showQuantityWarning("âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù‚Ø¯ Ù†ÙØ°Øª ØªÙ…Ø§Ù…Ø§Ù‹!");
  } else if (remaining <= (total * 0.1) && total > 0 && remaining > 0) {
    playWarningSound();
    showQuantityWarning("âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ù„Ø´Ù‡Ø§Ø¯Ø© Ù‚Ù„ÙŠÙ„Ø© Ø¬Ø¯Ø§Ù‹ - Ø£Ù‚Ù„ Ù…Ù† 10%");
  }
}

// Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
async function saveCertCertificate() {
  // ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„ Ø£Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
  let cert;
  
  // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù…Ø±Ø¦ÙŠØ© ÙˆÙ„Ù‡Ø§ Ù‚ÙŠÙ…
  const mobileForm = document.querySelector('.mobile-form');
  const isMobile = window.innerWidth <= 768 || (mobileForm && getComputedStyle(mobileForm).display !== 'none');
  
  if (isMobile) {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„
    cert = {
      company: document.getElementById('certCompany-mobile').value.trim(),
      borderSerial: document.getElementById('certBorderSerial-mobile').value.trim(),
      certificateNumber: document.getElementById('certCertificateNumber-mobile').value.trim(),
      certificateDate: document.getElementById('certCertificateDate-mobile').value,
      totalQuantity: parseFloat(document.getElementById('certTotalQuantity-mobile').value) || 0,
      deductedQuantity: parseFloat(document.getElementById('certDeductedQuantity-mobile').value) || 0,
      unit: document.getElementById('certUnit-mobile').value,
      itemType: document.getElementById('certItemType-mobile').value.trim()
    };
  } else {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„
    cert = {
      company: document.getElementById('certCompany').value.trim(),
      borderSerial: document.getElementById('certBorderSerial').value.trim(),
      certificateNumber: document.getElementById('certCertificateNumber').value.trim(),
      certificateDate: document.getElementById('certCertificateDate').value,
      totalQuantity: parseFloat(document.getElementById('certTotalQuantity').value) || 0,
      deductedQuantity: parseFloat(document.getElementById('certDeductedQuantity').value) || 0,
      unit: document.getElementById('certUnit').value,
      itemType: document.getElementById('certItemType').value.trim()
    };
  }

  if (!cert.company || !cert.borderSerial || !cert.certificateNumber || !cert.certificateDate || !cert.totalQuantity || !cert.itemType) {
    showAlert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒØ§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ø´Ù‡Ø§Ø¯Ø© (Ø§Ù„Ø´Ø±ÙƒØ©ØŒ Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø­Ø¯ÙˆØ¯ÙŠØŒ Ø±Ù‚Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©ØŒ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©ØŒ Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©ØŒ ÙˆØ§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©).", 'error');
    return;
  }

  // ØªØ­Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ ØªØ¹Ø¯ÙŠÙ„ Ø£Ù… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯
  const isEditing = window.editingCertificateId;
  
  // Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  try {
    const url = isEditing ? `/api/certificates/${window.editingCertificateId}` : '/api/certificates';
    const method = isEditing ? 'PUT' : 'POST';
    
    const response = await fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        company: cert.company,
        border_serial: cert.borderSerial,
        certificate_number: cert.certificateNumber,
        certificate_date: cert.certificateDate,
        total_quantity: cert.totalQuantity,
        deducted_quantity: cert.deductedQuantity,
        remaining_quantity: cert.totalQuantity - cert.deductedQuantity,
        unit: cert.unit,
        item_type: cert.itemType
      })
    });

    const result = await response.json();
    
    if (result.success) {
      const message = isEditing ? 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª' : 'âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
      showAlert(message, 'success');
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      if (isEditing) {
        window.editingCertificateId = null;
      }
      
      // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
      if (isMobile) {
        document.getElementById('certCompany-mobile').value = '';
        document.getElementById('certBorderSerial-mobile').value = '';
        document.getElementById('certCertificateNumber-mobile').value = '';
        document.getElementById('certCertificateDate-mobile').value = '';
        document.getElementById('certTotalQuantity-mobile').value = '';
        document.getElementById('certDeductedQuantity-mobile').value = '';
        document.getElementById('certRemainingQuantity-mobile').value = '';
        document.getElementById('certUnit-mobile').value = 'Ø·Ù†';
        document.getElementById('certItemType-mobile').value = '';
      } else {
        document.getElementById('certCompany').value = '';
        document.getElementById('certBorderSerial').value = '';
        document.getElementById('certCertificateNumber').value = '';
        document.getElementById('certCertificateDate').value = '';
        document.getElementById('certTotalQuantity').value = '';
        document.getElementById('certDeductedQuantity').value = '';
        document.getElementById('certRemainingQuantity').value = '';
        document.getElementById('certUnit').value = 'Ø·Ù†';
        document.getElementById('certItemType').value = '';
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      updateCertificatesStats();
    } else {
      showAlert(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©: ${result.message}`, 'error');
    }
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©:', error);
    showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
  }
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
async function openCertModal() {
  try {
    const response = await fetch('/api/certificates');
    const result = await response.json();
    
    if (result.success && result.certificates) {
      displayCertificatesModal(result.certificates);
    } else {
      showAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ù‡Ø§Ø¯Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'info');
    }
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª:', error);
    showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
  }
}

// Ø¹Ø±Ø¶ modal Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
function displayCertificatesModal(certificates) {
  let modalHtml = `
    <div id="certModal" class="modal">
      <div class="modal-content" style="width: 95%; max-width: 1400px;">
        <div class="modal-header">
          <span class="close" onclick="closeCertModal()">&times;</span>
          <h2>ğŸ“œ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© (${certificates.length})</h2>
        </div>
        <div class="modal-body">
          <div class="table-container">
            <table class="styled-table full-width">
              <thead>
                <tr>
                  <th>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</th>
                  <th>Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø­Ø¯ÙˆØ¯ÙŠ</th>
                  <th>Ø±Ù‚Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</th>
                  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</th>
                  <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©</th>
                  <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                  <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‚Ø·Ø¹Ø©</th>
                  <th>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©</th>
                  <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
                  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­ÙØ¸</th>
                  <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</th>
                </tr>
              </thead>
              <tbody>
  `;
  
  certificates.forEach((cert, index) => {
    const remaining = parseFloat(cert.remainingQuantity) || 0;
    const isExpired = remaining <= 0;
    const rowClass = isExpired ? 'expired-row' : '';
    
    modalHtml += `
      <tr class="${rowClass}">
        <td data-label="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©">${cert.company}</td>
        <td data-label="Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø­Ø¯ÙˆØ¯ÙŠ">${cert.borderSerial}</td>
        <td data-label="Ø±Ù‚Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©">${cert.certificateNumber}</td>
        <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©">${cert.certificateDate}</td>
        <td data-label="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©">${cert.totalQuantity}</td>
        <td data-label="Ø§Ù„ÙˆØ­Ø¯Ø©">${cert.unit}</td>
        <td data-label="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‚Ø·Ø¹Ø©">${cert.deductedQuantity}</td>
        <td data-label="Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©">${cert.itemType}</td>
        <td data-label="Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©" style="color: ${isExpired ? '#f44336' : 'inherit'}; font-weight: ${isExpired ? 'bold' : 'normal'};">
          ${cert.remainingQuantity}
          ${isExpired ? '<span style="color: #f44336; font-size: 10px; display: block;">âš ï¸ Ù†Ø§ÙØ°Ø©</span>' : ''}
        </td>
        <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­ÙØ¸">${cert.savedAt}</td>
        <td data-label="Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª">
          <button onclick="editCertificate(${cert.id})" class="edit-btn" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button onclick="deleteCertificate(${cert.id})" class="delete-btn" title="Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </td>
      </tr>
    `;
  });
  
  modalHtml += `
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ modal Ù…ÙˆØ¬ÙˆØ¯
  const existingModal = document.getElementById('certModal');
  if (existingModal) {
    existingModal.remove();
  }
  
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù€ modal Ø§Ù„Ø¬Ø¯ÙŠØ¯
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  document.getElementById('certModal').style.display = 'block';
}

// Ø¥ØºÙ„Ø§Ù‚ modal Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
function closeCertModal() {
  const modal = document.getElementById('certModal');
  if (modal) {
    modal.remove();
  }
}

// ØªØ¹Ø¯ÙŠÙ„ Ø´Ù‡Ø§Ø¯Ø©
async function editCertificateOld(certId) {
  try {
    const response = await fetch(`/api/certificates/${certId}`);
    const result = await response.json();
    
    if (result.success && result.certificate) {
      const cert = result.certificate;
      
      // Ù…Ù„Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      const isMobile = window.innerWidth <= 768;
      
      if (isMobile) {
        document.getElementById('certCompany-mobile').value = cert.company;
        document.getElementById('certBorderSerial-mobile').value = cert.borderSerial;
        document.getElementById('certCertificateNumber-mobile').value = cert.certificateNumber;
        document.getElementById('certCertificateDate-mobile').value = cert.certificateDate;
        document.getElementById('certTotalQuantity-mobile').value = cert.totalQuantity;
        document.getElementById('certDeductedQuantity-mobile').value = cert.deductedQuantity;
        document.getElementById('certUnit-mobile').value = cert.unit;
        document.getElementById('certItemType-mobile').value = cert.itemType;
        updateCertRemainingMobile();
      } else {
        document.getElementById('certCompany').value = cert.company;
        document.getElementById('certBorderSerial').value = cert.borderSerial;
        document.getElementById('certCertificateNumber').value = cert.certificateNumber;
        document.getElementById('certCertificateDate').value = cert.certificateDate;
        document.getElementById('certTotalQuantity').value = cert.totalQuantity;
        document.getElementById('certDeductedQuantity').value = cert.deductedQuantity;
        document.getElementById('certUnit').value = cert.unit;
        document.getElementById('certItemType').value = cert.itemType;
        updateCertRemaining();
      }
      
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù€ modal ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
      closeCertModal();
      showTab('cert-certificates');
      
      // Ø­ÙØ¸ ID Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ« Ù„Ø§Ø­Ù‚Ø§Ù‹
      window.editingCertId = certId;
      showAlert('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„', 'info');
    }
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©:', error);
    showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©', 'error');
  }
}

// Ø­Ø°Ù Ø´Ù‡Ø§Ø¯Ø©
async function deleteCertificate(certId) {
  if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) {
    return;
  }
  
  try {
    const response = await fetch(`/api/certificates/${certId}`, {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (result.success) {
      showAlert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
      closeCertModal();
      updateCertificatesStats();
    } else {
      showAlert(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©: ${result.message}`, 'error');
    }
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©:', error);
    showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
  }
}

// Ø¯Ø§Ù„Ø© ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù„Ù„ØªØ­Ø°ÙŠØ±
async function checkCertStatus(certNumber) {
  if (!certNumber) return true;
  
  // ÙØ­Øµ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
  const savedCertificates = JSON.parse(localStorage.getItem('savedCertificates') || '[]');
  const existingCert = savedCertificates.find(cert => cert.certificateNumber === certNumber);
  
  if (existingCert) {
    const remaining = parseFloat(existingCert.remainingQuantity) || 0;
    return remaining > 0;
  }
  
  return true; // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©ØŒ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
}

// ØªÙ… Ø­Ø°Ù Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª - Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ±ÙƒØ² ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª

// Ù…Ù„Ø¡ ÙÙ„Ø§ØªØ± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
function populateCertificatesFilters(certificates) {
  const companyFilter = document.getElementById('certificatesCompanyFilter');
  const itemFilter = document.getElementById('certificatesItemFilter');
  
  if (!companyFilter || !itemFilter) return;
  
  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
  companyFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø±ÙƒØ§Øª</option>';
  itemFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>';
  
  // Ø¬Ù…Ø¹ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙØ±ÙŠØ¯Ø©
  const companies = [...new Set(certificates.map(cert => cert.company))];
  const items = [...new Set(certificates.map(cert => cert.itemType))];
  
  // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ§Øª
  companies.forEach(company => {
    if (company) {
      const option = document.createElement('option');
      option.value = company;
      option.textContent = company;
      companyFilter.appendChild(option);
    }
  });
  
  // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±Ø§Øª Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¨Ø¶Ø§Ø¦Ø¹
  items.forEach(item => {
    if (item) {
      const option = document.createElement('option');
      option.value = item;
      option.textContent = item;
      itemFilter.appendChild(option);
    }
  });
}

// ÙÙ„ØªØ±Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
function filterCertificates() {
  let certificates = JSON.parse(localStorage.getItem('savedCertificates') || '[]');
  
  const companyFilter = document.getElementById('certificatesCompanyFilter');
  const itemFilter = document.getElementById('certificatesItemFilter');
  const statusFilter = document.getElementById('certificatesStatusFilter');
  const dateFromFilter = document.getElementById('certificatesDateFrom');
  const dateToFilter = document.getElementById('certificatesDateTo');
  
  if (!companyFilter || !itemFilter || !statusFilter) return;
  
  // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±
  if (companyFilter.value) {
    certificates = certificates.filter(cert => cert.company === companyFilter.value);
  }
  
  if (itemFilter.value) {
    certificates = certificates.filter(cert => cert.itemType === itemFilter.value);
  }
  
  if (statusFilter.value) {
    certificates = certificates.filter(cert => {
      const remaining = parseFloat(cert.remainingQuantity) || 0;
      if (statusFilter.value === 'expired') return remaining <= 0;
      if (statusFilter.value === 'low') return remaining > 0 && remaining <= (cert.totalQuantity * 0.1);
      if (statusFilter.value === 'available') return remaining > (cert.totalQuantity * 0.1);
      return true;
    });
  }
  
  // ÙÙ„ØªØ±Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
  if (dateFromFilter && dateFromFilter.value) {
    certificates = certificates.filter(cert => cert.certificateDate >= dateFromFilter.value);
  }
  
  if (dateToFilter && dateToFilter.value) {
    certificates = certificates.filter(cert => cert.certificateDate <= dateToFilter.value);
  }
  
  displayFilteredCertificates(certificates);
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
function displayFilteredCertificates(certificates) {
  const tbody = document.getElementById('savedCertificatesList');
  tbody.innerHTML = '';

  if (certificates.length === 0) {
    tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙÙ„ØªØ±Ø©</td></tr>';
  } else {
    certificates.forEach((cert, index) => {
      const remaining = parseFloat(cert.remainingQuantity) || 0;
      const isExpired = remaining <= 0;
      const isLow = remaining <= (cert.totalQuantity * 0.1);
      
      const row = document.createElement('tr');
      if (isExpired) {
        row.style.backgroundColor = '#ffebee';
        row.style.color = '#c62828';
      } else if (isLow) {
        row.style.backgroundColor = '#fff3e0';
        row.style.color = '#ef6c00';
      }
      
      row.innerHTML = `
        <td data-label="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©">${cert.company}</td>
        <td data-label="Ø±Ù‚Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©">${cert.certificateNumber}</td>
        <td data-label="Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø­Ø¯ÙˆØ¯ÙŠ">${cert.borderSerial}</td>
        <td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®">${cert.certificateDate}</td>
        <td data-label="Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©">${cert.itemType}</td>
        <td data-label="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©">${cert.totalQuantity}</td>
        <td data-label="Ø§Ù„Ù…Ø³ØªÙ‚Ø·Ø¹Ø©">${cert.deductedQuantity}</td>
        <td data-label="Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©" style="${isExpired ? 'color: #f44336; font-weight: bold;' : ''}">${cert.remainingQuantity}</td>
        <td data-label="Ø§Ù„ÙˆØ­Ø¯Ø©">${cert.unit}</td>
        <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­ÙØ¸">${cert.savedAt}</td>
        <td data-label="Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª">
          <button onclick="editSavedCertificate(${index})" class="edit-btn">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button onclick="deleteSavedCertificate(${index})" class="delete-btn">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  }
}

// Ø¥Ø²Ø§Ù„Ø© ÙÙ„Ø§ØªØ± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
function clearCertificatesFilters() {
  const companyFilter = document.getElementById('certificatesCompanyFilter');
  const itemFilter = document.getElementById('certificatesItemFilter');
  const statusFilter = document.getElementById('certificatesStatusFilter');
  const dateFromFilter = document.getElementById('certificatesDateFrom');
  const dateToFilter = document.getElementById('certificatesDateTo');
  
  if (companyFilter) companyFilter.value = '';
  if (itemFilter) itemFilter.value = '';
  if (statusFilter) statusFilter.value = '';
  if (dateFromFilter) dateFromFilter.value = '';
  if (dateToFilter) dateToFilter.value = '';
  
  filterCertificates();
}

// Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø£Ø¹Ù…Ù‚ Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª
function displayFilteredCertificates(certificates) {
  const tbody = document.getElementById('savedCertificatesList');
  tbody.innerHTML = '';

  if (certificates.length === 0) {
    tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙÙ„ØªØ±Ø©</td></tr>';
  } else {
    certificates.forEach((cert, index) => {
      const remaining = parseFloat(cert.remainingQuantity) || 0;
      const isExpired = remaining <= 0;
      const isLow = remaining <= (cert.totalQuantity * 0.1);
      
      const row = document.createElement('tr');
      if (isExpired) {
        row.style.backgroundColor = '#ffebee';
        row.style.color = '#c62828';
      } else if (isLow) {
        row.style.backgroundColor = '#fff3e0';
        row.style.color = '#ef6c00';
      }
      
      row.innerHTML = `
        <td data-label="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©">${cert.company}</td>
        <td data-label="Ø±Ù‚Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©">${cert.certificateNumber}</td>
        <td data-label="Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø­Ø¯ÙˆØ¯ÙŠ">${cert.borderSerial}</td>
        <td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®">${cert.certificateDate}</td>
        <td data-label="Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©">${cert.itemType}</td>
        <td data-label="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©">${cert.totalQuantity}</td>
        <td data-label="Ø§Ù„Ù…Ø³ØªÙ‚Ø·Ø¹Ø©">${cert.deductedQuantity}</td>
        <td data-label="Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©" style="${isExpired ? 'color: #f44336; font-weight: bold;' : ''}">${cert.remainingQuantity}</td>
        <td data-label="Ø§Ù„ÙˆØ­Ø¯Ø©">${cert.unit}</td>
        <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­ÙØ¸">${cert.savedAt}</td>
        <td data-label="Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª">
          <button onclick="editCertificate(this, ${index})" class="edit-btn">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button onclick="deleteCertificate(this, ${index})" class="delete-btn">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  }
}

// Ø¯ÙˆØ§Ù„ ÙÙ„ØªØ±Ø© Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª (Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©)
function populateExemptionsFilters(certificates) {
  const companyFilter = document.getElementById('exemptionsCompanyFilter');
  const itemFilter = document.getElementById('exemptionsItemFilter');
  
  if (!companyFilter || !itemFilter) return;
  
  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
  companyFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø±ÙƒØ§Øª</option>';
  itemFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>';
  
  // Ø¬Ù…Ø¹ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙØ±ÙŠØ¯Ø©
  const companies = [...new Set(certificates.map(cert => cert.company))];
  const items = [...new Set(certificates.map(cert => cert.itemType))];
  
  // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ§Øª
  companies.forEach(company => {
    if (company) {
      const option = document.createElement('option');
      option.value = company;
      option.textContent = company;
      companyFilter.appendChild(option);
    }
  });
  
  // Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±Ø§Øª Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¨Ø¶Ø§Ø¦Ø¹
  items.forEach(item => {
    if (item) {
      const option = document.createElement('option');
      option.value = item;
      option.textContent = item;
      itemFilter.appendChild(option);
    }
  });
}

function displayExemptions(certificates) {
  const tbody = document.getElementById('certificatesList');
  tbody.innerHTML = '';

  if (certificates.length === 0) {
    tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø¹ÙØ§Ø¡Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</td></tr>';
  } else {
    certificates.forEach((cert, index) => {
      const remaining = parseFloat(cert.remainingQuantity) || 0;
      const isExpired = remaining <= 0;
      const isLow = remaining <= (cert.totalQuantity * 0.1);
      
      const row = document.createElement('tr');
      if (isExpired) {
        row.style.backgroundColor = '#ffebee';
        row.style.color = '#c62828';
      } else if (isLow) {
        row.style.backgroundColor = '#fff3e0';
        row.style.color = '#ef6c00';
      }
      
      row.innerHTML = `
        <td data-label="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©">${cert.company}</td>
        <td data-label="Ø±Ù‚Ù… Ø§Ù„Ø§Ø¹ÙØ§Ø¡">${cert.certificateNumber}</td>
        <td data-label="Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø­Ø¯ÙˆØ¯ÙŠ">${cert.borderSerial}</td>
        <td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®">${cert.certificateDate}</td>
        <td data-label="Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©">${cert.itemType}</td>
        <td data-label="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©">${cert.totalQuantity}</td>
        <td data-label="Ø§Ù„Ù…Ø³ØªÙ‚Ø·Ø¹Ø©">${cert.deductedQuantity}</td>
        <td data-label="Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©" style="${isExpired ? 'color: #f44336; font-weight: bold;' : ''}">${cert.remainingQuantity}</td>
        <td data-label="Ø§Ù„ÙˆØ­Ø¯Ø©">${cert.unit}</td>
        <td data-label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­ÙØ¸">${cert.savedAt}</td>
        <td data-label="Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª">
          <button onclick="editCertificateFromDB(${cert.id})" class="edit-btn">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button onclick="deleteCertificateFromDB(${cert.id})" class="delete-btn">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  }
}

async function filterExemptions() {
  try {
    const response = await fetch('/api/certificates');
    const result = await response.json();
    
    if (!result.success) return;

    let certificates = result.certificates;
    
    const companyFilter = document.getElementById('exemptionsCompanyFilter');
    const itemFilter = document.getElementById('exemptionsItemFilter');
    const statusFilter = document.getElementById('exemptionsStatusFilter');
    const dateFromFilter = document.getElementById('exemptionsDateFrom');
    const dateToFilter = document.getElementById('exemptionsDateTo');
    
    if (!companyFilter || !itemFilter || !statusFilter) return;
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±
    if (companyFilter.value) {
      certificates = certificates.filter(cert => cert.company === companyFilter.value);
    }
    
    if (itemFilter.value) {
      certificates = certificates.filter(cert => cert.itemType === itemFilter.value);
    }
    
    if (statusFilter.value) {
      certificates = certificates.filter(cert => {
        const remaining = parseFloat(cert.remainingQuantity) || 0;
        if (statusFilter.value === 'expired') return remaining <= 0;
        if (statusFilter.value === 'low') return remaining > 0 && remaining <= (cert.totalQuantity * 0.1);
        if (statusFilter.value === 'available') return remaining > (cert.totalQuantity * 0.1);
        return true;
      });
    }
    
    // ÙÙ„ØªØ±Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®
    if (dateFromFilter && dateFromFilter.value) {
      certificates = certificates.filter(cert => cert.certificateDate >= dateFromFilter.value);
    }
    
    if (dateToFilter && dateToFilter.value) {
      certificates = certificates.filter(cert => cert.certificateDate <= dateToFilter.value);
    }
    
    displayExemptions(certificates);
  } catch (error) {
    console.error('Error filtering exemptions:', error);
  }
}

function clearExemptionsFilters() {
  const companyFilter = document.getElementById('exemptionsCompanyFilter');
  const itemFilter = document.getElementById('exemptionsItemFilter');
  const statusFilter = document.getElementById('exemptionsStatusFilter');
  const dateFromFilter = document.getElementById('exemptionsDateFrom');
  const dateToFilter = document.getElementById('exemptionsDateTo');
  
  if (companyFilter) companyFilter.value = '';
  if (itemFilter) itemFilter.value = '';
  if (statusFilter) statusFilter.value = '';
  if (dateFromFilter) dateFromFilter.value = '';
  if (dateToFilter) dateToFilter.value = '';
  
  filterExemptions();
}

// ØªÙ… Ø­Ø°Ù Ø¯Ø§Ù„Ø© Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª - Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ±ÙƒØ² ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª

// Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ (Ø¥Ø¹ÙØ§Ø¡Ø§Øª + Ø´Ù‡Ø§Ø¯Ø§Øª)
async function printCombinedReport() {
  try {
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
    const exemptionsResponse = await fetch('/api/certificates');
    const exemptionsResult = await exemptionsResponse.json();
    
    // Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
    const certificates = JSON.parse(localStorage.getItem('savedCertificates') || '[]');
    
    if ((!exemptionsResult.success || exemptionsResult.certificates.length === 0) && certificates.length === 0) {
      showAlert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©', 'error');
      return;
    }

    const exemptions = exemptionsResult.success ? exemptionsResult.certificates : [];
    
    const printWindow = window.open('', '_blank');
    
    printWindow.document.write(`
      <!DOCTYPE html>
      <html lang="ar" dir="rtl">
      <head>
        <meta charset="UTF-8">
        <title>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„ - ÙƒÙ…Ø§Ø±Ùƒ Ø§Ù„Ø¹Ø±Ø§Ù‚</title>
        <style>
          * { margin: 0; padding: 0; box-sizing: border-box; }
          body { 
            font-family: 'Cairo', Arial, sans-serif; 
            direction: rtl; 
            text-align: right; 
            padding: 20px;
            background: #fff;
          }
          .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #002147;
            padding-bottom: 20px;
          }
          .logos {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          }
          .logo { width: 80px; height: auto; }
          h1, h2, h3, h4 { color: #002147; margin: 5px 0; }
          h1 { font-size: 24px; }
          h2 { font-size: 20px; }
          h3 { font-size: 18px; }
          h4 { font-size: 16px; margin-top: 30px; }
          table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 11px;
          }
          th, td {
            border: 1px solid #002147;
            padding: 6px;
            text-align: center;
            vertical-align: middle;
          }
          th {
            background: linear-gradient(135deg, #002147, #003366);
            color: #ffd700;
            font-weight: bold;
            font-size: 12px;
          }
          .exemptions th {
            background: linear-gradient(135deg, #4caf50, #45a049);
          }
          .certificates th {
            background: linear-gradient(135deg, #2196f3, #1976d2);
          }
          tr:nth-child(even) { background-color: #f8f9fa; }
          tr:nth-child(odd) { background-color: #ffffff; }
          .expired { background-color: #ffebee !important; color: #c62828; }
          .expired-label {
            background: #f44336;
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 8px;
            margin-right: 5px;
          }
          .section-header {
            background: #e3f2fd;
            padding: 15px;
            margin: 20px 0 10px 0;
            border-right: 5px solid #2196f3;
            border-radius: 5px;
          }
          .exemptions-header {
            background: #e8f5e8;
            border-right-color: #4caf50;
          }
          .footer { 
            margin-top: 40px; 
            text-align: center; 
            font-size: 12px;
            border-top: 2px solid #002147;
            padding-top: 20px;
            color: #002147;
          }
          .print-date {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
          }
          @media print {
            body { margin: 0; }
            .header { page-break-inside: avoid; }
            table { page-break-inside: auto; }
            tr { page-break-inside: avoid; }
            .section-header { page-break-after: avoid; }
          }
        </style>
      </head>
      <body>
        <div class="header">
          <div class="logos">
            <img src="https://www2.0zz0.com/2025/05/19/22/510831948.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ø±Ø§Ù‚" class="logo">
            <div style="text-align: center;">
              <h1>ğŸ‡®ğŸ‡¶ Ø¬Ù…Ù‡ÙˆØ±ÙŠØ© Ø§Ù„Ø¹Ø±Ø§Ù‚ ğŸ‡®ğŸ‡¶</h1>
              <h2>ÙˆØ²Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© - Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ÙƒÙ…Ø§Ø±Ùƒ</h2>
              <h3>Ù…Ø±ÙƒØ² ÙƒÙ…Ø±Ùƒ Ø·Ø±ÙŠØ¨ÙŠÙ„ Ø§Ù„Ø­Ø¯ÙˆØ¯ÙŠ 642</h3>
              <h3>ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„ - Ø´Ø¹Ø¨Ø© Ø§Ù„Ù…Ù†ÙØ³Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</h3>
            </div>
            <img src="https://www2.0zz0.com/2025/05/19/22/823371779.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ÙƒÙ…Ø§Ø±Ùƒ" class="logo">
          </div>
          <div class="print-date">
            <strong>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©:</strong> ${new Date().toLocaleString('en-GB')}
          </div>
        </div>
    `);
    
    // Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª
    if (exemptions.length > 0) {
      printWindow.document.write(`
        <div class="section-header exemptions-header">
          <h4>ğŸ›ï¸ Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª Ø§Ù„ÙƒÙ…Ø±ÙƒÙŠØ© (${exemptions.length} Ø¥Ø¹ÙØ§Ø¡)</h4>
        </div>
        <table class="exemptions">
          <thead>
            <tr>
              <th>Øª</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¹ÙØ§Ø¡</th>
              <th>Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø­Ø¯ÙˆØ¯ÙŠ</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©</th>
              <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©</th>
              <th>Ø§Ù„Ù…Ø³ØªÙ‚Ø·Ø¹Ø©</th>
              <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
              <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            </tr>
          </thead>
          <tbody>
      `);
      
      exemptions.forEach((cert, index) => {
        const remaining = parseFloat(cert.remainingQuantity) || 0;
        const isExpired = remaining <= 0;
        const rowClass = isExpired ? 'expired' : '';
        const status = isExpired ? 'Ù†Ø§ÙØ°Ø© âŒ' : remaining <= (cert.totalQuantity * 0.1) ? 'Ù‚Ù„ÙŠÙ„Ø© âš ï¸' : 'Ù…ØªØ§Ø­Ø© âœ…';
        
        printWindow.document.write(`
          <tr class="${rowClass}">
            <td>${index + 1}${isExpired ? '<span class="expired-label">Ù†Ø§ÙØ°Ø©</span>' : ''}</td>
            <td>${cert.company}</td>
            <td>${cert.certificateNumber}</td>
            <td>${cert.borderSerial}</td>
            <td>${cert.certificateDate}</td>
            <td>${cert.itemType}</td>
            <td>${cert.totalQuantity}</td>
            <td>${cert.deductedQuantity}</td>
            <td style="${isExpired ? 'color: #f44336; font-weight: bold;' : ''}">${cert.remainingQuantity}</td>
            <td>${cert.unit}</td>
            <td style="${isExpired ? 'color: #f44336; font-weight: bold;' : remaining <= (cert.totalQuantity * 0.1) ? 'color: #ff9800; font-weight: bold;' : 'color: #4caf50; font-weight: bold;'}">${status}</td>
          </tr>
        `);
      });
      
      printWindow.document.write(`
          </tbody>
        </table>
      `);
    }
    
    // Ù‚Ø³Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
    if (certificates.length > 0) {
      printWindow.document.write(`
        <div class="section-header">
          <h4>ğŸ“‹ Ù‚Ø³Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª (${certificates.length} Ø´Ù‡Ø§Ø¯Ø©)</h4>
        </div>
        <table class="certificates">
          <thead>
            <tr>
              <th>Øª</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</th>
              <th>Ø±Ù‚Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</th>
              <th>Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø­Ø¯ÙˆØ¯ÙŠ</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©</th>
              <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©</th>
              <th>Ø§Ù„Ù…Ø³ØªÙ‚Ø·Ø¹Ø©</th>
              <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
              <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            </tr>
          </thead>
          <tbody>
      `);
      
      certificates.forEach((cert, index) => {
        const remaining = parseFloat(cert.remainingQuantity) || 0;
        const isExpired = remaining <= 0;
        const rowClass = isExpired ? 'expired' : '';
        const status = isExpired ? 'Ù†Ø§ÙØ°Ø© âŒ' : remaining <= (cert.totalQuantity * 0.1) ? 'Ù‚Ù„ÙŠÙ„Ø© âš ï¸' : 'Ù…ØªØ§Ø­Ø© âœ…';
        
        printWindow.document.write(`
          <tr class="${rowClass}">
            <td>${index + 1}${isExpired ? '<span class="expired-label">Ù†Ø§ÙØ°Ø©</span>' : ''}</td>
            <td>${cert.company}</td>
            <td>${cert.certificateNumber}</td>
            <td>${cert.borderSerial}</td>
            <td>${cert.certificateDate}</td>
            <td>${cert.itemType}</td>
            <td>${cert.totalQuantity}</td>
            <td>${cert.deductedQuantity}</td>
            <td style="${isExpired ? 'color: #f44336; font-weight: bold;' : ''}">${cert.remainingQuantity}</td>
            <td>${cert.unit}</td>
            <td style="${isExpired ? 'color: #f44336; font-weight: bold;' : remaining <= (cert.totalQuantity * 0.1) ? 'color: #ff9800; font-weight: bold;' : 'color: #4caf50; font-weight: bold;'}">${status}</td>
          </tr>
        `);
      });
      
      printWindow.document.write(`
          </tbody>
        </table>
      `);
    }
    
    // Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ø®Ø§ØªÙ…Ø©
    const totalExemptions = exemptions.length;
    const totalCertificates = certificates.length;
    const expiredExemptions = exemptions.filter(c => (parseFloat(c.remainingQuantity) || 0) <= 0).length;
    const expiredCertificates = certificates.filter(c => (parseFloat(c.remainingQuantity) || 0) <= 0).length;
    
    printWindow.document.write(`
        <div class="footer">
          <h4>ğŸ–¥ï¸ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª ÙˆØ§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª - Ø§Ù„ÙƒÙ…Ø§Ø±Ùƒ Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠØ©</h4>
          <p><strong>Ø§Ù„Ù…Ø·ÙˆØ±:</strong> Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯ Ø§Ù„Ù‚Ø§Ø¯Ø± Ù…Ø´Ø­Ù† Ø§Ù„Ø¹Ø¨ÙŠØ¯ÙŠ</p>
          <p><strong>ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> alobaidymo@gmail.com</p>
          <p><strong>ğŸ“± Ø§Ù„Ù‡Ø§ØªÙ:</strong> +9647768525871</p>
          <hr>
          <p><strong>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„:</strong></p>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 15px 0;">
            <div>
              <h5>ğŸ›ï¸ Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª:</h5>
              <p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${totalExemptions} | Ø§Ù„Ù†Ø§ÙØ°Ø©: ${expiredExemptions} | Ø§Ù„Ù…ØªØ§Ø­Ø©: ${totalExemptions - expiredExemptions}</p>
            </div>
            <div>
              <h5>ğŸ“‹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª:</h5>
              <p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${totalCertificates} | Ø§Ù„Ù†Ø§ÙØ°Ø©: ${expiredCertificates} | Ø§Ù„Ù…ØªØ§Ø­Ø©: ${totalCertificates - expiredCertificates}</p>
            </div>
          </div>
          <p><strong>ğŸ“ˆ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</strong> ${totalExemptions + totalCertificates} ÙˆØ«ÙŠÙ‚Ø©</p>
          <p style="font-size: 10px; color: #666;">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª ÙˆØ§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ± Ø¨ØªÙ‚Ù†ÙŠØ§Øª Ø­Ø¯ÙŠØ«Ø©</p>
        </div>
      </body>
      </html>
    `);
    
    printWindow.document.close();
    
    printWindow.onload = () => {
      setTimeout(() => {
        printWindow.print();
      }, 1000);
    };
    
  } catch (error) {
    console.error('Error printing combined report:', error);
    showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„', 'error');
  }
}

async function updateCertificatesStats() {
  try {
    // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const exemptionResponse = await fetch('/api/exemptions');
    const exemptionResult = await exemptionResponse.json();
    const totalExemptions = exemptionResult.success ? exemptionResult.exemptions.length : 0;
    
    // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const certificateResponse = await fetch('/api/certificates');
    const certificateResult = await certificateResponse.json();
    const totalCertificates = certificateResult.success ? certificateResult.certificates.length : 0;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    const exemptionsCountElement = document.getElementById('exemptionsCount');
    const certificatesCountElement = document.getElementById('certificatesCount');
    
    if (exemptionsCountElement) exemptionsCountElement.textContent = totalExemptions;
    if (certificatesCountElement) certificatesCountElement.textContent = totalCertificates;
    
    // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
    const backupCount = document.getElementById('backupCount');
    if (backupCount) {
      backupCount.textContent = totalExemptions + totalCertificates;
    }
    
    console.log(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª: ${totalExemptions}`);
    console.log(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª: ${totalCertificates}`);
    
  } catch (error) {
    console.error('Error updating stats:', error);
    const exemptionsCountElement = document.getElementById('exemptionsCount');
    const certificatesCountElement = document.getElementById('certificatesCount');
    
    if (exemptionsCountElement) exemptionsCountElement.textContent = 'âŒ';
    if (certificatesCountElement) certificatesCountElement.textContent = 'âŒ';
  }
}

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù Ù„Ù„Ø§Ø¹ÙØ§Ø¡Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©  
function editExemption(button, id) {
  // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹
  let exemptions = JSON.parse(localStorage.getItem('certificates') || '[]');
  let exemption = exemptions.find(item => item.id == id);
  let isLocal = true;
  
  // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ù…Ø­Ù„ÙŠØ§Ù‹ØŒ Ø¬Ù„Ø¨Ù‡Ø§ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
  if (!exemption) {
    isLocal = false;
    fetch('/api/certificates')
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          exemption = result.certificates.find(item => item.id == id);
          if (exemption) {
            showEditExemptionModal(exemption, id, false);
          }
        }
      });
    return;
  }
  
  showEditExemptionModal(exemption, id, true);
}

function showEditExemptionModal(exemption, id, isLocal) {
  
  // Ù…Ù„Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  const editModal = document.createElement('div');
  editModal.className = 'modal';
  editModal.style.display = 'block';
  editModal.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <h3 style="color: #002147; text-align: center; margin-bottom: 25px;">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¹ÙØ§Ø¡</h3>
      <form id="editExemptionForm">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©:</label>
            <input type="text" id="edit-company" value="${exemption.company || ''}" required>
          </div>
          <div>
            <label>Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø­Ø¯ÙˆØ¯ÙŠ(c):</label>
            <input type="text" id="edit-borderSerial" value="${exemption.borderSerial || ''}" required>
          </div>
          <div>
            <label>Ø±Ù‚Ù… ÙƒØªØ§Ø¨ Ø§Ù„Ø§Ø¹ÙØ§Ø¡:</label>
            <input type="text" id="edit-certificateNumber" value="${exemption.certificateNumber || ''}" required>
          </div>
          <div>
            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
            <input type="date" id="edit-certificateDate" value="${exemption.certificateDate || ''}" required>
          </div>
          <div>
            <label>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©:</label>
            <input type="number" id="edit-totalQuantity" value="${exemption.totalQuantity || 0}" oninput="updateEditRemaining()" required>
          </div>
          <div>
            <label>Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
            <select id="edit-unit">
              <option value="Ø·Ù†" ${exemption.unit === 'Ø·Ù†' ? 'selected' : ''}>Ø·Ù†</option>
              <option value="Ø¹Ø¯Ø¯" ${exemption.unit === 'Ø¹Ø¯Ø¯' ? 'selected' : ''}>Ø¹Ø¯Ø¯</option>
            </select>
          </div>
          <div>
            <label>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‚Ø·Ø¹Ø©:</label>
            <input type="number" id="edit-deductedQuantity" value="${exemption.deductedQuantity || 0}" oninput="updateEditRemaining()" required>
          </div>
          <div>
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©:</label>
            <input type="text" id="edit-itemType" value="${exemption.itemType || ''}" required>
          </div>
        </div>
        <div style="margin-top: 15px;">
          <label>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:</label>
          <input type="number" id="edit-remainingQuantity" value="${exemption.remainingQuantity || 0}" readonly>
        </div>
        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
          <button type="submit" class="edit-btn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
          <button type="button" class="delete-btn" onclick="closeEditModal(this)">âŒ Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </form>
    </div>
  `;
  
  document.body.appendChild(editModal);
  
  // Ù…Ø¹Ø§Ù„Ø¬ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
  document.getElementById('editExemptionForm').onsubmit = async function(e) {
    e.preventDefault();
    
    const updatedData = {
      company: document.getElementById('edit-company').value,
      borderSerial: document.getElementById('edit-borderSerial').value,
      certificateNumber: document.getElementById('edit-certificateNumber').value,
      certificateDate: document.getElementById('edit-certificateDate').value,
      totalQuantity: parseInt(document.getElementById('edit-totalQuantity').value),
      deductedQuantity: parseInt(document.getElementById('edit-deductedQuantity').value),
      remainingQuantity: parseInt(document.getElementById('edit-remainingQuantity').value),
      itemType: document.getElementById('edit-itemType').value,
      unit: document.getElementById('edit-unit').value
    };
    
    if (isLocal) {
      // Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­Ù„ÙŠ
      let exemptions = JSON.parse(localStorage.getItem('certificates') || '[]');
      const index = exemptions.findIndex(item => item.id == id);
      if (index !== -1) {
        exemptions[index] = { ...exemptions[index], ...updatedData };
        localStorage.setItem('certificates', JSON.stringify(exemptions));
      }
    } else {
      // Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
      try {
        const response = await fetch(`/api/certificates/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedData)
        });
        
        const result = await response.json();
        if (!result.success) {
          showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹ÙØ§Ø¡: ' + result.message, 'error');
          return;
        }
      } catch (error) {
        showAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
        return;
      }
    }
    
    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
    document.body.removeChild(editModal);
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶
    openModal();
    
    showAlert('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¹ÙØ§Ø¡ Ø¨Ù†Ø¬Ø§Ø­', 'success');
  };
}

function deleteExemption(button, id) {
  if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹ÙØ§Ø¡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡')) {
    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
    let exemptions = JSON.parse(localStorage.getItem('certificates') || '[]');
    const localIndex = exemptions.findIndex(item => item.id == id);
    
    if (localIndex !== -1) {
      // Ø­Ø°Ù Ù…Ø­Ù„ÙŠ
      exemptions.splice(localIndex, 1);
      localStorage.setItem('certificates', JSON.stringify(exemptions));
      openModal();
      showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¹ÙØ§Ø¡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹', 'success');
    } else {
      // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
      fetch(`/api/certificates/${id}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            openModal();
            showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¹ÙØ§Ø¡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹', 'success');
          } else {
            showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¥Ø¹ÙØ§Ø¡: ' + result.message, 'error');
          }
        })
        .catch(error => {
          showAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
        });
    }
  }
}

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
// Ø¯Ø§Ù„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø´Ù‡Ø§Ø¯Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function editCertificateFromDB(certId) {
  console.log('Editing certificate from database with ID:', certId);
  
  fetch(`/api/certificates/${certId}`)
    .then(response => {
      console.log('Response status:', response.status);
      console.log('Response headers:', response.headers);
      console.log('Response content-type:', response.headers.get('content-type'));
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const contentType = response.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        throw new Error(`Expected JSON response but got: ${contentType}`);
      }
      
      return response.json();
    })
    .then(data => {
      if (data.success) {
        createEditCertificateModalDB(data.certificate, certId);
      } else {
        showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©: ' + (data.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'), 'error');
      }
    })
    .catch(error => {
      console.error('Error fetching certificate:', error);
      showAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message, 'error');
    });
}

function editCertificateLocal(certificates, index) {
  
  if (index !== undefined && certificates[index]) {
    // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
    const certificate = certificates[index];
    
    // Ù…Ù„Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    const editModal = document.createElement('div');
    editModal.className = 'modal';
    editModal.style.display = 'block';
    editModal.innerHTML = `
      <div class="modal-content" style="max-width: 600px;">
        <h3 style="color: #002147; text-align: center; margin-bottom: 25px;">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</h3>
        <form id="editCertificateForm">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©:</label>
              <input type="text" id="edit-cert-company" value="${certificate.company}" required>
            </div>
            <div>
              <label>Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø­Ø¯ÙˆØ¯ÙŠ(c):</label>
              <input type="text" id="edit-cert-borderSerial" value="${certificate.borderSerial}" required>
            </div>
            <div>
              <label>Ø±Ù‚Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©:</label>
              <input type="text" id="edit-cert-certificateNumber" value="${certificate.certificateNumber}" required>
            </div>
            <div>
              <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
              <input type="date" id="edit-cert-certificateDate" value="${certificate.certificateDate}" required>
            </div>
            <div>
              <label>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©:</label>
              <input type="number" id="edit-cert-totalQuantity" value="${certificate.totalQuantity}" oninput="updateEditCertRemaining()" required>
            </div>
            <div>
              <label>Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
              <select id="edit-cert-unit">
                <option value="Ø·Ù†" ${certificate.unit === 'Ø·Ù†' ? 'selected' : ''}>Ø·Ù†</option>
                <option value="Ø¹Ø¯Ø¯" ${certificate.unit === 'Ø¹Ø¯Ø¯' ? 'selected' : ''}>Ø¹Ø¯Ø¯</option>
              </select>
            </div>
            <div>
              <label>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‚Ø·Ø¹Ù‡:</label>
              <input type="number" id="edit-cert-deductedQuantity" value="${certificate.deductedQuantity}" oninput="updateEditCertRemaining()" required>
            </div>
            <div>
              <label>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©:</label>
              <input type="text" id="edit-cert-itemType" value="${certificate.itemType}" required>
            </div>
          </div>
          <div style="margin-top: 15px;">
            <label>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</label>
            <input type="number" id="edit-cert-remainingQuantity" value="${certificate.remainingQuantity}" readonly>
          </div>
          <div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
            <button type="submit" class="edit-btn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
            <button type="button" class="delete-btn" onclick="closeEditModal(this)">âŒ Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </form>
      </div>
    `;
    
    document.body.appendChild(editModal);
    
    // Ù…Ø¹Ø§Ù„Ø¬ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    document.getElementById('editCertificateForm').onsubmit = function(e) {
      e.preventDefault();
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      certificates[index] = {
        company: document.getElementById('edit-cert-company').value,
        borderSerial: document.getElementById('edit-cert-borderSerial').value,
        certificateNumber: document.getElementById('edit-cert-certificateNumber').value,
        certificateDate: document.getElementById('edit-cert-certificateDate').value,
        totalQuantity: parseInt(document.getElementById('edit-cert-totalQuantity').value),
        deductedQuantity: parseInt(document.getElementById('edit-cert-deductedQuantity').value),
        remainingQuantity: parseInt(document.getElementById('edit-cert-remainingQuantity').value),
        itemType: document.getElementById('edit-cert-itemType').value,
        unit: document.getElementById('edit-cert-unit').value,
        savedAt: certificate.savedAt // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ„ÙŠ
      };
      
      // Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
      localStorage.setItem('savedCertificates', JSON.stringify(certificates));
      
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
      document.body.removeChild(editModal);
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶
      viewCertificates();
      
      showAlert('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
    };
  }
}

function deleteCertificate(button, index) {
  if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡')) {
    const certificates = JSON.parse(localStorage.getItem('savedCertificates') || '[]');
    
    if (index !== undefined && certificates[index]) {
      // Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
      certificates.splice(index, 1);
      
      // Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
      localStorage.setItem('savedCertificates', JSON.stringify(certificates));
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶
      viewCertificates();
      
      showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹', 'success');
    }
  }
}

// Ø¯Ø§Ù„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø´Ù‡Ø§Ø¯Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function createEditCertificateModalDB(certificate, certId) {
  const editModal = document.createElement('div');
  editModal.className = 'modal';
  editModal.style.display = 'block';
  editModal.innerHTML = `
    <div class="modal-content" style="max-width: 600px;">
      <h3 style="color: #002147; text-align: center; margin-bottom: 25px;">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</h3>
      <form id="editCertificateFormDB">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div>
            <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©:</label>
            <input type="text" id="edit-cert-company-db" value="${certificate.company || ''}" required>
          </div>
          <div>
            <label>Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø­Ø¯ÙˆØ¯ÙŠ(c):</label>
            <input type="text" id="edit-cert-borderSerial-db" value="${certificate.border_serial || ''}" required>
          </div>
          <div>
            <label>Ø±Ù‚Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©:</label>
            <input type="text" id="edit-cert-certificateNumber-db" value="${certificate.certificate_number || ''}" required>
          </div>
          <div>
            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
            <input type="date" id="edit-cert-certificateDate-db" value="${certificate.certificate_date || ''}" required>
          </div>
          <div>
            <label>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©:</label>
            <input type="number" id="edit-cert-totalQuantity-db" value="${certificate.total_quantity || 0}" required>
          </div>
          <div>
            <label>Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
            <select id="edit-cert-unit-db">
              <option value="Ø·Ù†" ${certificate.unit === 'Ø·Ù†' ? 'selected' : ''}>Ø·Ù†</option>
              <option value="Ø¹Ø¯Ø¯" ${certificate.unit === 'Ø¹Ø¯Ø¯' ? 'selected' : ''}>Ø¹Ø¯Ø¯</option>
            </select>
          </div>
          <div>
            <label>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‚Ø·Ø¹Ø©:</label>
            <input type="number" id="edit-cert-deductedQuantity-db" value="${certificate.deducted_quantity || 0}" required>
          </div>
          <div>
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©:</label>
            <input type="text" id="edit-cert-itemType-db" value="${certificate.item_type || ''}" required>
          </div>
        </div>
        <div style="text-align: center; margin-top: 25px;">
          <button type="button" onclick="updateCertificateDB(${certId})" class="elegant-button">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
          <button type="button" onclick="closeEditModalDB()" class="elegant-button secondary">âŒ Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </form>
    </div>
  `;
  
  document.body.appendChild(editModal);
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function updateCertificateDB(certId) {
  const formData = {
    company: document.getElementById('edit-cert-company-db').value,
    borderSerial: document.getElementById('edit-cert-borderSerial-db').value,
    certificateNumber: document.getElementById('edit-cert-certificateNumber-db').value,
    certificateDate: document.getElementById('edit-cert-certificateDate-db').value,
    totalQuantity: parseFloat(document.getElementById('edit-cert-totalQuantity-db').value),
    unit: document.getElementById('edit-cert-unit-db').value,
    deductedQuantity: parseFloat(document.getElementById('edit-cert-deductedQuantity-db').value),
    itemType: document.getElementById('edit-cert-itemType-db').value
  };
  
  fetch(`/api/certificates/${certId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(formData)
  })
  .then(response => {
    console.log('Update response status:', response.status);
    console.log('Update response content-type:', response.headers.get('content-type'));
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      throw new Error(`Expected JSON response but got: ${contentType}`);
    }
    
    return response.json();
  })
  .then(result => {
    if (result.success) {
      closeEditModalDB();
      loadCertificatesFromDatabase();
      showAlert('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
    } else {
      showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©: ' + (result.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'), 'error');
    }
  })
  .catch(error => {
    console.error('Error updating certificate:', error);
    showAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message, 'error');
  });
}

function closeEditModalDB() {
  const modal = document.querySelector('.modal');
  if (modal) {
    document.body.removeChild(modal);
  }
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function loadCertificatesFromDatabase() {
  try {
    const response = await fetch('/api/certificates');
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const result = await response.json();
    if (result.success) {
      // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ
      displayExemptions(result.certificates);
      populateExemptionsFilters(result.certificates);
    } else {
      showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª: ' + (result.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'), 'error');
    }
  } catch (error) {
    console.error('Error loading certificates:', error);
    showAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message, 'error');
  }
}

// ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø©
function updateEditRemaining() {
  const total = parseInt(document.getElementById('edit-totalQuantity').value) || 0;
  const deducted = parseInt(document.getElementById('edit-deductedQuantity').value) || 0;
  document.getElementById('edit-remainingQuantity').value = total - deducted;
}

function updateEditCertRemaining() {
  const total = parseInt(document.getElementById('edit-cert-totalQuantity').value) || 0;
  const deducted = parseInt(document.getElementById('edit-cert-deductedQuantity').value) || 0;
  document.getElementById('edit-cert-remainingQuantity').value = total - deducted;
}

function closeEditModal(button) {
  const modal = button.closest('.modal');
  if (modal) {
    document.body.removeChild(modal);
  }
}

function closeSavedCertificatesModal() {
  document.getElementById('savedCertificatesModal').style.display = 'none';
}

// ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­Ø°Ù Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
function editCertificate(button, index) {
  const savedCertificates = JSON.parse(localStorage.getItem('savedCertificates') || '[]');
  
  if (index !== undefined && savedCertificates[index]) {
    const certificate = savedCertificates[index];
    
    // Ù…Ù„Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    const editModal = document.createElement('div');
    editModal.className = 'modal';
    editModal.style.display = 'block';
    editModal.innerHTML = `
      <div class="modal-content" style="max-width: 600px;">
        <h3 style="color: #002147; text-align: center; margin-bottom: 25px;">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</h3>
        <form id="editCertificateForm">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©:</label>
              <input type="text" id="edit-cert-company" value="${certificate.company || ''}" required>
            </div>
            <div>
              <label>Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø­Ø¯ÙˆØ¯ÙŠ(c):</label>
              <input type="text" id="edit-cert-borderSerial" value="${certificate.borderSerial || ''}" required>
            </div>
            <div>
              <label>Ø±Ù‚Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©:</label>
              <input type="text" id="edit-cert-certificateNumber" value="${certificate.certificateNumber || ''}" required>
            </div>
            <div>
              <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
              <input type="date" id="edit-cert-certificateDate" value="${certificate.certificateDate || ''}" required>
            </div>
            <div>
              <label>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©:</label>
              <input type="number" id="edit-cert-totalQuantity" value="${certificate.totalQuantity || 0}" oninput="updateEditCertRemaining()" required>
            </div>
            <div>
              <label>Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
              <select id="edit-cert-unit">
                <option value="Ø·Ù†" ${certificate.unit === 'Ø·Ù†' ? 'selected' : ''}>Ø·Ù†</option>
                <option value="Ø¹Ø¯Ø¯" ${certificate.unit === 'Ø¹Ø¯Ø¯' ? 'selected' : ''}>Ø¹Ø¯Ø¯</option>
              </select>
            </div>
            <div>
              <label>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‚Ø·Ø¹Ù‡:</label>
              <input type="number" id="edit-cert-deductedQuantity" value="${certificate.deductedQuantity || 0}" oninput="updateEditCertRemaining()" required>
            </div>
            <div>
              <label>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©:</label>
              <input type="text" id="edit-cert-itemType" value="${certificate.itemType || ''}" required>
            </div>
          </div>
          <div style="margin-top: 15px;">
            <label>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</label>
            <input type="number" id="edit-cert-remainingQuantity" value="${certificate.remainingQuantity || 0}" readonly>
          </div>
          <div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
            <button type="submit" class="edit-btn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
            <button type="button" class="delete-btn" onclick="closeEditModal(this)">âŒ Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </form>
      </div>
    `;
    
    document.body.appendChild(editModal);
    
    // Ù…Ø¹Ø§Ù„Ø¬ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    document.getElementById('editCertificateForm').onsubmit = function(e) {
      e.preventDefault();
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      savedCertificates[index] = {
        company: document.getElementById('edit-cert-company').value,
        borderSerial: document.getElementById('edit-cert-borderSerial').value,
        certificateNumber: document.getElementById('edit-cert-certificateNumber').value,
        certificateDate: document.getElementById('edit-cert-certificateDate').value,
        totalQuantity: parseInt(document.getElementById('edit-cert-totalQuantity').value),
        deductedQuantity: parseInt(document.getElementById('edit-cert-deductedQuantity').value),
        remainingQuantity: parseInt(document.getElementById('edit-cert-remainingQuantity').value),
        itemType: document.getElementById('edit-cert-itemType').value,
        unit: document.getElementById('edit-cert-unit').value,
        savedAt: certificate.savedAt // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ„ÙŠ
      };
      
      // Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
      localStorage.setItem('savedCertificates', JSON.stringify(savedCertificates));
      
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
      document.body.removeChild(editModal);
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶
      viewCertificates();
      
      showAlert('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
    };
  }
}

async function deleteCertificate(certificateId) {
  if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡')) {
    try {
      const response = await fetch(`/api/certificates/${certificateId}`, {
        method: 'DELETE'
      });
      
      const result = await response.json();
      
      if (result.success) {
        showAlert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success');
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶
        if (typeof renderCertificates === 'function') {
          renderCertificates();
        }
        if (typeof viewCertificates === 'function') {
          viewCertificates();
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        updateCertificatesStats();
      } else {
        showAlert(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©: ${result.message}`, 'error');
      }
    } catch (error) {
      console.error('Error deleting certificate:', error);
      showAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
    }
  }
}

function updateEditCertRemaining() {
  const total = parseInt(document.getElementById('edit-cert-totalQuantity').value) || 0;
  const deducted = parseInt(document.getElementById('edit-cert-deductedQuantity').value) || 0;
  document.getElementById('edit-cert-remainingQuantity').value = total - deducted;
}



// Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª
function getCertificateData() {
  // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
  const company = document.getElementById('company')?.value?.trim();
  const borderSerial = document.getElementById('borderSerial')?.value?.trim();
  const certificateNumber = document.getElementById('certificateNumber')?.value?.trim();
  const certificateDate = document.getElementById('certificateDate')?.value;
  const totalQuantity = document.getElementById('totalQuantity')?.value;
  const deductedQuantity = document.getElementById('deductedQuantity')?.value || '0';
  const unit = document.getElementById('unit')?.value?.trim();
  const itemType = document.getElementById('itemType')?.value?.trim();

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
  if (!company || !borderSerial || !certificateNumber || !totalQuantity || !itemType) {
    alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
    return null;
  }

  if (parseFloat(totalQuantity) <= 0) {
    alert('Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±');
    return null;
  }

  return {
    company,
    borderSerial,
    certificateNumber,
    certificateDate: certificateDate || new Date().toISOString().split('T')[0],
    totalQuantity: parseFloat(totalQuantity),
    deductedQuantity: parseFloat(deductedQuantity),
    unit: unit || 'Ø·Ù†',
    itemType
  };
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
function getCertificateDataDocuments() {
  // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
  const company = document.getElementById('cert-company')?.value?.trim();
  const borderSerial = document.getElementById('cert-borderSerial')?.value?.trim();
  const certificateNumber = document.getElementById('cert-certificateNumber')?.value?.trim();
  const certificateDate = document.getElementById('cert-certificateDate')?.value;
  const totalQuantity = document.getElementById('cert-totalQuantity')?.value;
  const deductedQuantity = document.getElementById('cert-deductedQuantity')?.value || '0';
  const unit = document.getElementById('cert-unit')?.value?.trim();
  const itemType = document.getElementById('cert-itemType')?.value?.trim();

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
  if (!company || !borderSerial || !certificateNumber || !totalQuantity || !itemType) {
    alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
    return null;
  }

  if (parseFloat(totalQuantity) <= 0) {
    alert('Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±');
    return null;
  }

  return {
    company,
    borderSerial,
    certificateNumber,
    certificateDate: certificateDate || new Date().toISOString().split('T')[0],
    totalQuantity: parseFloat(totalQuantity),
    deductedQuantity: parseFloat(deductedQuantity),
    unit: unit || 'Ø·Ù†',
    itemType
  };
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª
function clearForm() {
  const fields = ['company', 'borderSerial', 'certificateNumber', 'certificateDate', 
                  'totalQuantity', 'deductedQuantity', 'itemType'];
  
  fields.forEach(field => {
    const element = document.getElementById(field);
    if (element) {
      element.value = '';
    }
  });
  
  const unitElement = document.getElementById('unit');
  if (unitElement) {
    unitElement.value = 'Ø·Ù†';
  }
  
  // Ø¥Ø²Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  window.editingExemptionId = null;
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
  updateRemaining();
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
function clearCertForm() {
  const fields = ['cert-company', 'cert-borderSerial', 'cert-certificateNumber', 
                  'cert-certificateDate', 'cert-totalQuantity', 'cert-deductedQuantity', 
                  'cert-itemType'];
  
  fields.forEach(field => {
    const element = document.getElementById(field);
    if (element) {
      element.value = '';
    }
  });
  
  const unitElement = document.getElementById('cert-unit');
  if (unitElement) {
    unitElement.value = 'Ø·Ù†';
  }
  
  // Ø¥Ø²Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  window.editingCertificateId = null;
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
  updateRemainingCert();
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
function showSuccessMessage(message) {
  // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
  const alertDiv = document.createElement('div');
  alertDiv.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    color: #155724;
    padding: 15px 20px;
    border-radius: 8px;
    border: 2px solid #28a745;
    font-size: 16px;
    font-weight: bold;
    z-index: 10000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  `;
  alertDiv.textContent = message;
  
  document.body.appendChild(alertDiv);
  
  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
  setTimeout(() => {
    if (alertDiv.parentNode) {
      alertDiv.parentNode.removeChild(alertDiv);
    }
  }, 3000);
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
function showErrorMessage(message) {
  // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
  const alertDiv = document.createElement('div');
  alertDiv.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #f8d7da, #f1b0b7);
    color: #721c24;
    padding: 15px 20px;
    border-radius: 8px;
    border: 2px solid #dc3545;
    font-size: 16px;
    font-weight: bold;
    z-index: 10000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  `;
  alertDiv.textContent = message;
  
  document.body.appendChild(alertDiv);
  
  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†
  setTimeout(() => {
    if (alertDiv.parentNode) {
      alertDiv.parentNode.removeChild(alertDiv);
    }
  }, 5000);
}

// Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹ÙØ§Ø¡ (Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„)
async function saveCertificate() {
  const certificateData = getCertificateData();
  
  if (!certificateData) {
    return; // Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  }

  try {
    let response, method, url;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ID Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
    if (window.editingExemptionId) {
      // ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹ÙØ§Ø¡ Ù…ÙˆØ¬ÙˆØ¯
      method = 'PUT';
      url = `/api/exemptions/${window.editingExemptionId}`;
    } else {
      // Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹ÙØ§Ø¡ Ø¬Ø¯ÙŠØ¯
      method = 'POST';
      url = '/api/exemptions';
    }
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ API
    response = await fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(certificateData)
    });

    const result = await response.json();

    if (result.success) {
      // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
      const message = window.editingExemptionId ? 
        'âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¹ÙØ§Ø¡ Ø¨Ù†Ø¬Ø§Ø­' : 
        'âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹ÙØ§Ø¡ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
      showSuccessMessage(message);
      
      // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      clearForm();
      window.editingExemptionId = null;
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      await loadAndDisplayData();
      updateStats();
    } else {
      throw new Error(result.message || 'Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }
  } catch (error) {
    console.error('Error saving exemption:', error);
    showErrorMessage('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹ÙØ§Ø¡: ' + error.message);
  }
}

// Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© (Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„)
async function saveCertDocument() {
  const certificateData = getCertificateDataDocuments();
  
  if (!certificateData) {
    return; // Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  }

  try {
    let response, method, url;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ID Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
    if (window.editingCertificateId) {
      // ØªØ¹Ø¯ÙŠÙ„ Ø´Ù‡Ø§Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
      method = 'PUT';
      url = `/api/certificates/${window.editingCertificateId}`;
    } else {
      // Ø¥Ø¶Ø§ÙØ© Ø´Ù‡Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©
      method = 'POST';
      url = '/api/certificates';
    }
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ API
    response = await fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(certificateData)
    });

    const result = await response.json();

    if (result.success) {
      // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
      const message = window.editingCertificateId ? 
        'âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­' : 
        'âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
      showSuccessMessage(message);
      
      // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      clearCertForm();
      window.editingCertificateId = null;
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      await loadAndDisplayCertificates();
      updateStats();
    } else {
      throw new Error(result.message || 'Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }
  } catch (error) {
    console.error('Error saving certificate:', error);
    showErrorMessage('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©: ' + error.message);
  }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function getExemptions() {
  try {
    const response = await fetch('/api/exemptions');
    const result = await response.json();
    if (result.success) {
      return result.exemptions;
    }
    console.error('Error fetching exemptions:', result.message);
    return [];
  } catch (error) {
    console.error('Error fetching exemptions:', error);
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… localStorage ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
    const stored = localStorage.getItem('exemptions');
    return stored ? JSON.parse(stored) : [];
  }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function getCertificates() {
  try {
    const response = await fetch('/api/certificates');
    const result = await response.json();
    if (result.success) {
      return result.certificates;
    }
    console.error('Error fetching certificates:', result.message);
    return [];
  } catch (error) {
    console.error('Error fetching certificates:', error);
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… localStorage ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª ÙÙ‚Ø·
    const stored = localStorage.getItem('certificates');
    return stored ? JSON.parse(stored) : [];
  }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„Ù„Ù‡Ø§ØªÙ
// ØªÙ… Ø­Ø°Ù Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹ Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª - Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ±ÙƒØ² ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ø­Ø« Ù„Ù„Ù‡Ø§ØªÙ
function displayMobileResult(item, type) {
  const resultDiv = document.getElementById("mobileSearchResult");
  const isExpired = parseFloat(item.remainingQuantity) <= 0;
  const lastUpdate = item.updatedAt || item.savedAt || new Date().toLocaleDateString("en-GB", {year: "numeric", month: "2-digit", day: "2-digit"});
  
  const statusClass = isExpired ? "mobile-status-expired" : "mobile-status-available";
  const statusText = isExpired ? "ğŸ”´ Ù…Ù†ØªÙ‡ÙŠØ©/Ù…Ø³ØªÙ†ÙØ°Ø©" : "ğŸŸ¢ Ù…ØªØ§Ø­Ø©";
  const typeText = type === "exemption" ? "Ø¥Ø¹ÙØ§Ø¡ ÙƒÙ…Ø±ÙƒÙŠ" : "Ø´Ù‡Ø§Ø¯Ø©";
  
  resultDiv.innerHTML = `
    <div class="mobile-result-card">
      <div class="mobile-inquiry-header" style="font-size: 24px; margin-bottom: 20px;">
        ğŸ“‹ ${typeText} Ø±Ù‚Ù…: ${item.certificateNumber}
      </div>
      
      <div class="${statusClass}">
        ${statusText}
      </div>
      
      <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 15px 0;">
        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e9ecef;">
          <span style="font-weight: 800; color: #002147;">Ø§Ù„Ø´Ø±ÙƒØ©:</span>
          <span style="color: #2c3e50;">${item.company}</span>
        </div>
        
        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e9ecef;">
          <span style="font-weight: 800; color: #002147;">Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø­Ø¯ÙˆØ¯ÙŠ:</span>
          <span style="color: #2c3e50;">${item.borderSerial}</span>
        </div>
        
        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e9ecef;">
          <span style="font-weight: 800; color: #002147;">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©:</span>
          <span style="color: #2c3e50;">${item.itemType}</span>
        </div>
        
        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e9ecef;">
          <span style="font-weight: 800; color: #002147;">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©:</span>
          <span style="color: #2c3e50;">${item.totalQuantity} ${item.unit}</span>
        </div>
        
        <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e9ecef;">
          <span style="font-weight: 800; color: #002147;">Ø§Ù„Ù…Ø³ØªÙ‚Ø·Ø¹:</span>
          <span style="color: #dc3545;">${item.deductedQuantity} ${item.unit}</span>
        </div>
        
        <div style="display: flex; justify-content: space-between; padding: 10px 0;">
          <span style="font-weight: 800; color: #002147;">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span>
          <span style="color: ${isExpired ? "#dc3545" : "#28a745"}; font-weight: 900;">
            ${item.remainingQuantity} ${item.unit}
          </span>
        </div>
      </div>
      
      <div style="background: linear-gradient(135deg, #ff6b35, #f7931e); color: #ffffff; padding: 20px; border-radius: 15px; text-align: center; font-size: 20px; font-weight: 800; border: 3px solid #e65100; box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);">
        ğŸ—“ï¸ Ø¢Ø®Ø± Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ ØªÙ… ÙÙŠ: ${item.lastDeductionDate || lastUpdate}
      </div>
      ${item.wasModified ? `<div style="background: linear-gradient(135deg, #dc3545, #c82333); color: #ffffff; padding: 15px; border-radius: 10px; text-align: center; font-size: 16px; font-weight: 700; border: 2px solid #bd2130; box-shadow: 0 3px 10px rgba(220, 53, 69, 0.3); margin: 10px 0;"><strong>âœï¸ ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø¨ØªØ§Ø±ÙŠØ®:</strong> ${item.lastModificationDate}</div>` : ''}
      
      <div style="background: linear-gradient(135deg, #28a745, #20c997); color: #ffffff; padding: 18px; border-radius: 12px; text-align: center; font-size: 18px; font-weight: 800; border: 3px solid #1e7e34; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4); margin: 15px 0; animation: pulse 2s infinite;">
        <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
          <span style="font-size: 22px;">âš ï¸</span>
          <strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¨Ø¹Ø¯ Ø¢Ø®Ø± Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ Ø¨ØªØ§Ø±ÙŠØ® ${item.lastDeductionDate || lastUpdate}:</strong>
        </div>
        <div style="font-size: 24px; font-weight: 900; margin-top: 8px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
          ${item.remainingQuantity || (item.totalQuantity - item.deductedQuantity)} ${item.unit}
        </div>
      </div>
      
      <div style="background: linear-gradient(135deg, #dc3545, #c82333, #007bff); color: #ffffff; padding: 25px; border-radius: 15px; text-align: center; border: 4px solid #bd2130; box-shadow: 0 8px 25px rgba(220, 53, 69, 0.6); margin: 20px 0; animation: pulse 2s infinite; position: relative; overflow: hidden;">
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.1) 50%, transparent 60%); animation: shine 3s infinite;"></div>
        <div style="position: relative; z-index: 2;">
          <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px; opacity: 0.9;">
            Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
          </div>
          <div style="font-size: 48px; font-weight: 900; text-shadow: 0 4px 8px rgba(0,0,0,0.5); letter-spacing: 2px; color: #ffff00;">
            ${item.remainingQuantity || (item.totalQuantity - item.deductedQuantity)}
          </div>
          <div style="font-size: 28px; font-weight: 800; margin-top: 5px; color: #ffffff;">
            ${item.unit}
          </div>
        </div>
      </div>
      
      <button onclick="hideMobileResult()" style="width: 100%; margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #6c757d, #5a6268); color: white; border: none; border-radius: 10px; font-size: 20px; font-weight: 700;">
        Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†ØªÙŠØ¬Ø©
      </button>
    </div>
  `;
}

// Ø¯Ø§Ù„Ø© Ø¥Ø®ÙØ§Ø¡ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ø­Ø«
function hideMobileResult() {
  document.getElementById("mobileSearchResult").style.display = "none";
  document.getElementById("mobileSearchInput").value = "";
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
async function updateStats() {
  try {
    const exemptions = await getExemptions();
    const certificates = await getCertificates();
    
    console.log(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª: ${exemptions.length}`);
    console.log(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª: ${certificates.length}`);
    
    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹
    const totalExemptions = exemptions.length;
    const totalCertificates = certificates.length;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    const statsElement = document.getElementById('stats-display');
    if (statsElement) {
      statsElement.innerHTML = `
        Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª: ${totalExemptions} | Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª: ${totalCertificates}
      `;
    }
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', error);
  }
}

// Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function clearAllData() {
  if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!')) {
    try {
      // Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage Ø£ÙˆÙ„Ø§Ù‹
      localStorage.removeItem('exemptions');
      localStorage.removeItem('certificates');
      
      // Ø­Ø°Ù Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const exemptions = await getExemptions();
      for (const exemption of exemptions) {
        await fetch(`/api/exemptions/${exemption.id}`, {
          method: 'DELETE'
        });
      }
      
      // Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const certificates = await getCertificates();
      for (const certificate of certificates) {
        await fetch(`/api/certificates/${certificate.id}`, {
          method: 'DELETE'
        });
      }
      
      alert('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
      updateStats();
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¹Ø±Ø¶
      location.reload();
      
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
    }
  }
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª - Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠ
async function loadAndDisplayData() {
  try {
    const exemptions = await getExemptions();
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    const certificatesList = document.getElementById('certificatesList');
    
    if (certificatesList) {
      if (exemptions.length === 0) {
        certificatesList.innerHTML = `
          <tr>
            <td colspan="11" class="no-data-cell">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹ÙØ§Ø¡Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</td>
          </tr>
        `;
      } else {
        certificatesList.innerHTML = exemptions.map((exemption, index) => {
          const isExpired = parseFloat(exemption.remainingQuantity) <= 0;
          const statusClass = isExpired ? 'expired-row' : 'active-row';
          
          return `
            <tr class="${statusClass}">
              <td>${exemption.company}</td>
              <td>${exemption.certificateNumber}</td>
              <td>${exemption.borderSerial}</td>
              <td>${exemption.certificateDate}</td>
              <td>${exemption.itemType}</td>
              <td>${exemption.totalQuantity}</td>
              <td>${exemption.deductedQuantity}</td>
              <td class="${isExpired ? 'expired-quantity' : 'available-quantity'}">${exemption.remainingQuantity}</td>
              <td>${exemption.unit}</td>
              <td>${exemption.savedAt ? new Date(exemption.savedAt).toLocaleDateString("en-GB", {year: "numeric", month: "2-digit", day: "2-digit"}) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
              <td class="actions-cell">
                <button onclick="editExemption(${exemption.id})" class="table-edit-btn" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
                <button onclick="deleteExemption(${exemption.id})" class="table-delete-btn" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
              </td>
            </tr>
          `;
        }).join('');
      }
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø£ÙŠ Ø¹Ù†Ø§ØµØ± Ø£Ø®Ø±Ù‰ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    const modalBody = document.getElementById('modalBody');
    const displayArea = document.getElementById('dataDisplay');
    
    if (modalBody && !certificatesList) {
      // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŒ Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯
      let html = '';
      if (exemptions.length === 0) {
        html = '<p class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹ÙØ§Ø¡Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</p>';
      } else {
        html = `
          <table class="styled-table">
            <thead>
              <tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</th>
                <th>Ø±Ù‚Ù… ÙƒØªØ§Ø¨ Ø§Ù„Ø§Ø¹ÙØ§Ø¡</th>
                <th>Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø­Ø¯ÙˆØ¯ÙŠ</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©</th>
                <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©</th>
                <th>Ø§Ù„Ù…Ø³ØªÙ‚Ø·Ø¹Ø©</th>
                <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
                <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                <th>ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø­ÙØ¸</th>
                <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</th>
              </tr>
            </thead>
            <tbody>
              ${exemptions.map(exemption => {
                const isExpired = parseFloat(exemption.remainingQuantity) <= 0;
                return `
                  <tr class="${isExpired ? 'expired-row' : 'active-row'}">
                    <td>${exemption.company}</td>
                    <td>${exemption.certificateNumber}</td>
                    <td>${exemption.borderSerial}</td>
                    <td>${exemption.certificateDate}</td>
                    <td>${exemption.itemType}</td>
                    <td>${exemption.totalQuantity}</td>
                    <td>${exemption.deductedQuantity}</td>
                    <td class="${isExpired ? 'expired-quantity' : 'available-quantity'}">${exemption.remainingQuantity}</td>
                    <td>${exemption.unit}</td>
                    <td>${exemption.savedAt ? new Date(exemption.savedAt).toLocaleDateString("en-GB", {year: "numeric", month: "2-digit", day: "2-digit"}) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                    <td>
                      <button onclick="editExemption(${exemption.id})" class="table-edit-btn">âœï¸</button>
                      <button onclick="deleteExemption(${exemption.id})" class="table-delete-btn">ğŸ—‘ï¸</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
      }
      modalBody.innerHTML = html;
    }
    
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶:', error);
  }
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª - Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£ØµÙ„ÙŠ
async function loadAndDisplayCertificates() {
  try {
    const certificates = await getCertificates();
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    const savedCertificatesList = document.getElementById('savedCertificatesList');
    
    if (savedCertificatesList) {
      if (certificates.length === 0) {
        savedCertificatesList.innerHTML = `
          <tr>
            <td colspan="11" class="no-data-cell">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ù‡Ø§Ø¯Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</td>
          </tr>
        `;
      } else {
        savedCertificatesList.innerHTML = certificates.map((certificate, index) => {
          const isExpired = parseFloat(certificate.remainingQuantity) <= 0;
          const statusClass = isExpired ? 'expired-row' : 'active-row';
          
          return `
            <tr class="${statusClass}">
              <td>${certificate.company}</td>
              <td>${certificate.certificateNumber}</td>
              <td>${certificate.borderSerial}</td>
              <td>${certificate.certificateDate}</td>
              <td>${certificate.itemType}</td>
              <td>${certificate.totalQuantity}</td>
              <td>${certificate.deductedQuantity}</td>
              <td class="${isExpired ? 'expired-quantity' : 'available-quantity'}">${certificate.remainingQuantity}</td>
              <td>${certificate.unit}</td>
              <td>${certificate.savedAt ? new Date(certificate.savedAt).toLocaleDateString("en-GB", {year: "numeric", month: "2-digit", day: "2-digit"}) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
              <td class="actions-cell">
                <button onclick="editCertificate(${certificate.id})" class="table-edit-btn" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
                <button onclick="deleteCertificate(${certificate.id})" class="table-delete-btn" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
              </td>
            </tr>
          `;
        }).join('');
      }
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø£ÙŠ Ø¹Ù†Ø§ØµØ± Ø£Ø®Ø±Ù‰ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    const modalBody = document.getElementById('certModalBody');
    const displayArea = document.getElementById('certDataDisplay');
    
    if (modalBody && !savedCertificatesList) {
      // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ØŒ Ø£Ù†Ø´Ø¦ ÙˆØ§Ø­Ø¯
      let html = '';
      if (certificates.length === 0) {
        html = '<p class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ù‡Ø§Ø¯Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</p>';
      } else {
        html = `
          <table class="styled-table">
            <thead>
              <tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</th>
                <th>Ø±Ù‚Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</th>
                <th>Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø­Ø¯ÙˆØ¯ÙŠ</th>
                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©</th>
                <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©</th>
                <th>Ø§Ù„Ù…Ø³ØªÙ‚Ø·Ø¹Ù‡</th>
                <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                <th>ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø­ÙØ¸</th>
                <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</th>
              </tr>
            </thead>
            <tbody>
              ${certificates.map(certificate => {
                const isExpired = parseFloat(certificate.remainingQuantity) <= 0;
                return `
                  <tr class="${isExpired ? 'expired-row' : 'active-row'}">
                    <td>${certificate.company}</td>
                    <td>${certificate.certificateNumber}</td>
                    <td>${certificate.borderSerial}</td>
                    <td>${certificate.certificateDate}</td>
                    <td>${certificate.itemType}</td>
                    <td>${certificate.totalQuantity}</td>
                    <td>${certificate.deductedQuantity}</td>
                    <td class="${isExpired ? 'expired-quantity' : 'available-quantity'}">${certificate.remainingQuantity}</td>
                    <td>${certificate.unit}</td>
                    <td>${certificate.savedAt ? new Date(certificate.savedAt).toLocaleDateString("en-GB", {year: "numeric", month: "2-digit", day: "2-digit"}) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                    <td>
                      <button onclick="editCertificate(${certificate.id})" class="table-edit-btn">âœï¸</button>
                      <button onclick="deleteCertificate(${certificate.id})" class="table-delete-btn">ğŸ—‘ï¸</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
      }
      modalBody.innerHTML = html;
    }
    
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª:', error);
  }
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù Ù„Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª
async function editExemption(id) {
  try {
    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¹ÙØ§Ø¡
    const response = await fetch(`/api/exemptions/${id}`);
    const result = await response.json();
    
    if (result.success) {
      const exemption = result.exemption;
      
      // Ù…Ù„Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      document.getElementById('company').value = exemption.company;
      document.getElementById('borderSerial').value = exemption.borderSerial;
      document.getElementById('certificateNumber').value = exemption.certificateNumber;
      document.getElementById('certificateDate').value = exemption.certificateDate;
      document.getElementById('totalQuantity').value = exemption.totalQuantity;
      document.getElementById('deductedQuantity').value = exemption.deductedQuantity;
      document.getElementById('unit').value = exemption.unit;
      document.getElementById('itemType').value = exemption.itemType;
      
      // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
      updateRemaining();
      
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      closeModal();
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
      showSuccessMessage('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¹ÙØ§Ø¡ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„. Ù‚Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸.');
      
      // Ø­ÙØ¸ ID Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
      window.editingExemptionId = id;
      
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    showErrorMessage('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¹ÙØ§Ø¡: ' + error.message);
  }
}

async function deleteExemption(id) {
  if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹ÙØ§Ø¡ØŸ\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!')) {
    try {
      const response = await fetch(`/api/exemptions/${id}`, {
        method: 'DELETE'
      });
      
      const result = await response.json();
      
      if (result.success) {
        showSuccessMessage('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¹ÙØ§Ø¡ Ø¨Ù†Ø¬Ø§Ø­');
        await loadAndDisplayData();
        updateStats();
      } else {
        throw new Error(result.message);
      }
    } catch (error) {
      showErrorMessage('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¥Ø¹ÙØ§Ø¡: ' + error.message);
    }
  }
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
async function editCertificate(id) {
  try {
    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
    const response = await fetch(`/api/certificates/${id}`);
    const result = await response.json();
    
    if (result.success) {
      const certificate = result.certificate;
      
      // ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„ Ø£Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
      const isMobile = window.innerWidth <= 768;
      
      if (isMobile) {
        // Ù…Ù„Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„
        document.getElementById('certCompany-mobile').value = certificate.company;
        document.getElementById('certBorderSerial-mobile').value = certificate.borderSerial;
        document.getElementById('certCertificateNumber-mobile').value = certificate.certificateNumber;
        document.getElementById('certCertificateDate-mobile').value = certificate.certificateDate;
        document.getElementById('certTotalQuantity-mobile').value = certificate.totalQuantity;
        document.getElementById('certDeductedQuantity-mobile').value = certificate.deductedQuantity;
        document.getElementById('certUnit-mobile').value = certificate.unit;
        document.getElementById('certItemType-mobile').value = certificate.itemType;
        updateCertRemainingMobile();
      } else {
        // Ù…Ù„Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        document.getElementById('certCompany').value = certificate.company;
        document.getElementById('certBorderSerial').value = certificate.borderSerial;
        document.getElementById('certCertificateNumber').value = certificate.certificateNumber;
        document.getElementById('certCertificateDate').value = certificate.certificateDate;
        document.getElementById('certTotalQuantity').value = certificate.totalQuantity;
        document.getElementById('certDeductedQuantity').value = certificate.deductedQuantity;
        document.getElementById('certUnit').value = certificate.unit;
        document.getElementById('certItemType').value = certificate.itemType;
        updateCertRemaining();
      }
      
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      closeSavedCertificatesModal();
      
      // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
      showSuccessMessage('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„. Ù‚Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ø¶ØºØ· Ø­ÙØ¸.');
      
      // Ø­ÙØ¸ ID Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
      window.editingCertificateId = id;
      
    } else {
      throw new Error(result.message);
    }
  } catch (error) {
    showErrorMessage('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©: ' + error.message);
  }
}

async function deleteCertificate(id) {
  if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©ØŸ\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!')) {
    try {
      const response = await fetch(`/api/certificates/${id}`, {
        method: 'DELETE'
      });
      
      const result = await response.json();
      
      if (result.success) {
        showSuccessMessage('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­');
        await loadAndDisplayCertificates();
        updateStats();
      } else {
        throw new Error(result.message);
      }
    } catch (error) {
      showErrorMessage('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©: ' + error.message);
    }
  }
}

// Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù…Ø¹ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function openModal() {
  console.log('ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª...');
  
  try {
    await loadAndDisplayData();
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø£Ø³Ù…Ø§Ø¡ Ù…Ø®ØªÙ„ÙØ©
    let modal = document.getElementById('dataModal');
    if (!modal) {
      modal = document.getElementById('certificatesModal');
    }
    if (!modal) {
      modal = document.getElementById('exemptionsModal');
    }
    
    if (modal) {
      modal.style.display = 'block';
      console.log('ØªÙ… ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­');
    } else {
      console.error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„');
      alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø±Ø¶');
    }
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„:', error);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©: ' + error.message);
  }
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
function closeModal() {
  console.log('Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„...');
  
  const modals = ['dataModal', 'certificatesModal', 'exemptionsModal', 'savedCertificatesModal'];
  
  modals.forEach(modalId => {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.style.display = 'none';
    }
  });
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
function closeSavedCertificatesModal() {
  const modal = document.getElementById('savedCertificatesModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

// Ø¯Ø§Ù„Ø© ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ù…Ø¹ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function openCertModal() {
  await loadAndDisplayCertificates();
  // ÙƒÙˆØ¯ ÙØªØ­ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
  let modal = document.getElementById('savedCertificatesModal');
  if (!modal) {
    modal = document.getElementById('certModal');
  }
  if (modal) {
    modal.style.display = 'block';
  }
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª
function filterExemptions() {
  // Ø³ÙŠØªÙ… ØªÙ†ÙÙŠØ°Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹
  console.log('ÙÙ„ØªØ±Ø© Ø§Ù„Ø¥Ø¹ÙØ§Ø¡Ø§Øª...');
}

function clearExemptionsFilters() {
  // Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±
  document.getElementById('exemptionsCompanyFilter').value = '';
  document.getElementById('exemptionsItemFilter').value = '';
  document.getElementById('exemptionsStatusFilter').value = '';
  document.getElementById('exemptionsDateFrom').value = '';
  document.getElementById('exemptionsDateTo').value = '';
  
  // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  loadAndDisplayData();
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„ÙÙ„ØªØ±Ø© Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
function filterCertificates() {
  // Ø³ÙŠØªÙ… ØªÙ†ÙÙŠØ°Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹
  console.log('ÙÙ„ØªØ±Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª...');
}

function clearCertificatesFilters() {
  // Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙ„Ø§ØªØ±
  document.getElementById('certificatesCompanyFilter').value = '';
  document.getElementById('certificatesItemFilter').value = '';
  document.getElementById('certificatesStatusFilter').value = '';
  document.getElementById('certificatesDateFrom').value = '';
  document.getElementById('certificatesDateTo').value = '';
  
  // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  loadAndDisplayCertificates();
}

// Ø¥Ø¶Ø§ÙØ© Ø¯Ø¹Ù… Enter key Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹
document.addEventListener("DOMContentLoaded", function() {
  const mobileInput = document.getElementById("mobileSearchInput");
  if (mobileInput) {
    mobileInput.addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        mobileQuickSearch();
      }
    });
  }
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  updateStats();
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  loadAndDisplayData();
  loadAndDisplayCertificates();
});

// Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø´Ù‡Ø§Ø¯Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function deleteCertificateFromDB(certId) {
  if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡')) return;
  
  console.log('Deleting certificate from database with ID:', certId);
  
  fetch(`/api/certificates/${certId}`, { method: 'DELETE' })
    .then(response => {
      console.log('Delete response status:', response.status);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const contentType = response.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        throw new Error(`Expected JSON response but got: ${contentType}`);
      }
      
      return response.json();
    })
    .then(data => {
      if (data.success) {
        displaySavedCertificates();
        updateStats();
        showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
      } else {
        showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©: ' + (data.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'), 'error');
      }
    })
    .catch(error => {
      console.error('Error deleting certificate:', error);
      showAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message, 'error');
    });
}
